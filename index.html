<!DOCTYPE html>

<html lang="pt-br">

<head>

Â  Â  <meta charset="UTF-8">

Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">

Â  Â  <title>Controle Financeiro</title>

Â  Â  <script src="https://cdn.tailwindcss.com"></script>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

Â  Â  <style>

Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

Â  Â  Â  Â  body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; color: #374151; }

Â  Â  Â  Â  .container-card { background-color: #ffffff; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }

Â  Â  Â  Â  .interactive-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); cursor: pointer; }

Â  Â  Â  Â  .income-text { color: #16a34a; } .expense-text { color: #dc2626; } .investment-text { color: #2563eb; } .goal-text { color: #f59e0b; }

Â  Â  Â  Â  .income-bg { background-color: #f0fdf4; border-left: 4px solid #16a34a; } .expense-bg { background-color: #fef2f2; border-left: 4px solid #dc2626; } .investment-bg { background-color: #eff6ff; border-left: 4px solid #2563eb; }

Â  Â  Â  Â  input, select, textarea { background-color: #f3f4f6; color: #1f2937; border: 1px solid #d1d5db; font-size: 0.875rem; }

Â  Â  Â  Â  input:focus, select:focus, textarea:focus { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); outline: none; }

Â  Â  Â  Â  .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }

Â  Â  Â  Â  .modal-content { background-color: #ffffff; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); max-width: 90%; max-height: 90vh; overflow-y: auto; }

Â  Â  Â  Â  .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

Â  Â  Â  Â  .alert-message { padding: 0.75rem 1rem; margin-top: 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; text-align: center; }

Â  Â  Â  Â  .alert-success { background-color: #d1fae5; color: #065f46; } .alert-error { background-color: #fee2e2; color: #991b1b; }

Â  Â  Â  Â  .progress-bar { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; }

Â  Â  Â  Â  .progress { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }

Â  Â  Â  Â  .tab-btn.active { border-color: #4f46e5; color: #4f46e5; font-weight: 600; }

Â  Â  Â  Â  .order-btn:disabled { opacity: 0.2; cursor: not-allowed; }

Â  Â  </style>

</head>

<body class="p-4 md:p-8">



Â  Â  <div id="app" class="w-full max-w-7xl mx-auto space-y-6">

Â  Â  Â  Â  <!-- Header -->

Â  Â  Â  Â  <header class="flex justify-between items-center mb-4">

Â  Â  Â  Â  Â  Â  <div>

Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Dashboard Financeiro</h1>

Â  Â  Â  Â  Â  Â  Â  Â  <p id="user-id" class="text-xs text-gray-500 mt-1 break-all"></p>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">

Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="forecast-btn" class="p-2 rounded-full hover:bg-gray-200" title="PrevisÃ£o Financeira"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="reports-btn" class="p-2 rounded-full hover:bg-gray-200" title="Ver RelatÃ³rios"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200" title="ConfiguraÃ§Ãµes"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="absolute top-4 left-4 text-xs font-semibold text-gray-400"><span id="app-version">v0.2.8</span></div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </header>



Â  Â  Â  Â  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

Â  Â  Â  Â  Â  Â  <!-- Coluna da Esquerda: Resumos e AÃ§Ãµes -->

Â  Â  Â  Â  Â  Â  <div class="lg:col-span-1 space-y-6">

Â  Â  Â  Â  Â  Â  Â  Â  <div id="balance-card" class="container-card interactive-card">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><p class="text-sm text-gray-500">Saldo DisponÃ­vel</p><p id="total-balance" class="text-4xl font-bold mt-1 text-gray-900">***</p></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="toggle-main-balances-btn" class="p-2 rounded-full hover:bg-gray-200" title="Mostrar/Ocultar Saldo">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Eye Icon SVG will be injected here -->

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-4">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="investment-card" class="container-card interactive-card text-center"><p class="text-sm text-gray-500">Total Investido</p><p id="total-investment" class="text-xl font-bold mt-1 investment-text">***</p></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="credit-card-card" class="container-card interactive-card text-center"><p class="text-sm text-gray-500">Fatura Atual</p><p id="total-credit-card" class="text-xl font-bold mt-1 expense-text">***</p></div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- FormulÃ¡rio de TransaÃ§Ã£o -->

Â  Â  Â  Â  Â  Â  Â  Â  <div class="container-card">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-gray-900 mb-4">Nova TransaÃ§Ã£o</h2>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="transaction-form" class="space-y-3">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="transaction-id">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label class="block text-xs font-medium text-gray-700">Tipo</label><div id="type-selector" class="flex space-x-2 mt-1"><div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="income">Entrada</div><div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="expense">SaÃ­da</div><div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="investment">Invest.</div></div><input type="hidden" id="type" required></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-3"><div><label for="value" class="block text-xs font-medium text-gray-700">Valor</label><input type="number" id="value" required class="mt-1 block w-full rounded-lg p-2 shadow-sm" placeholder="0,00" step="0.01"></div><div><label for="date" class="block text-xs font-medium text-gray-700">Data</label><input type="date" id="date" required class="mt-1 block w-full rounded-lg p-2 shadow-sm"></div></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label for="category" class="block text-xs font-medium text-gray-700">Categoria</label><select id="category" required class="mt-1 block w-full rounded-lg p-2 shadow-sm"></select></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="expense-fields" class="space-y-3 hidden"><div class="grid grid-cols-2 gap-3"><div><label for="payment-method" class="block text-xs font-medium text-gray-700">Pagamento</label><select id="payment-method" class="mt-1 block w-full rounded-lg p-2 shadow-sm"><option value="Dinheiro">Dinheiro</option><option value="Pix">Pix</option><option value="CartÃ£o de CrÃ©dito">CartÃ£o de CrÃ©dito</option><option value="CartÃ£o de DÃ©bito">CartÃ£o de DÃ©bito</option></select></div><div id="installments-field" class="hidden"><label for="installments" class="block text-xs font-medium text-gray-700">Parcelas</label><select id="installments" class="mt-1 block w-full rounded-lg p-2 shadow-sm"></select></div></div></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label for="description" class="block text-xs font-medium text-gray-700">DescriÃ§Ã£o</label><textarea id="description" rows="2" class="mt-1 block w-full rounded-lg p-2 shadow-sm" placeholder="Ex: SalÃ¡rio, Jantar com amigos"></textarea></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="transaction-alert-message" class="alert-message hidden"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2"><button type="button" id="cancel-edit-btn" class="w-1/3 py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 hidden">Cancelar</button><button type="submit" id="submit-btn" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar</button></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â <!-- LanÃ§amentos Pendentes -->

Â  Â  Â  Â  Â  Â  Â  Â  <div id="pending-transactions-card" class="container-card hidden">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-gray-900 mb-4">LanÃ§amentos Pendentes</h2>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="pending-transactions-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Gerado via JS -->

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>



Â  Â  Â  Â  Â  Â  <!-- Coluna da Direita: HistÃ³rico e VisÃ£o Geral -->

Â  Â  Â  Â  Â  Â  <div class="lg:col-span-2 space-y-6">

Â  Â  Â  Â  Â  Â  Â  Â  <!-- Dashboard do MÃªs (VisÃ£o Geral) -->

Â  Â  Â  Â  Â  Â  Â  Â  <div class="container-card">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2 mb-1">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-gray-900">VisÃ£o Geral do MÃªs</h2>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="toggle-overview-balances-btn" class="p-2 rounded-full hover:bg-gray-200" title="Mostrar/Ocultar Saldos do MÃªs"></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-row items-center space-x-2">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="prev-overview-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="current-overview-month-display" class="text-sm font-medium text-gray-700 w-32 text-center"></span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="next-overview-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end space-x-4 text-sm font-semibold mt-4 sm:mt-0">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="income-summary-card" class="text-center interactive-card p-2 rounded-lg"><p class="text-sm text-gray-500">Entradas</p><p id="total-income" class="text-lg font-bold income-text">R$ 0,00</p></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="expense-summary-card" class="text-center interactive-card p-2 rounded-lg"><p class="text-sm text-gray-500">SaÃ­das</p><p id="total-expense" class="text-lg font-bold expense-text">R$ 0,00</p></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="monthly-balance-card" class="text-center interactive-card p-2 rounded-lg"><p class="text-sm text-gray-500">Saldo do MÃªs</p><p id="monthly-balance" class="text-lg font-bold text-gray-800">R$ 0,00</p></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><h3 class="text-md font-bold text-gray-800 mb-2">Gastos por Categoria</h3><div class="relative h-64"><canvas id="expense-chart"></canvas></div></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-md font-bold text-gray-800 mb-2">Metas de Economia</h3>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="goals-list" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>



Â  Â  Â  Â  Â  Â  Â  Â  <!-- HistÃ³rico de TransaÃ§Ãµes -->

Â  Â  Â  Â  Â  Â  Â  Â  <div class="container-card">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-gray-900">HistÃ³rico de TransaÃ§Ãµes</h2>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-4"><button id="manage-recurring-btn" class="text-indigo-600 text-sm font-semibold hover:text-indigo-800">Recorrentes</button><button id="export-btn" class="text-green-600 text-sm font-semibold hover:text-green-800">Exportar</button></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <!-- Filtros e Soma -->

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row gap-4 items-center mb-2 p-2 bg-gray-50 rounded-lg">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-row items-center space-x-2 flex-grow">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="prev-history-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="current-history-month-display" class="text-sm font-medium text-gray-700 w-32 text-center"></span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="next-history-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="category-filter" class="flex-grow rounded-lg p-2 text-sm bg-white border border-gray-300"></select>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end items-center mb-4 pr-2">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-semibold text-gray-600 mr-2">Total Filtrado:</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="filtered-sum" class="text-lg font-bold text-gray-800">R$ 0,00</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="transaction-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  </div>



Â  Â  <!-- MODAIS -->

Â  Â  <div id="settings-modal" class="modal hidden"></div>

Â  Â  <div id="recurring-modal" class="modal hidden"></div>

Â  Â  <div id="reports-modal" class="modal hidden"></div>

Â  Â  <div id="details-modal" class="modal hidden"></div>

Â  Â  <div id="forecast-modal" class="modal hidden"></div>

Â  Â  <div id="purchase-modal" class="modal hidden"></div>





Â  Â  <script type="module">

Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

Â  Â  Â  Â  import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

Â  Â  Â  Â  import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, getDoc, doc, setDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";



Â  Â  Â  Â  let db, auth, userId;

Â  Â  Â  Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

Â  Â  Â  Â  let expenseChart, reportsChart;



Â  Â  Â  Â  const state = {

Â  Â  Â  Â  Â  Â  transactions: [],

Â  Â  Â  Â  Â  Â  recurringTemplates: [],

Â  Â  Â  Â  Â  Â  pendingTransactions: [],

Â  Â  Â  Â  Â  Â  goals: [],

Â  Â  Â  Â  Â  Â  wishlist: [],

Â  Â  Â  Â  Â  Â  categories: { income: ['SalÃ¡rio'], expense: ['AlimentaÃ§Ã£o'], investment: ['AÃ§Ãµes'] },

Â  Â  Â  Â  Â  Â  settings: { faturaDay: 20, budgets: {} },

Â  Â  Â  Â  Â  Â  overviewSelectedDate: new Date(),

Â  Â  Â  Â  Â  Â  historySelectedDate: new Date(),

Â  Â  Â  Â  Â  Â  creditCardCycleDate: new Date(),

Â  Â  Â  Â  Â  Â  isMainBalanceHidden: true,

Â  Â  Â  Â  Â  Â  isOverviewBalanceHidden: true,

Â  Â  Â  Â  Â  Â  isEditing: false,

Â  Â  Â  Â  Â  Â  filters: { category: 'all' }

Â  Â  Â  Â  };



Â  Â  Â  Â  const elements = {

Â  Â  Â  Â  Â  Â  totalBalance: document.getElementById('total-balance'),

Â  Â  Â  Â  Â  Â  totalInvestment: document.getElementById('total-investment'),

Â  Â  Â  Â  Â  Â  totalCreditCard: document.getElementById('total-credit-card'),

Â  Â  Â  Â  Â  Â  monthlyBalance: document.getElementById('monthly-balance'),

Â  Â  Â  Â  Â  Â  totalIncome: document.getElementById('total-income'),

Â  Â  Â  Â  Â  Â  totalExpense: document.getElementById('total-expense'),

Â  Â  Â  Â  Â  Â  balanceCard: document.getElementById('balance-card'),

Â  Â  Â  Â  Â  Â  investmentCard: document.getElementById('investment-card'),

Â  Â  Â  Â  Â  Â  creditCardCard: document.getElementById('credit-card-card'),

Â  Â  Â  Â  Â  Â  incomeSummaryCard: document.getElementById('income-summary-card'),

Â  Â  Â  Â  Â  Â  expenseSummaryCard: document.getElementById('expense-summary-card'),

Â  Â  Â  Â  Â  Â  monthlyBalanceCard: document.getElementById('monthly-balance-card'),

Â  Â  Â  Â  Â  Â  transactionForm: document.getElementById('transaction-form'),

Â  Â  Â  Â  Â  Â  transactionIdInput: document.getElementById('transaction-id'),

Â  Â  Â  Â  Â  Â  typeSelector: document.getElementById('type-selector'),

Â  Â  Â  Â  Â  Â  hiddenTypeInput: document.getElementById('type'),

Â  Â  Â  Â  Â  Â  categorySelect: document.getElementById('category'),

Â  Â  Â  Â  Â  Â  valueInput: document.getElementById('value'),

Â  Â  Â  Â  Â  Â  dateInput: document.getElementById('date'),

Â  Â  Â  Â  Â  Â  descriptionInput: document.getElementById('description'),

Â  Â  Â  Â  Â  Â  expenseFields: document.getElementById('expense-fields'),

Â  Â  Â  Â  Â  Â  paymentMethodSelect: document.getElementById('payment-method'),

Â  Â  Â  Â  Â  Â  installmentsField: document.getElementById('installments-field'),

Â  Â  Â  Â  Â  Â  installmentsSelect: document.getElementById('installments'),

Â  Â  Â  Â  Â  Â  submitBtn: document.getElementById('submit-btn'),

Â  Â  Â  Â  Â  Â  cancelEditBtn: document.getElementById('cancel-edit-btn'),

Â  Â  Â  Â  Â  Â  transactionAlertMessage: document.getElementById('transaction-alert-message'),

Â  Â  Â  Â  Â  Â  transactionListEl: document.getElementById('transaction-list'),

Â  Â  Â  Â  Â  Â  prevOverviewMonthBtn: document.getElementById('prev-overview-month-btn'),

Â  Â  Â  Â  Â  Â  nextOverviewMonthBtn: document.getElementById('next-overview-month-btn'),

Â  Â  Â  Â  Â  Â  currentOverviewMonthDisplay: document.getElementById('current-overview-month-display'),

Â  Â  Â  Â  Â  Â  prevHistoryMonthBtn: document.getElementById('prev-history-month-btn'),

Â  Â  Â  Â  Â  Â  nextHistoryMonthBtn: document.getElementById('next-history-month-btn'),

Â  Â  Â  Â  Â  Â  currentHistoryMonthDisplay: document.getElementById('current-history-month-display'),

Â  Â  Â  Â  Â  Â  expenseChartCanvas: document.getElementById('expense-chart'),

Â  Â  Â  Â  Â  Â  goalsList: document.getElementById('goals-list'),

Â  Â  Â  Â  Â  Â  toggleMainBalancesBtn: document.getElementById('toggle-main-balances-btn'),

Â  Â  Â  Â  Â  Â  toggleOverviewBalancesBtn: document.getElementById('toggle-overview-balances-btn'),

Â  Â  Â  Â  Â  Â  manageRecurringBtn: document.getElementById('manage-recurring-btn'),

Â  Â  Â  Â  Â  Â  settingsBtn: document.getElementById('settings-btn'),

Â  Â  Â  Â  Â  Â  reportsBtn: document.getElementById('reports-btn'),

Â  Â  Â  Â  Â  Â  forecastBtn: document.getElementById('forecast-btn'),

Â  Â  Â  Â  Â  Â  exportBtn: document.getElementById('export-btn'),

Â  Â  Â  Â  Â  Â  categoryFilter: document.getElementById('category-filter'),

Â  Â  Â  Â  Â  Â  filteredSum: document.getElementById('filtered-sum'),

Â  Â  Â  Â  Â  Â  pendingTransactionsCard: document.getElementById('pending-transactions-card'),

Â  Â  Â  Â  Â  Â  pendingTransactionsList: document.getElementById('pending-transactions-list'),

Â  Â  Â  Â  Â  Â  settingsModal: document.getElementById('settings-modal'),

Â  Â  Â  Â  Â  Â  recurringModal: document.getElementById('recurring-modal'),

Â  Â  Â  Â  Â  Â  reportsModal: document.getElementById('reports-modal'),

Â  Â  Â  Â  Â  Â  detailsModal: document.getElementById('details-modal'),

Â  Â  Â  Â  Â  Â  forecastModal: document.getElementById('forecast-modal'),

Â  Â  Â  Â  Â  Â  purchaseModal: document.getElementById('purchase-modal'),

Â  Â  Â  Â  };



Â  Â  Â  Â  const icons = {

Â  Â  Â  Â  Â  Â  eye: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7S3.732 16.057 2.458 12z" /></svg>`,

Â  Â  Â  Â  Â  Â  eyeSlash: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.11 3.522-5.584 6.643-6.522M6.54 6.54L21 21m-4.56-4.56l-1.39-1.39a3 3 0 00-4.242-4.242L6.54 6.54z" /></svg>`,

Â  Â  Â  Â  }



Â  Â  Â  Â  const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',')}`;

Â  Â  Â  Â  const showAlert = (message, type, element) => { element.textContent = message; element.className = `alert-message alert-${type}`; element.classList.remove('hidden'); setTimeout(() => element.classList.add('hidden'), 3000); };

Â  Â  Â  Â  const generateInstallmentOptions = (selectEl) => { selectEl.innerHTML = ''; for (let i = 1; i <= 24; i++) { const option = document.createElement('option'); option.value = i; option.textContent = `${i}x`; selectEl.appendChild(option); } };

Â  Â  Â  Â  const setCurrentDate = () => { elements.dateInput.value = new Date().toISOString().slice(0, 10); };

Â  Â  Â  Â  const openModal = (modalEl) => modalEl.classList.remove('hidden');

Â  Â  Â  Â  const closeModal = (modalEl) => modalEl.classList.add('hidden');

Â  Â  Â  Â  const renderCategoryDropdown = (selectEl = elements.categorySelect, type = state.selectedType) => { selectEl.innerHTML = ''; const cats = state.categories[type] || []; cats.forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; selectEl.appendChild(opt); }); };



Â  Â  Â  Â  const renderCategoryFilter = () => {

Â  Â  Â  Â  Â  Â  const allCategories = [...(state.categories.income || []), ...(state.categories.expense || []), ...(state.categories.investment || [])];

Â  Â  Â  Â  Â  Â  const uniqueCategories = [...new Set(allCategories)].sort((a,b) => a.localeCompare(b));

Â  Â  Â  Â  Â  Â  elements.categoryFilter.innerHTML = `<option value="all">Todas as Categorias</option>`;

Â  Â  Â  Â  Â  Â  uniqueCategories.forEach(cat => {

Â  Â  Â  Â  Â  Â  Â  Â  elements.categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  };



Â  Â  Â  Â  const initializeFirebaseAndAuthenticate = async () => {

Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

Â  Â  Â  Â  Â  Â  Â  Â  const app = initializeApp(firebaseConfig);

Â  Â  Â  Â  Â  Â  Â  Â  db = getFirestore(app);

Â  Â  Â  Â  Â  Â  Â  Â  auth = getAuth(app);

Â  Â  Â  Â  Â  Â  Â  Â  const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

Â  Â  Â  Â  Â  Â  Â  Â  if (token) await signInWithCustomToken(auth, token); else await signInAnonymously(auth);

Â  Â  Â  Â  Â  Â  Â  Â  userId = auth.currentUser.uid;

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('user-id').textContent = `ID do UsuÃ¡rio: ${userId}`;

Â  Â  Â  Â  Â  Â  Â  Â  await Promise.all([fetchSettings(), fetchCategories()]);

Â  Â  Â  Â  Â  Â  Â  Â  setupListeners();

Â  Â  Â  Â  Â  Â  } catch (error) { console.error("Erro na inicializaÃ§Ã£o:", error); }

Â  Â  Â  Â  };



Â  Â  Â  Â  const setupListeners = () => {

Â  Â  Â  Â  Â  Â  onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/transactions`), s => { state.transactions = s.docs.map(d => ({ id: d.id, ...d.data() })); updateUI(); });

Â  Â  Â  Â  Â  Â  onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/recurring_transactions`), s => {Â 

Â  Â  Â  Â  Â  Â  Â  Â  state.recurringTemplates = s.docs.map(d => ({ id: d.id, ...d.data() }));

Â  Â  Â  Â  Â  Â  Â  Â  generateAndRenderPendingTransactions();

Â  Â  Â  Â  Â  Â  Â  Â  if (!elements.recurringModal.classList.contains('hidden')) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderRecurringTemplatesList();

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/goals`), s => { state.goals = s.docs.map(d => ({ id: d.id, ...d.data() })); renderGoals(); });

Â  Â  Â  Â  Â  Â  onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/wishlist`), s => { state.wishlist = s.docs.map(d => ({ id: d.id, ...d.data() })); });

Â  Â  Â  Â  };



Â  Â  Â  Â  const fetchSettings = async () => { const d = await getDoc(doc(db, `/artifacts/${appId}/users/${userId}/settings`, 'user_settings')); if (d.exists()) Object.assign(state.settings, d.data()); else await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/settings`, 'user_settings'), state.settings); };

Â  Â  Â  Â  const fetchCategories = async () => { const d = await getDoc(doc(db, `/artifacts/${appId}/users/${userId}/categories`, 'user_categories')); if (d.exists()) Object.assign(state.categories, d.data()); else await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/categories`, 'user_categories'), state.categories); renderCategoryDropdown(); renderCategoryFilter(); };

Â  Â  Â  Â Â 

Â  Â  Â  Â  const updateUI = () => { renderTransactions(); updateAllBalances(); renderDashboard(); generateAndRenderPendingTransactions(); };

Â  Â  Â  Â  const renderDashboard = () => {

Â  Â  Â  Â  Â  Â  elements.currentOverviewMonthDisplay.textContent = state.overviewSelectedDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

Â  Â  Â  Â  Â  Â  const mT = state.transactions.filter(t => t.date.startsWith(state.overviewSelectedDate.toISOString().slice(0, 7)));Â 

Â  Â  Â  Â  Â  Â  updateExpenseChart(mT);Â 

Â  Â  Â  Â  Â  Â  renderGoals();Â 

Â  Â  Â  Â  };



Â  Â  Â  Â  const updateExpenseChart = (transactions) => {

Â  Â  Â  Â  Â  Â  const eD = transactions.filter(t => t.type === 'expense').reduce((a, t) => { a[t.category] = (a[t.category] || 0) + t.value; return a; }, {});

Â  Â  Â  Â  Â  Â  const l = Object.keys(eD); const d = Object.values(eD);

Â  Â  Â  Â  Â  Â  const cD = { labels: l.length ? l : ['Sem SaÃ­das'], datasets: [{ data: d.length ? d : [1], backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981'], borderColor: '#fff', borderWidth: 2 }] };

Â  Â  Â  Â  Â  Â  if (expenseChart) { expenseChart.data = cD; expenseChart.update(); }Â 

Â  Â  Â  Â  Â  Â  else if (elements.expenseChartCanvas) { expenseChart = new Chart(elements.expenseChartCanvas, { type: 'doughnut', data: cD, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); }

Â  Â  Â  Â  };



Â  Â  Â  Â  const renderGoals = () => {

Â  Â  Â  Â  Â  Â  elements.goalsList.innerHTML = '';

Â  Â  Â  Â  Â  Â  if (!state.goals.length) { elements.goalsList.innerHTML = '<p class="text-center text-gray-500 text-sm p-4">Crie sua primeira meta nas ConfiguraÃ§Ãµes.</p>'; return; }

Â  Â  Â  Â  Â  Â  const totalInvested = state.transactions.filter(t => t.type === 'investment').reduce((sum, t) => sum + t.value, 0);

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  state.goals.forEach(goal => {

Â  Â  Â  Â  Â  Â  Â  Â  const savedAmount = Math.min(totalInvested, goal.targetValue);

Â  Â  Â  Â  Â  Â  Â  Â  const percentage = goal.targetValue > 0 ? (savedAmount / goal.targetValue) * 100 : 0;

Â  Â  Â  Â  Â  Â  Â  Â  const goalEl = document.createElement('div');

Â  Â  Â  Â  Â  Â  Â  Â  goalEl.innerHTML = `<div class="flex justify-between items-center text-sm mb-1"><span class="font-semibold text-gray-700">${goal.name}</span><span class="text-xs goal-text">${formatCurrency(savedAmount)} / ${formatCurrency(goal.targetValue)}</span></div><div class="progress-bar"><div class="progress bg-amber-500" style="width: ${percentage}%;"></div></div>`;

Â  Â  Â  Â  Â  Â  Â  Â  elements.goalsList.appendChild(goalEl);

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  };



Â  Â  Â  Â  const getFilteredTransactions = () => {

Â  Â  Â  Â  Â  Â  Â return state.transactions.filter(t => {

Â  Â  Â  Â  Â  Â  Â  Â  const historyMonthStr = state.historySelectedDate.toISOString().slice(0, 7);

Â  Â  Â  Â  Â  Â  Â  Â  const monthMatch = t.date.startsWith(historyMonthStr);

Â  Â  Â  Â  Â  Â  Â  Â  const categoryMatch = state.filters.category === 'all' || t.category === state.filters.category;

Â  Â  Â  Â  Â  Â  Â  Â  return monthMatch && categoryMatch;

Â  Â  Â  Â  Â  Â  }).sort((a, b) => new Date(b.date) - new Date(a.date));

Â  Â  Â  Â  }



Â  Â  Â  Â  const renderTransactions = () => {

Â  Â  Â  Â  Â  Â  elements.currentHistoryMonthDisplay.textContent = state.historySelectedDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

Â  Â  Â  Â  Â  Â  const filtered = getFilteredTransactions();



Â  Â  Â  Â  Â  Â  const filteredTotal = filtered.reduce((sum, t) => {

Â  Â  Â  Â  Â  Â  Â  Â  if (t.type === 'income') return sum + t.value;

Â  Â  Â  Â  Â  Â  Â  Â  if (t.type === 'expense' || t.type === 'investment') return sum - t.value;

Â  Â  Â  Â  Â  Â  Â  Â  return sum;

Â  Â  Â  Â  Â  Â  }, 0);

Â  Â  Â  Â  Â  Â  elements.filteredSum.textContent = formatCurrency(filteredTotal);

Â  Â  Â  Â  Â  Â  elements.filteredSum.classList.toggle('income-text', filteredTotal >= 0);

Â  Â  Â  Â  Â  Â  elements.filteredSum.classList.toggle('expense-text', filteredTotal < 0);





Â  Â  Â  Â  Â  Â  elements.transactionListEl.innerHTML = '';

Â  Â  Â  Â  Â  Â  if (!filtered.length) { elements.transactionListEl.innerHTML = '<p class="text-center text-gray-500 text-sm py-8">Nenhuma transaÃ§Ã£o encontrada.</p>'; return; }

Â  Â  Â  Â  Â  Â  filtered.forEach(t => {

Â  Â  Â  Â  Â  Â  Â  Â  const vC = t.type === 'income' ? 'income-text' : t.type === 'expense' ? 'expense-text' : 'investment-text';

Â  Â  Â  Â  Â  Â  Â  Â  const bC = t.type === 'income' ? 'income-bg' : t.type === 'expense' ? 'expense-bg' : 'investment-bg';

Â  Â  Â  Â  Â  Â  Â  Â  const i = t.type === 'income' ? 'â†‘' : t.type === 'expense' ? 'â†“' : 'ðŸ“ˆ';

Â  Â  Â  Â  Â  Â  Â  Â  const fV = (t.type !== 'income' ? `- ` : `+ `) + formatCurrency(t.value);

Â  Â  Â  Â  Â  Â  Â  Â  const tE = document.createElement('div');

Â  Â  Â  Â  Â  Â  Â  Â  tE.className = `flex justify-between items-center p-3 rounded-lg ${bC} group`; tE.dataset.id = t.id;

Â  Â  Â  Â  Â  Â  Â  Â  tE.innerHTML = `<div class="flex items-center space-x-3 flex-1"><span class="text-xl ${vC}">${i}</span><div><p class="font-semibold text-gray-900 text-sm">${t.description||'N/A'}</p><p class="text-xs text-gray-500">${t.category||'N/A'} - ${new Date(t.date+'T12:00:00').toLocaleDateString('pt-BR')}</p></div></div><div class="flex items-center space-x-2"><div class="text-sm font-bold ${vC} mr-2">${fV}</div><div class="flex opacity-0 group-hover:opacity-100 transition-opacity"><button class="edit-btn p-1 rounded-full hover:bg-gray-300" data-id="${t.id}"><svg class="h-4 w-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button><button class="delete-btn p-1 rounded-full hover:bg-gray-300" data-id="${t.id}"><svg class="h-4 w-4 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div></div>`;

Â  Â  Â  Â  Â  Â  Â  Â  elements.transactionListEl.appendChild(tE);

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  };

Â  Â  Â  Â Â 

Â  Â  Â  Â  const updateAllBalances = () => {

Â  Â  Â  Â  Â  Â  let tI=0, tE=0, tInv=0, tCC=0; const today=new Date(); const cD=state.settings.faturaDay; const sD=new Date(today.getFullYear(),today.getMonth()-(today.getDate()>cD?0:1),cD+1); const eD=new Date(today.getFullYear(),today.getMonth()+(today.getDate()>cD?1:0),cD);

Â  Â  Â  Â  Â  Â  state.transactions.forEach(t=>{const tD=new Date(t.date+'T12:00:00'); if(t.type==='income')tI+=t.value;else if(t.type==='expense'){tE+=t.value;if(t.paymentMethod==='CartÃ£o de CrÃ©dito'&&tD>=sD&&tD<=eD)tCC+=t.value;}else if(t.type==='investment')tInv+=t.value;});

Â  Â  Â  Â  Â  Â  const tB=tI-tE-tInv;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const overviewMonthStr = state.overviewSelectedDate.toISOString().slice(0, 7);

Â  Â  Â  Â  Â  Â  let mI=0, mE=0, mInv=0;

Â  Â  Â  Â  Â  Â  state.transactions.filter(t=>t.date.startsWith(overviewMonthStr)).forEach(t=>{if(t.type==='income')mI+=t.value;else if(t.type==='expense')mE+=t.value;else if(t.type==='investment')mInv+=t.value;});

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  elements.totalBalance.textContent=state.isMainBalanceHidden?'***':formatCurrency(tB);Â 

Â  Â  Â  Â  Â  Â  elements.totalInvestment.textContent=state.isMainBalanceHidden?'***':formatCurrency(tInv);Â 

Â  Â  Â  Â  Â  Â  elements.totalCreditCard.textContent=state.isMainBalanceHidden?'***':formatCurrency(tCC);

Â  Â  Â  Â  Â  Â  elements.totalIncome.textContent=state.isOverviewBalanceHidden?'***':formatCurrency(mI);Â 

Â  Â  Â  Â  Â  Â  elements.totalExpense.textContent=state.isOverviewBalanceHidden?'***':formatCurrency(mE+mInv);Â 

Â  Â  Â  Â  Â  Â  elements.monthlyBalance.textContent=state.isOverviewBalanceHidden?'***':formatCurrency(mI-mE-mInv);

Â  Â  Â  Â  };

Â  Â  Â  Â Â 

Â  Â  Â  Â  const resetTransactionForm = () => { elements.transactionForm.reset(); elements.transactionIdInput.value=''; state.isEditing=false; elements.submitBtn.textContent='Adicionar'; elements.cancelEditBtn.classList.add('hidden'); elements.submitBtn.classList.remove('w-2/3'); elements.submitBtn.classList.add('w-full'); setCurrentDate(); updateFormColor('expense'); };

Â  Â  Â  Â  const updateFormColor = (type) => { state.selectedType=type; elements.hiddenTypeInput.value=type; document.querySelectorAll('#type-selector > div').forEach(el=>{el.classList.remove('bg-green-500','bg-red-500','bg-blue-500','text-white','font-semibold'); el.classList.add('bg-gray-200','text-gray-800');}); const sE=document.querySelector(`#type-selector [data-type="${type}"]`); sE.classList.add(type==='income'?'bg-green-500':type==='expense'?'bg-red-500':'bg-blue-500','text-white','font-semibold'); elements.expenseFields.classList.toggle('hidden',type!=='expense'); renderCategoryDropdown(); };



Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {

Â  Â  Â  Â  Â  Â  initializeFirebaseAndAuthenticate();Â 

Â  Â  Â  Â  Â  Â  setCurrentDate();Â 

Â  Â  Â  Â  Â  Â  generateInstallmentOptions(elements.installmentsSelect);Â 

Â  Â  Â  Â  Â  Â  updateFormColor('expense');

Â  Â  Â  Â  Â  Â  elements.toggleMainBalancesBtn.innerHTML = icons.eyeSlash;

Â  Â  Â  Â  Â  Â  elements.toggleOverviewBalancesBtn.innerHTML = icons.eyeSlash;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  elements.typeSelector.addEventListener('click', (e) => { const b = e.target.closest('[data-type]'); if (b) updateFormColor(b.dataset.type); });

Â  Â  Â  Â  Â  Â  elements.paymentMethodSelect.addEventListener('change', (e) => { elements.installmentsField.classList.toggle('hidden', e.target.value !== 'CartÃ£o de CrÃ©dito'); });



Â  Â  Â  Â  Â  Â  elements.prevOverviewMonthBtn.addEventListener('click',()=>{state.overviewSelectedDate.setMonth(state.overviewSelectedDate.getMonth()-1);updateUI();});

Â  Â  Â  Â  Â  Â  elements.nextOverviewMonthBtn.addEventListener('click',()=>{state.overviewSelectedDate.setMonth(state.overviewSelectedDate.getMonth()+1);updateUI();});

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  elements.prevHistoryMonthBtn.addEventListener('click',()=>{state.historySelectedDate.setMonth(state.historySelectedDate.getMonth()-1);renderTransactions();});

Â  Â  Â  Â  Â  Â  elements.nextHistoryMonthBtn.addEventListener('click',()=>{state.historySelectedDate.setMonth(state.historySelectedDate.getMonth()+1);renderTransactions();});

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  elements.toggleMainBalancesBtn.addEventListener('click',()=>{

Â  Â  Â  Â  Â  Â  Â  Â  state.isMainBalanceHidden=!state.isMainBalanceHidden;

Â  Â  Â  Â  Â  Â  Â  Â  elements.toggleMainBalancesBtn.innerHTML = state.isMainBalanceHidden ? icons.eyeSlash : icons.eye;

Â  Â  Â  Â  Â  Â  Â  Â  updateAllBalances();

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  elements.toggleOverviewBalancesBtn.addEventListener('click',()=>{

Â  Â  Â  Â  Â  Â  Â  Â  state.isOverviewBalanceHidden=!state.isOverviewBalanceHidden;

Â  Â  Â  Â  Â  Â  Â  Â  elements.toggleOverviewBalancesBtn.innerHTML = state.isOverviewBalanceHidden ? icons.eyeSlash : icons.eye;

Â  Â  Â  Â  Â  Â  Â  Â  updateAllBalances();

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  elements.transactionForm.addEventListener('submit', async(e)=>{e.preventDefault();const id=elements.transactionIdInput.value;try{if(state.isEditing){const tD={type:elements.hiddenTypeInput.value,value:parseFloat(elements.valueInput.value),category:elements.categorySelect.value,date:elements.dateInput.value,description:elements.descriptionInput.value,paymentMethod:state.selectedType==='expense'?elements.paymentMethodSelect.value:null};await updateDoc(doc(db,`/artifacts/${appId}/users/${userId}/transactions`,id),tD);showAlert('TransaÃ§Ã£o atualizada!','success',elements.transactionAlertMessage);}else{const isI=state.selectedType==='expense'&&elements.paymentMethodSelect.value==='CartÃ£o de CrÃ©dito'&&parseInt(elements.installmentsSelect.value)>1;if(isI){const tV=parseFloat(elements.valueInput.value);const inst=parseInt(elements.installmentsSelect.value);const iV=parseFloat((tV/inst).toFixed(2));const oD=elements.descriptionInput.value;const iD=new Date(elements.dateInput.value+'T12:00:00Z');const b=writeBatch(db);for(let i=0;i<inst;i++){const tD=new Date(iD.getFullYear(),iD.getMonth()+i,iD.getDate());const nDR=doc(collection(db,`/artifacts/${appId}/users/${userId}/transactions`));b.set(nDR,{type:'expense',value:iV,category:elements.categorySelect.value,date:tD.toISOString().slice(0,10),description:`${oD} (${i+1}/${inst})`,paymentMethod:'CartÃ£o de CrÃ©dito',installmentInfo:{current:i+1,total:inst},timestamp:serverTimestamp()});}await b.commit();showAlert(`${inst} parcelas adicionadas!`,'success',elements.transactionAlertMessage);}else{const tD={type:elements.hiddenTypeInput.value,value:parseFloat(elements.valueInput.value),category:elements.categorySelect.value,date:elements.dateInput.value,description:elements.descriptionInput.value,paymentMethod:state.selectedType==='expense'?elements.paymentMethodSelect.value:null,timestamp:serverTimestamp()};await addDoc(collection(db,`/artifacts/${appId}/users/${userId}/transactions`),tD);showAlert('TransaÃ§Ã£o adicionada!','success',elements.transactionAlertMessage);}}}catch(err){console.error(err);showAlert('Ocorreu um erro','error',elements.transactionAlertMessage);}finally{resetTransactionForm();}});

Â  Â  Â  Â  Â  Â  elements.transactionListEl.addEventListener('click',async(e)=>{const eB=e.target.closest('.edit-btn');const dB=e.target.closest('.delete-btn');if(!eB&&!dB)return;const id=eB?.dataset.id||dB.dataset.id;if(dB){try{await deleteDoc(doc(db,`/artifacts/${appId}/users/${userId}/transactions`,id));}catch(err){console.error(err);}}else if(eB){const t=state.transactions.find(tr=>tr.id===id);if(!t)return;state.isEditing=true;elements.transactionIdInput.value=t.id;updateFormColor(t.type);elements.valueInput.value=t.value;elements.dateInput.value=t.date;elements.descriptionInput.value=t.description;setTimeout(()=>{elements.categorySelect.value=t.category;if(t.type==='expense'){elements.paymentMethodSelect.value=t.paymentMethod;elements.installmentsField.classList.toggle('hidden',t.paymentMethod!=='CartÃ£o de CrÃ©dito');}},100);elements.submitBtn.textContent='Salvar';elements.cancelEditBtn.classList.remove('hidden');elements.transactionForm.scrollIntoView({behavior:'smooth'});}});



Â  Â  Â  Â  Â  Â  // Filtros

Â  Â  Â  Â  Â  Â  elements.categoryFilter.addEventListener('change', () => { state.filters.category = elements.categoryFilter.value; renderTransactions(); });

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  // Gerenciamento e Modais

Â  Â  Â  Â  Â  Â  elements.reportsBtn.addEventListener('click', () => { renderReportsModal(); openModal(elements.reportsModal); });

Â  Â  Â  Â  Â  Â  elements.settingsBtn.addEventListener('click', () => { renderSettingsModal(); openModal(elements.settingsModal); });

Â  Â  Â  Â  Â  Â  elements.manageRecurringBtn.addEventListener('click', () => { renderRecurringModal(); openModal(elements.recurringModal); });

Â  Â  Â  Â  Â  Â  elements.forecastBtn.addEventListener('click', () => { renderForecastModal(); openModal(elements.forecastModal); });





Â  Â  Â  Â  Â  Â  // Cards Interativos

Â  Â  Â  Â  Â  Â  elements.balanceCard.addEventListener('click', () => openDetailsModal('balance'));

Â  Â  Â  Â  Â  Â  elements.investmentCard.addEventListener('click', () => openDetailsModal('investment'));

Â  Â  Â  Â  Â  Â  elements.creditCardCard.addEventListener('click', () => { state.creditCardCycleDate = new Date(); openDetailsModal('credit-card'); });

Â  Â  Â  Â  Â  Â  elements.incomeSummaryCard.addEventListener('click', () => openDetailsModal('income'));

Â  Â  Â  Â  Â  Â  elements.expenseSummaryCard.addEventListener('click', () => openDetailsModal('expense'));

Â  Â  Â  Â  Â  Â  elements.monthlyBalanceCard.addEventListener('click', () => openDetailsModal('monthly-balance'));



Â  Â  Â  Â  Â  Â  elements.pendingTransactionsList.addEventListener('click', async (e) => {

Â  Â  Â  Â  Â  Â  Â  Â  const confirmBtn = e.target.closest('.confirm-pending-btn');

Â  Â  Â  Â  Â  Â  Â  Â  const postBtn = e.target.closest('.post-variable-btn');



Â  Â  Â  Â  Â  Â  Â  Â  if (confirmBtn) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const id = confirmBtn.dataset.id;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pending = state.pendingTransactions.find(p => p.templateId === id);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pending) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const newTransaction = { ...pending, recurringTemplateId: pending.templateId, timestamp: serverTimestamp() };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delete newTransaction.id;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delete newTransaction.templateId;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delete newTransaction.valueType;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delete newTransaction.referenceValue;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`), newTransaction);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  Â  Â  if (postBtn) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const id = postBtn.dataset.id;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const valueInput = document.getElementById(`pending-value-${id}`);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const value = parseFloat(valueInput.value);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(value) || value <= 0) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Por favor, insira um valor vÃ¡lido.');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pending = state.pendingTransactions.find(p => p.templateId === id);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (pending) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const newTransaction = { ...pending, value, recurringTemplateId: pending.templateId, timestamp: serverTimestamp() };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delete newTransaction.id;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delete newTransaction.templateId;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delete newTransaction.valueType;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â delete newTransaction.referenceValue;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`), newTransaction);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });





Â  Â  Â  Â  Â  Â  // Exportar

Â  Â  Â  Â  Â  Â  elements.exportBtn.addEventListener('click', () => {

Â  Â  Â  Â  Â  Â  Â  Â  const transactionsToExport = getFilteredTransactions();

Â  Â  Â  Â  Â  Â  Â  Â  const header = ["Tipo", "Categoria", "Descricao", "Data", "Valor"].join(";");

Â  Â  Â  Â  Â  Â  Â  Â  const rows = transactionsToExport.map(t => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const type = `"${t.type || ''}"`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const category = `"${t.category || ''}"`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const description = `"${(t.description || '').replace(/"/g, '""')}"`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = `"${t.date || ''}"`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const value = `"${(t.value || 0).toFixed(2).replace('.', ',')}"`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return [type, category, description, date, value].join(";");

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const csvContent = "\uFEFF" + [header, ...rows].join("\r\n");

Â  Â  Â  Â  Â  Â  Â  Â  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

Â  Â  Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);

Â  Â  Â  Â  Â  Â  Â  Â  const link = document.createElement("a");

Â  Â  Â  Â  Â  Â  Â  Â  link.setAttribute("href", url);

Â  Â  Â  Â  Â  Â  Â  Â  link.setAttribute("download", `historico_${state.historySelectedDate.toISOString().slice(0,7)}.csv`);

Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(link);

Â  Â  Â  Â  Â  Â  Â  Â  link.click();

Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(link);

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  });



Â  Â  Â  Â  // MODAL RENDER FUNCTIONS

Â  Â  Â  Â  const openDetailsModal = (type) => {

Â  Â  Â  Â  Â  Â  if (type === 'credit-card') {

Â  Â  Â  Â  Â  Â  Â  Â  renderCreditCardDetailsModal();

Â  Â  Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  let title = '';

Â  Â  Â  Â  Â  Â  let transactions = [];

Â  Â  Â  Â  Â  Â  const overviewMonthStr = state.overviewSelectedDate.toISOString().slice(0, 7);

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  switch(type) {

Â  Â  Â  Â  Â  Â  Â  Â  case 'balance': title = 'Detalhes do Saldo DisponÃ­vel (Total)'; transactions = state.transactions; break;

Â  Â  Â  Â  Â  Â  Â  Â  case 'investment': title = 'Detalhes de Investimentos (Total)'; transactions = state.transactions.filter(t => t.type === 'investment'); break;

Â  Â  Â  Â  Â  Â  Â  Â  case 'income': title = 'Detalhes de Entradas do MÃªs'; transactions = state.transactions.filter(t => t.type === 'income' && t.date.startsWith(overviewMonthStr)); break;

Â  Â  Â  Â  Â  Â  Â  Â  case 'expense': title = 'Detalhes de SaÃ­das do MÃªs'; transactions = state.transactions.filter(t => (t.type === 'expense' || t.type === 'investment') && t.date.startsWith(overviewMonthStr)); break;

Â  Â  Â  Â  Â  Â  Â  Â  case 'monthly-balance': title = 'ComposiÃ§Ã£o do Saldo do MÃªs'; transactions = state.transactions.filter(t => t.date.startsWith(overviewMonthStr)); break;

Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  renderDetailsTableModal(title, transactions);

Â  Â  Â  Â  };



Â  Â  Â  Â  const renderDetailsTableModal = (title, transactions) => {

Â  Â  Â  Â  Â  Â  let currentSort = { key: 'date', direction: 'desc' };



Â  Â  Â  Â  Â  Â  const renderContent = (sortedTransactions) => {

Â  Â  Â  Â  Â  Â  Â  Â  const total = sortedTransactions.reduce((sum, t) => { if (t.type === 'income') return sum + t.value; if (t.type === 'expense' || t.type === 'investment') return sum - t.value; return sum; }, 0);

Â  Â  Â  Â  Â  Â  Â  Â  const contentEl = elements.detailsModal.querySelector('.modal-content');

Â  Â  Â  Â  Â  Â  Â  Â  if (!contentEl) return;



Â  Â  Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">${title}</h3><span class="close-btn" id="close-details-modal-btn">&times;</span></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-2xl font-bold mb-4 ${total >= 0 ? 'income-text' : 'expense-text'}">${formatCurrency(total)}</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-h-96 overflow-y-auto pr-2">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-left text-sm"><thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-2 cursor-pointer" data-sort="description">DescriÃ§Ã£o</th><th class="p-2 cursor-pointer" data-sort="category">Categoria</th>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="p-2 cursor-pointer" data-sort="date">Data</th><th class="p-2 cursor-pointer text-right" data-sort="value">Valor</th>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr></thead>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${sortedTransactions.length ? sortedTransactions.map(t => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const vC = t.type === 'income' ? 'income-text' : t.type === 'expense' ? 'expense-text' : 'investment-text';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fV = (t.type !== 'income' ? `- ` : `+ `) + formatCurrency(t.value);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<tr>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-2 border-b">${t.description || 'N/A'}</td><td class="p-2 border-b">${t.category}</td>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-2 border-b">${new Date(t.date+'T12:00:00').toLocaleDateString('pt-BR')}</td><td class="p-2 border-b text-right font-semibold ${vC}">${fV}</td>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('') : '<tr><td colspan="4" class="text-center p-4">Nenhuma transaÃ§Ã£o.</td></tr>'}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody></table>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('close-details-modal-btn').onclick = () => closeModal(elements.detailsModal);



Â  Â  Â  Â  Â  Â  Â  Â  contentEl.querySelectorAll('thead th').forEach(th => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  th.onclick = () => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sortKey = th.dataset.sort;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentSort.key === sortKey) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSort.key = sortKey;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSort.direction = 'desc';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sorted = [...transactions].sort((a, b) => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const key = currentSort.key;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const direction = currentSort.direction === 'asc' ? 1 : -1;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const valA = a[key] || (key === 'value' ? 0 : '');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const valB = b[key] || (key === 'value' ? 0 : '');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (key === 'value') return (valA - valB) * direction;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return valA.toString().localeCompare(valB.toString()) * direction;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderContent(sorted);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  };



Â  Â  Â  Â  Â  Â  elements.detailsModal.innerHTML = `<div class="modal-content w-full max-w-2xl"></div>`;

Â  Â  Â  Â  Â  Â  const initialSorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

Â  Â  Â  Â  Â  Â  renderContent(initialSorted);

Â  Â  Â  Â  Â  Â  openModal(elements.detailsModal);

Â  Â  Â  Â  }



Â  Â  Â  Â  const renderCreditCardDetailsModal = () => {

Â  Â  Â  Â  Â  Â  const cycleDate = state.creditCardCycleDate;

Â  Â  Â  Â  Â  Â  const faturaDay = state.settings.faturaDay;

Â  Â  Â  Â  Â  Â  const currentDay = cycleDate.getDate();



Â  Â  Â  Â  Â  Â  let startDate, endDate;

Â  Â  Â  Â  Â  Â  if(cycleDate.getDate() > faturaDay) {

Â  Â  Â  Â  Â  Â  Â  Â  startDate = new Date(cycleDate.getFullYear(), cycleDate.getMonth(), faturaDay + 1);

Â  Â  Â  Â  Â  Â  Â  Â  endDate = new Date(cycleDate.getFullYear(), cycleDate.getMonth() + 1, faturaDay);

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  startDate = new Date(cycleDate.getFullYear(), cycleDate.getMonth() - 1, faturaDay + 1);

Â  Â  Â  Â  Â  Â  Â  Â  endDate = new Date(cycleDate.getFullYear(), cycleDate.getMonth(), faturaDay);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const transactions = state.transactions.filter(t => {

Â  Â  Â  Â  Â  Â  Â  Â  const tD = new Date(t.date+'T12:00:00');

Â  Â  Â  Â  Â  Â  Â  Â  return t.paymentMethod === 'CartÃ£o de CrÃ©dito' && tD >= startDate && tD <= endDate;

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  renderDetailsTableModal(

Â  Â  Â  Â  Â  Â  Â  Â  `Detalhes da Fatura`,

Â  Â  Â  Â  Â  Â  Â  Â  transactions

Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const modalContent = elements.detailsModal.querySelector('.modal-content');

Â  Â  Â  Â  Â  Â  const header = modalContent.querySelector('h3');

Â  Â  Â  Â  Â  Â  const nav = document.createElement('div');

Â  Â  Â  Â  Â  Â  nav.className = "flex justify-between items-center p-2 bg-gray-100 rounded-lg mb-4";

Â  Â  Â  Â  Â  Â  nav.innerHTML = `

Â  Â  Â  Â  Â  Â  Â  Â  <button id="prev-invoice-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="text-center">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-semibold">PerÃ­odo da Fatura</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-600">${startDate.toLocaleDateString('pt-BR')} - ${endDate.toLocaleDateString('pt-BR')}</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="next-invoice-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></button>

Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  header.parentElement.insertAdjacentElement('afterend', nav);



Â  Â  Â  Â  Â  Â  document.getElementById('prev-invoice-btn').onclick = () => {

Â  Â  Â  Â  Â  Â  Â  Â  state.creditCardCycleDate.setMonth(state.creditCardCycleDate.getMonth() - 1);

Â  Â  Â  Â  Â  Â  Â  Â  renderCreditCardDetailsModal();

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  document.getElementById('next-invoice-btn').onclick = () => {

Â  Â  Â  Â  Â  Â  Â  Â  state.creditCardCycleDate.setMonth(state.creditCardCycleDate.getMonth() + 1);

Â  Â  Â  Â  Â  Â  Â  Â  renderCreditCardDetailsModal();

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  };





Â  Â  Â  Â  const renderReportsModal = () => {

Â  Â  Â  Â  Â  Â  elements.reportsModal.innerHTML = `<div class="modal-content w-full max-w-3xl"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold">RelatÃ³rio Anual</h3><span class="close-btn" id="close-reports-modal-btn">&times;</span></div><div class="flex items-center gap-2 mb-4"><label>Ano:</label><select id="report-year-select" class="p-2 rounded-lg bg-gray-100"></select></div><div class="relative h-96"><canvas id="reports-chart"></canvas></div></div>`;

Â  Â  Â  Â  Â  Â  document.getElementById('close-reports-modal-btn').onclick = () => closeModal(elements.reportsModal);



Â  Â  Â  Â  Â  Â  const yearSelect = document.getElementById('report-year-select');

Â  Â  Â  Â  Â  Â  const years = [...new Set(state.transactions.map(t => t.date.substring(0,4)))].sort((a,b) => b-a);

Â  Â  Â  Â  Â  Â  if (years.length === 0) years.push(new Date().getFullYear());

Â  Â  Â  Â  Â  Â  yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const renderReportChart = (year) => {

Â  Â  Â  Â  Â  Â  Â  Â  const months = Array.from({length: 12}, (_, i) => `${year}-${String(i+1).padStart(2,'0')}`);

Â  Â  Â  Â  Â  Â  Â  Â  const incomeData = []; const expenseData = [];

Â  Â  Â  Â  Â  Â  Â  Â  months.forEach(m => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let mI=0, mE=0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.transactions.filter(t => t.date.startsWith(m)).forEach(t => { if(t.type === 'income') mI += t.value; else if(t.type === 'expense' || t.type === 'investment') mE += t.value; });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  incomeData.push(mI); expenseData.push(mE);

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const chartData = { labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], datasets: [{ label: 'Entradas', data: incomeData, backgroundColor: 'rgba(22, 163, 74, 0.5)', borderColor: '#16a34a', borderWidth: 1 }, { label: 'SaÃ­das', data: expenseData, backgroundColor: 'rgba(220, 38, 38, 0.5)', borderColor: '#dc2626', borderWidth: 1 }]};

Â  Â  Â  Â  Â  Â  Â  Â  const canvas = document.getElementById('reports-chart');

Â  Â  Â  Â  Â  Â  Â  Â  if(!canvas) return;

Â  Â  Â  Â  Â  Â  Â  Â  if(reportsChart) reportsChart.destroy();

Â  Â  Â  Â  Â  Â  Â  Â  reportsChart = new Chart(canvas, { type: 'bar', data: chartData, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  yearSelect.onchange = () => renderReportChart(yearSelect.value);

Â  Â  Â  Â  Â  Â  renderReportChart(yearSelect.value);

Â  Â  Â  Â  };



Â  Â  Â  Â  const renderSettingsModal = () => {

Â  Â  Â  Â  Â  Â  elements.settingsModal.innerHTML = `<div class="modal-content w-full max-w-lg"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold">ConfiguraÃ§Ãµes</h3><span class="close-btn" id="close-settings-modal-btn">&times;</span></div><div class="space-y-6"><div class="border-b border-gray-200"><div class="flex -mb-px"><button class="tab-btn active py-3 px-4 border-b-2" data-tab="general">Geral</button><button class="tab-btn py-3 px-4 border-b-2 border-transparent" data-tab="categories">Categorias</button><button class="tab-btn py-3 px-4 border-b-2 border-transparent" data-tab="goals">Metas</button></div></div><div id="general-settings" class=""><div><label for="fatura-day" class="block text-sm font-medium text-gray-700">Dia de fechamento da fatura</label><input type="number" id="fatura-day" min="1" max="31" class="mt-1 block w-full rounded-lg p-2"></div></div><div id="categories-settings" class="hidden"></div><div id="goals-settings" class="hidden"></div><div id="settings-alert-message" class="alert-message hidden"></div><button id="save-settings-btn" class="w-full mt-6 py-2 px-4 rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar AlteraÃ§Ãµes</button></div></div>`;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  document.getElementById('close-settings-modal-btn').onclick = () => closeModal(elements.settingsModal);

Â  Â  Â  Â  Â  Â  document.getElementById('fatura-day').value = state.settings.faturaDay;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const tabs = elements.settingsModal.querySelectorAll('.tab-btn');

Â  Â  Â  Â  Â  Â  tabs.forEach(tab => tab.onclick = () => {

Â  Â  Â  Â  Â  Â  Â  Â  tabs.forEach(t => t.classList.remove('active'));

Â  Â  Â  Â  Â  Â  Â  Â  tab.classList.add('active');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('general-settings').classList.toggle('hidden', tab.dataset.tab !== 'general');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('categories-settings').classList.toggle('hidden', tab.dataset.tab !== 'categories');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('goals-settings').classList.toggle('hidden', tab.dataset.tab !== 'goals');

Â  Â  Â  Â  Â  Â  });



Â  Â  Â  Â  Â  Â  const renderCategoryManager = () => {

Â  Â  Â  Â  Â  Â  Â  Â  const container = document.getElementById('categories-settings');

Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = ['income', 'expense', 'investment'].map(type => `

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-semibold capitalize mb-2">${type === 'income' ? 'Entradas' : type === 'expense' ? 'SaÃ­das' : 'Investimentos'}</h4>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="space-y-2 max-h-40 overflow-y-auto pr-2" id="${type}-category-list-settings"></ul>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form class="flex gap-2 mt-2" data-type="${type}">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" placeholder="Nova categoria" required class="flex-1 rounded-lg p-2 text-sm">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm">Add</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  `).join('');



Â  Â  Â  Â  Â  Â  Â  Â  ['income', 'expense', 'investment'].forEach(type => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const listEl = document.getElementById(`${type}-category-list-settings`);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(listEl) listEl.innerHTML = (state.categories[type] || []).map(cat => `<li class="flex items-center justify-between py-1 px-2 bg-gray-100 rounded text-sm"><span>${cat}</span><button class="delete-cat-btn" data-type="${type}" data-cat="${cat}">&times;</button></li>`).join('');

Â  Â  Â  Â  Â  Â  Â  Â  });



Â  Â  Â  Â  Â  Â  Â  Â  container.onclick = e => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.target.classList.contains('delete-cat-btn')) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { type, cat } = e.target.dataset;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.categories[type] = state.categories[type].filter(c => c !== cat);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderCategoryManager();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  container.onsubmit = e => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.target.tagName !== 'FORM') return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { type } = e.target.dataset;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const input = e.target.querySelector('input');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newCat = input.value.trim();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newCat && !(state.categories[type] || []).includes(newCat)) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.categories[type] = [...(state.categories[type] || []), newCat];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.value = '';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderCategoryManager();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  };



Â  Â  Â  Â  Â  Â  const renderGoalManager = () => {

Â  Â  Â  Â  Â  Â  Â  Â  const container = document.getElementById('goals-settings');

Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<div id="goals-modal-list" class="space-y-3 mb-6"></div><form id="goal-form"><h4 class="text-lg font-semibold mb-2">Nova Meta</h4><div class="space-y-2"><input type="text" id="goal-name" placeholder="Nome da Meta (Ex: Viagem)" required class="w-full rounded-lg p-2"><input type="number" id="goal-value" placeholder="Valor Alvo" required class="w-full rounded-lg p-2" step="0.01"></div><button type="submit" class="w-full mt-4 py-2 px-4 rounded-lg text-sm font-medium text-white bg-amber-500 hover:bg-amber-600">Adicionar Meta</button></form>`;

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  const listEl = document.getElementById('goals-modal-list');

Â  Â  Â  Â  Â  Â  Â  Â  listEl.innerHTML = '';

Â  Â  Â  Â  Â  Â  Â  Â  if(!state.goals.length) { listEl.innerHTML = '<p class="text-sm text-center text-gray-500">Nenhuma meta criada.</p>'; }

Â  Â  Â  Â  Â  Â  Â  Â  state.goals.forEach(g => { listEl.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-100 rounded-md"><span>${g.name} - ${formatCurrency(g.targetValue)}</span><button class="delete-goal-btn text-red-500" data-id="${g.id}">&times;</button></div>`; });



Â  Â  Â  Â  Â  Â  Â  Â  listEl.onclick = async e => { if(e.target.classList.contains('delete-goal-btn')) await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/goals`, e.target.dataset.id)); };

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  container.querySelector('#goal-form').onsubmit = async e => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const name = container.querySelector('#goal-name').value;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetValue = parseFloat(container.querySelector('#goal-value').value);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (name && targetValue > 0) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/goals`), { name, targetValue, createdAt: serverTimestamp() });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.target.reset();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  renderCategoryManager();

Â  Â  Â  Â  Â  Â  renderGoalManager();



Â  Â  Â  Â  Â  Â  document.getElementById('save-settings-btn').onclick = async () => {

Â  Â  Â  Â  Â  Â  Â  Â  state.settings.faturaDay = parseInt(document.getElementById('fatura-day').value);

Â  Â  Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await Promise.all([

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setDoc(doc(db, `/artifacts/${appId}/users/${userId}/settings`, 'user_settings'), state.settings),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setDoc(doc(db, `/artifacts/${appId}/users/${userId}/categories`, 'user_categories'), state.categories)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('ConfiguraÃ§Ãµes salvas!', 'success', document.getElementById('settings-alert-message'));

Â  Â  Â  Â  Â  Â  Â  Â  } catch(err) { console.error(err); showAlert('Erro ao salvar', 'error', document.getElementById('settings-alert-message')); }

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  };

Â  Â  Â  Â Â 

Â  Â  Â  Â  const renderRecurringTemplatesList = () => {

Â  Â  Â  Â  Â  Â  const listEl = document.getElementById('recurring-templates-list');

Â  Â  Â  Â  Â  Â  if (!listEl) return;

Â  Â  Â  Â  Â  Â  listEl.innerHTML = '';

Â  Â  Â  Â  Â  Â  if(!state.recurringTemplates.length) {Â 

Â  Â  Â  Â  Â  Â  Â  Â  listEl.innerHTML = '<p class="text-center text-gray-500 text-sm">Nenhuma transaÃ§Ã£o recorrente.</p>';

Â  Â  Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  state.recurringTemplates.forEach(t => {Â 

Â  Â  Â  Â  Â  Â  Â  Â  const valueTypeLabel = t.valueType === 'variable' ? `VariÃ¡vel (Ref: ${formatCurrency(t.referenceValue || 0)})` : formatCurrency(t.value);

Â  Â  Â  Â  Â  Â  Â  Â  const typeClass = t.type === 'income' ? 'income-text' : t.type === 'expense' ? 'expense-text' : 'investment-text';

Â  Â  Â  Â  Â  Â  Â  Â  listEl.innerHTML += `

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center p-2 bg-gray-50 rounded">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold">${t.description}</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500">${t.category} | Dia ${t.day}</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-sm ${typeClass}">${valueTypeLabel}</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="edit-recurring-btn p-1 hover:bg-gray-200 rounded-full" data-id="${t.id}" title="Editar"><svg class="h-4 w-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-recurring-btn text-red-500 p-1 hover:bg-gray-200 rounded-full text-lg font-bold" data-id="${t.id}" title="Excluir">&times;</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;Â 

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  };



Â  Â  Â  Â  const renderRecurringModal = () => {

Â  Â  Â  Â  Â  Â  Â elements.recurringModal.innerHTML = `<div class="modal-content w-full max-w-lg"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">TransaÃ§Ãµes Recorrentes</h3><span class="close-btn" id="close-recurring-modal-btn">&times;</span></div><div id="recurring-templates-list" class="space-y-3 max-h-60 overflow-y-auto pr-2 mb-4"></div><form id="recurring-form" class="space-y-3 mt-4 border-t pt-4"><h4 id="recurring-form-title" class="text-lg font-semibold">Adicionar Nova</h4><input type="hidden" id="recurring-template-id"><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-medium">Tipo</label><select id="recurring-type-input" required class="mt-1 w-full rounded-lg p-2"><option value="income">Entrada</option><option value="expense">SaÃ­da</option><option value="investment">Investimento</option></select></div><div><label class="block text-xs font-medium">Categoria</label><select id="recurring-category" required class="mt-1 w-full rounded-lg p-2"></select></div></div><div class="grid grid-cols-2 gap-4 items-end"><div><label class="block text-xs font-medium">Tipo de Valor</label><div class="flex gap-4 mt-2"><label class="flex items-center text-sm"><input type="radio" name="recurring-value-type" value="fixed" checked class="mr-1"> Fixo</label><label class="flex items-center text-sm"><input type="radio" name="recurring-value-type" value="variable" class="mr-1"> VariÃ¡vel</label></div></div><div id="recurring-value-container"><label class="block text-xs font-medium" id="recurring-value-label">Valor</label><input type="number" id="recurring-value" class="mt-1 w-full rounded-lg p-2" placeholder="0,00" step="0.01"></div></div><div><label class="block text-xs font-medium">Dia do LanÃ§amento</label><input type="number" id="recurring-day" required class="mt-1 w-full rounded-lg p-2" min="1" max="31"></div><div><label class="block text-xs font-medium">DescriÃ§Ã£o</label><textarea id="recurring-description" rows="2" class="mt-1 w-full rounded-lg p-2"></textarea></div><div id="recurring-alert-message" class="alert-message hidden"></div><div class="flex gap-2"><button type="button" id="cancel-edit-recurring-btn" class="w-1/3 py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 hidden">Cancelar</button><button type="submit" id="recurring-submit-btn" class="w-full py-2 px-4 rounded-lg text-sm font-medium text-white bg-green-500 hover:bg-green-600">Salvar Recorrente</button></div></form></div>`;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const form = document.getElementById('recurring-form');

Â  Â  Â  Â  Â  Â  const formTitle = document.getElementById('recurring-form-title');

Â  Â  Â  Â  Â  Â  const templateIdInput = document.getElementById('recurring-template-id');

Â  Â  Â  Â  Â  Â  const submitBtn = document.getElementById('recurring-submit-btn');

Â  Â  Â  Â  Â  Â  const cancelBtn = document.getElementById('cancel-edit-recurring-btn');

Â  Â  Â  Â  Â  Â  const typeSelect = document.getElementById('recurring-type-input');

Â  Â  Â  Â  Â  Â  const categorySelect = document.getElementById('recurring-category');

Â  Â  Â  Â  Â  Â  const valueContainer = document.getElementById('recurring-value-container');

Â  Â  Â  Â  Â  Â  const valueLabel = document.getElementById('recurring-value-label');

Â  Â  Â  Â  Â  Â  const valueInput = document.getElementById('recurring-value');

Â  Â  Â  Â  Â  Â  const dayInput = document.getElementById('recurring-day');

Â  Â  Â  Â  Â  Â  const descriptionInput = document.getElementById('recurring-description');

Â  Â  Â  Â  Â  Â  const radios = document.querySelectorAll('input[name="recurring-value-type"]');

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const resetRecurringForm = () => {

Â  Â  Â  Â  Â  Â  Â  Â  form.reset();

Â  Â  Â  Â  Â  Â  Â  Â  templateIdInput.value = '';

Â  Â  Â  Â  Â  Â  Â  Â  formTitle.textContent = 'Adicionar Nova';

Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.textContent = 'Salvar Recorrente';

Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.classList.remove('w-2/3');

Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.classList.add('w-full');

Â  Â  Â  Â  Â  Â  Â  Â  cancelBtn.classList.add('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  valueLabel.textContent = 'Valor';

Â  Â  Â  Â  Â  Â  Â  Â  valueInput.required = true;

Â  Â  Â  Â  Â  Â  Â  Â  valueContainer.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  };



Â  Â  Â  Â  Â  Â  document.getElementById('close-recurring-modal-btn').onclick = () => {

Â  Â  Â  Â  Â  Â  Â  Â  resetRecurringForm();

Â  Â  Â  Â  Â  Â  Â  Â  closeModal(elements.recurringModal);

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  cancelBtn.onclick = resetRecurringForm;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  renderRecurringTemplatesList();



Â  Â  Â  Â  Â  Â  document.getElementById('recurring-templates-list').onclick = async e => {Â 

Â  Â  Â  Â  Â  Â  Â  Â  const deleteBtn = e.target.closest('.delete-recurring-btn');

Â  Â  Â  Â  Â  Â  Â  Â  const editBtn = e.target.closest('.edit-recurring-btn');



Â  Â  Â  Â  Â  Â  Â  Â  if (deleteBtn) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/recurring_transactions`, deleteBtn.dataset.id));

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (editBtn) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const id = editBtn.dataset.id;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const template = state.recurringTemplates.find(t => t.id === id);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (template) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  formTitle.textContent = 'Editar Recorrente';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.textContent = 'Atualizar';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  templateIdInput.value = id;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  typeSelect.value = template.type;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderCategoryDropdown(categorySelect, template.type);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => categorySelect.value = template.category, 0);



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  descriptionInput.value = template.description;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayInput.value = template.day;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radios.forEach(radio => { radio.checked = radio.value === template.valueType; });



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (template.valueType === 'variable') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueContainer.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueLabel.textContent = 'Valor de ReferÃªncia (Opcional)';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueInput.required = false;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueInput.value = template.referenceValue || '';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueContainer.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueLabel.textContent = 'Valor';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueInput.required = true;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueInput.value = template.value;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cancelBtn.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.classList.remove('w-full');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.classList.add('w-2/3');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  form.scrollIntoView({ behavior: 'smooth' });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  radios.forEach(radio => {

Â  Â  Â  Â  Â  Â  Â  Â  radio.onchange = (e) => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.target.value === 'variable') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueContainer.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueLabel.textContent = 'Valor de ReferÃªncia (Opcional)';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueInput.required = false;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueContainer.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueLabel.textContent = 'Valor';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueInput.required = true;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  });



Â  Â  Â  Â  Â  Â  typeSelect.onchange = () => renderCategoryDropdown(categorySelect, typeSelect.value);

Â  Â  Â  Â  Â  Â  renderCategoryDropdown(categorySelect, typeSelect.value);



Â  Â  Â  Â  Â  Â  form.onsubmit = async e => {

Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  Â  Â  const id = templateIdInput.value;

Â  Â  Â  Â  Â  Â  Â  Â  const valueType = document.querySelector('input[name="recurring-value-type"]:checked').value;

Â  Â  Â  Â  Â  Â  Â  Â  let value = 0;

Â  Â  Â  Â  Â  Â  Â  Â  let referenceValue = 0;



Â  Â  Â  Â  Â  Â  Â  Â  if (valueType === 'fixed') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value = parseFloat(valueInput.value) || 0;

Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  referenceValue = parseFloat(valueInput.value) || 0;

Â  Â  Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  Â  Â  const data = {Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: typeSelect.value,Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category: categorySelect.value,Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value,Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  referenceValue,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueType,Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  day: parseInt(dayInput.value),Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: descriptionInput.value,Â 

Â  Â  Â  Â  Â  Â  Â  Â  };



Â  Â  Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (id) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/recurring_transactions`, id), data);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('Recorrente atualizado!', 'success', document.getElementById('recurring-alert-message'));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.createdAt = serverTimestamp();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/recurring_transactions`), data);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('Recorrente salvo!', 'success', document.getElementById('recurring-alert-message'));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetRecurringForm();

Â  Â  Â  Â  Â  Â  Â  Â  } catch(err) {Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('Erro ao salvar', 'error', document.getElementById('recurring-alert-message'));Â 

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  };



Â  Â  Â  Â  const generateAndRenderPendingTransactions = () => {

Â  Â  Â  Â  Â  Â  state.pendingTransactions = [];

Â  Â  Â  Â  Â  Â  const today = new Date();

Â  Â  Â  Â  Â  Â  const currentMonth = today.getMonth();

Â  Â  Â  Â  Â  Â  const currentYear = today.getFullYear();

Â  Â  Â  Â  Â  Â  const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  state.recurringTemplates.forEach(template => {

Â  Â  Â  Â  Â  Â  Â  Â  const transactionExists = state.transactions.some(t => t.recurringTemplateId === template.id && t.date.startsWith(monthStr));

Â  Â  Â  Â  Â  Â  Â  Â  if (!transactionExists) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const day = Math.min(template.day, new Date(currentYear, currentMonth + 1, 0).getDate());

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = `${monthStr}-${String(day).padStart(2, '0')}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.pendingTransactions.push({ ...template, date, templateId: template.id });

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });



Â  Â  Â  Â  Â  Â  elements.pendingTransactionsList.innerHTML = '';

Â  Â  Â  Â  Â  Â  if (state.pendingTransactions.length > 0) {

Â  Â  Â  Â  Â  Â  Â  Â  elements.pendingTransactionsCard.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  state.pendingTransactions.forEach(p => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const el = document.createElement('div');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.className = `p-2 border-b grid grid-cols-3 gap-2 items-center`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let actionHtml = '';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (p.valueType === 'variable') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionHtml = `<div class="col-span-2 flex gap-1"><input type="number" id="pending-value-${p.templateId}" class="w-full rounded p-1 text-sm" placeholder="Valor"><button class="post-variable-btn bg-green-500 text-white px-2 rounded text-sm" data-id="${p.templateId}">LanÃ§ar</button></div>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionHtml = `<div class="col-span-2 flex justify-end items-center gap-2"><span class="font-semibold text-sm ${p.type}-text">${formatCurrency(p.value)}</span><button class="confirm-pending-btn bg-blue-500 text-white px-2 py-1 rounded-full text-xs" data-id="${p.templateId}">âœ“</button></div>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.innerHTML = `<div class="text-sm"><p class="font-semibold">${p.description}</p><p class="text-xs text-gray-500">${p.category}</p></div> ${actionHtml}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  elements.pendingTransactionsList.appendChild(el);

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  elements.pendingTransactionsCard.classList.add('hidden');

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  };



Â  Â  Â  Â  const calculateForecast = () => {

Â  Â  Â  Â  Â  Â  let projectedIncome = 0;

Â  Â  Â  Â  Â  Â  let recurringExpenses = 0;

Â  Â  Â  Â  Â  Â  let totalInvestments = state.transactions.filter(t => t.type === 'investment').reduce((sum, t) => sum + t.value, 0);



Â  Â  Â  Â  Â  Â  state.recurringTemplates.forEach(t => {

Â  Â  Â  Â  Â  Â  Â  Â  if(t.type === 'income') projectedIncome += t.value;

Â  Â  Â  Â  Â  Â  Â  Â  if(t.type === 'expense') recurringExpenses += t.valueType === 'fixed' ? t.value : t.referenceValue || 0;

Â  Â  Â  Â  Â  Â  Â  Â  if(t.type === 'investment') recurringExpenses += t.value;

Â  Â  Â  Â  Â  Â  });



Â  Â  Â  Â  Â  Â  const last3Months = [...new Set(state.transactions.map(t => t.date.substring(0, 7)))].sort().slice(-4, -1);

Â  Â  Â  Â  Â  Â  let totalOtherExpenses = 0;

Â  Â  Â  Â  Â  Â  let monthCount = 0;



Â  Â  Â  Â  Â  Â  if (last3Months.length > 0) {

Â  Â  Â  Â  Â  Â  Â  Â  last3Months.forEach(month => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  monthCount++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const monthlyTransactions = state.transactions.filter(t => t.date.startsWith(month));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let monthlyNonRecurringExpense = 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  monthlyTransactions.forEach(t => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.type === 'expense' && !t.recurringTemplateId) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  monthlyNonRecurringExpense += t.value;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalOtherExpenses += monthlyNonRecurringExpense;

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const avgOtherExpenses = monthCount > 0 ? totalOtherExpenses / monthCount : 0;

Â  Â  Â  Â  Â  Â  const projectedTotalExpenses = recurringExpenses + avgOtherExpenses;

Â  Â  Â  Â  Â  Â  const projectedBalance = projectedIncome - projectedTotalExpenses;



Â  Â  Â  Â  Â  Â  return { projectedIncome, recurringExpenses, avgOtherExpenses, projectedTotalExpenses, projectedBalance, totalInvestments };

Â  Â  Â  Â  };





Â  Â  Â  Â  const renderForecastModal = () => {

Â  Â  Â  Â  Â  Â  const forecast = calculateForecast();

Â  Â  Â  Â  Â  Â  elements.forecastModal.innerHTML = `

Â  Â  Â  Â  Â  Â  <div class="modal-content w-full max-w-3xl">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold">PrevisÃ£o Financeira</h3><span class="close-btn" id="close-forecast-modal-btn">&times;</span></div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-6">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-200">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex -mb-px">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab-btn active py-3 px-4 border-b-2" data-tab="forecast-summary">PrevisÃ£o de Gastos</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab-btn py-3 px-4 border-b-2 border-transparent" data-tab="wishlist">Lista de Desejos</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="forecast-summary">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-semibold mb-4">ProjeÃ§Ã£o para o PrÃ³ximo MÃªs</h4>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-4 text-center">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Renda Prevista</p><p class="text-2xl font-bold income-text">${formatCurrency(forecast.projectedIncome)}</p></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Despesas Totais Previstas</p><p class="text-2xl font-bold expense-text">${formatCurrency(forecast.projectedTotalExpenses)}</p></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4 space-y-2 text-sm">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between p-2 rounded bg-gray-100"><span>Despesas Recorrentes (Fixas + VariÃ¡veis)</span><span class="font-semibold">${formatCurrency(forecast.recurringExpenses)}</span></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between p-2 rounded bg-gray-100"><span>MÃ©dia de Outros Gastos</span><span class="font-semibold">${formatCurrency(forecast.avgOtherExpenses)}</span></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-6 p-4 rounded-lg text-center ${forecast.projectedBalance >= 0 ? 'bg-green-100' : 'bg-red-100'}">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-semibold ${forecast.projectedBalance >= 0 ? 'text-green-800' : 'text-red-800'}">SALDO FINAL PREVISTO</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-3xl font-bold ${forecast.projectedBalance >= 0 ? 'text-green-800' : 'text-red-800'}">${formatCurrency(forecast.projectedBalance)}</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="wishlist" class="hidden">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="wishlist-list" class="space-y-3 mb-6"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <form id="wishlist-form" class="mt-4 border-t pt-4"><h4 id="wishlist-form-title" class="text-lg font-semibold mb-2">Adicionar Item na Lista</h4><input type="hidden" id="wishlist-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="wishlist-name" placeholder="Nome do item (Ex: Celular novo)" required class="w-full rounded-lg p-2"><input type="number" id="wishlist-value" placeholder="Valor" required class="w-full rounded-lg p-2" step="0.01"></div><div><label class="block text-xs font-medium text-gray-700 mt-2">Prioridade</label><select id="wishlist-priority" class="mt-1 w-full rounded-lg p-2"><option value="baixa">Baixa</option><option value="media" selected>MÃ©dia</option><option value="alta">Alta</option></select></div><div class="flex gap-2"><button type="button" id="cancel-edit-wish-btn" class="w-1/3 py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 hidden">Cancelar</button><button type="submit" id="wishlist-submit-btn" class="w-full mt-4 py-2 px-4 rounded-lg text-sm font-medium text-white bg-blue-500 hover:bg-blue-600">Adicionar Ã  Lista</button></div></form>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>`;



Â  Â  Â  Â  Â  Â  document.getElementById('close-forecast-modal-btn').onclick = () => closeModal(elements.forecastModal);



Â  Â  Â  Â  Â  Â  const tabs = elements.forecastModal.querySelectorAll('.tab-btn');

Â  Â  Â  Â  Â  Â  tabs.forEach(tab => tab.onclick = () => {

Â  Â  Â  Â  Â  Â  Â  Â  tabs.forEach(t => t.classList.remove('active'));

Â  Â  Â  Â  Â  Â  Â  Â  tab.classList.add('active');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('forecast-summary').classList.toggle('hidden', tab.dataset.tab !== 'forecast-summary');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('wishlist').classList.toggle('hidden', tab.dataset.tab !== 'wishlist');

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const renderWishlist = () => {

Â  Â  Â  Â  Â  Â  Â  Â  const listEl = document.getElementById('wishlist-list');

Â  Â  Â  Â  Â  Â  Â  Â  listEl.innerHTML = '';

Â  Â  Â  Â  Â  Â  Â  Â  if (!state.wishlist.length) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listEl.innerHTML = '<p class="text-center text-gray-500">Sua lista de desejos estÃ¡ vazia.</p>';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  const priorityOrder = { 'alta': 1, 'media': 2, 'baixa': 3 };

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  state.wishlist.sort((a,b) => priorityOrder[a.priority] - priorityOrder[b.priority] || a.value - b.value).forEach(item => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let estimate = '';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (forecast.projectedBalance > 0) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const remainingCost = item.value - forecast.totalInvestments;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (remainingCost <= 0) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  estimate = `<span class="font-semibold text-green-600">Pode comprar agora!</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const monthsToWait = Math.ceil(remainingCost / forecast.projectedBalance);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const purchaseDate = new Date();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  purchaseDate.setMonth(purchaseDate.getMonth() + monthsToWait);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  estimate = `<span>Estimativa: <span class="font-semibold">${purchaseDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric'})}</span></span>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â estimate = `<span class="font-semibold text-red-600">NÃ£o Ã© possÃ­vel estimar</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const priorityColors = { 'alta': 'bg-red-200 text-red-800', 'media': 'bg-yellow-200 text-yellow-800', 'baixa': 'bg-blue-200 text-blue-800' };



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listEl.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold">${item.name} <span class="text-xs px-2 py-1 rounded-full ${priorityColors[item.priority]}">${item.priority}</span></p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500">${estimate}</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-sm text-blue-600">${formatCurrency(item.value)}</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="buy-wish-btn p-1 hover:bg-green-200 rounded-full" data-id="${item.id}" title="Comprar"><svg class="h-5 w-5 text-green-600"Â  viewBox="0 0 24 24"Â  fill="none"Â  stroke="currentColor"Â  stroke-width="2"Â  stroke-linecap="round"Â  stroke-linejoin="round">Â  <circle cx="9" cy="21" r="1" />Â  <circle cx="20" cy="21" r="1" />Â  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" /></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="edit-wish-btn p-1 hover:bg-gray-200 rounded-full" data-id="${item.id}" title="Editar"><svg class="h-4 w-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg></button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-wish-btn text-red-500 p-1 hover:bg-gray-200 rounded-full text-lg font-bold" data-id="${item.id}" title="Excluir">&times;</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  listEl.onclick = async (e) => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const deleteBtn = e.target.closest('.delete-wish-btn');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const editBtn = e.target.closest('.edit-wish-btn');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const buyBtn = e.target.closest('.buy-wish-btn');



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (deleteBtn) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/wishlist`, deleteBtn.dataset.id));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(editBtn) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const id = editBtn.dataset.id;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = state.wishlist.find(w => w.id === id);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('wishlist-form-title').textContent = 'Editar Item';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('wishlist-submit-btn').textContent = 'Atualizar Item';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('wishlist-id').value = id;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('wishlist-name').value = item.name;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('wishlist-value').value = item.value;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('wishlist-priority').value = item.priority;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('cancel-edit-wish-btn').classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(buyBtn) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const id = buyBtn.dataset.id;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = state.wishlist.find(w => w.id === id);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item) renderPurchaseModal(item);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const wishlistForm = document.getElementById('wishlist-form');

Â  Â  Â  Â  Â  Â  const cancelWishEditBtn = document.getElementById('cancel-edit-wish-btn');



Â  Â  Â  Â  Â  Â  const resetWishlistForm = () => {

Â  Â  Â  Â  Â  Â  Â  Â  wishlistForm.reset();

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('wishlist-form-title').textContent = 'Adicionar Item na Lista';

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('wishlist-submit-btn').textContent = 'Adicionar Ã  Lista';

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('wishlist-id').value = '';

Â  Â  Â  Â  Â  Â  Â  Â  cancelWishEditBtn.classList.add('hidden');

Â  Â  Â  Â  Â  Â  };



Â  Â  Â  Â  Â  Â  cancelWishEditBtn.onclick = resetWishlistForm;



Â  Â  Â  Â  Â  Â  onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/wishlist`), s => {

Â  Â  Â  Â  Â  Â  Â  Â  state.wishlist = s.docs.map(d => ({ id: d.id, ...d.data() }));

Â  Â  Â  Â  Â  Â  Â  Â  renderWishlist();

Â  Â  Â  Â  Â  Â  });



Â  Â  Â  Â  Â  Â  wishlistForm.onsubmit = async (e) => {

Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  Â  Â  const id = document.getElementById('wishlist-id').value;

Â  Â  Â  Â  Â  Â  Â  Â  const name = document.getElementById('wishlist-name').value;

Â  Â  Â  Â  Â  Â  Â  Â  const value = parseFloat(document.getElementById('wishlist-value').value);

Â  Â  Â  Â  Â  Â  Â  Â  const priority = document.getElementById('wishlist-priority').value;



Â  Â  Â  Â  Â  Â  Â  Â  if (name && value > 0) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = { name, value, priority };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (id) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/wishlist`, id), data);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/wishlist`), data);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetWishlistForm();

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  };



Â  Â  Â  Â  const renderPurchaseModal = (item) => {

Â  Â  Â  Â  Â  Â  elements.purchaseModal.innerHTML = `<div class="modal-content w-full max-w-md">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Confirmar Compra</h3><span class="close-btn" id="close-purchase-modal-btn">&times;</span></div>

Â  Â  Â  Â  Â  Â  Â  Â  <p class="mb-4">Registrando a compra de: <strong class="font-semibold">${item.name}</strong> - <strong class="font-semibold expense-text">${formatCurrency(item.value)}</strong></p>

Â  Â  Â  Â  Â  Â  Â  Â  <form id="purchase-form" class="space-y-4">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-700">Forma de Pagamento</label>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="purchase-payment-method" class="mt-1 block w-full rounded-lg p-2"><option value="Dinheiro">Dinheiro</option><option value="Pix">Pix</option><option value="CartÃ£o de CrÃ©dito">CartÃ£o de CrÃ©dito</option><option value="CartÃ£o de DÃ©bito">CartÃ£o de DÃ©bito</option></select>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="purchase-installments-field" class="hidden">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-700">Parcelas</label>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="purchase-installments" class="mt-1 block w-full rounded-lg p-2"></select>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full py-2 px-4 rounded-lg text-sm font-medium text-white bg-green-600 hover:bg-green-700">Confirmar e LanÃ§ar</button>

Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  </div>`;



Â  Â  Â  Â  Â  Â  const purchasePaymentMethod = document.getElementById('purchase-payment-method');

Â  Â  Â  Â  Â  Â  const purchaseInstallmentsField = document.getElementById('purchase-installments-field');

Â  Â  Â  Â  Â  Â  const purchaseInstallments = document.getElementById('purchase-installments');

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  generateInstallmentOptions(purchaseInstallments);

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  purchasePaymentMethod.onchange = () => {

Â  Â  Â  Â  Â  Â  Â  Â  purchaseInstallmentsField.classList.toggle('hidden', purchasePaymentMethod.value !== 'CartÃ£o de CrÃ©dito');

Â  Â  Â  Â  Â  Â  };



Â  Â  Â  Â  Â  Â  document.getElementById('close-purchase-modal-btn').onclick = () => closeModal(elements.purchaseModal);

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  document.getElementById('purchase-form').onsubmit = async (e) => {

Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  Â  Â  const paymentMethod = purchasePaymentMethod.value;

Â  Â  Â  Â  Â  Â  Â  Â  const installments = parseInt(purchaseInstallments.value);

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const batch = writeBatch(db);



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (paymentMethod === 'CartÃ£o de CrÃ©dito' && installments > 1) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const installmentValue = parseFloat((item.value / installments).toFixed(2));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const purchaseDate = new Date();



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < installments; i++) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const transactionDate = new Date(purchaseDate.getFullYear(), purchaseDate.getMonth() + i, purchaseDate.getDate());

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const transactionRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.set(transactionRef, {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'expense',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value: installmentValue,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category: 'Compras', // Default category, can be changed

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: transactionDate.toISOString().slice(0, 10),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: `${item.name} (${i + 1}/${installments})`,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paymentMethod: 'CartÃ£o de CrÃ©dito',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  installmentInfo: { current: i + 1, total: installments },

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp()

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const transactionRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.set(transactionRef, {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'expense',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value: item.value,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category: 'Compras',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: new Date().toISOString().slice(0, 10),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: item.name,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paymentMethod: paymentMethod,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp()

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const wishlistItemRef = doc(db, `/artifacts/${appId}/users/${userId}/wishlist`, item.id);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.delete(wishlistItemRef);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModal(elements.purchaseModal);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModal(elements.forecastModal);



Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao confirmar compra: ", err);

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  openModal(elements.purchaseModal);

Â  Â  Â  Â  };

Â  Â  </script>

</body>

</html>
