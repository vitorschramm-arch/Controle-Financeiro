<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Previne scroll do body quando o modal está aberto */
        .modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app">
        <!-- O conteúdo da aplicação será renderizado aqui -->
    </div>
     <div id="modal-container">
        <!-- Os modais serão renderizados aqui -->
    </div>


    <script type="module">
        // --- Importações do Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração do Firebase ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Ícones SVG como Funções ---
        const PlusIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
        const EyeIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        const EyeOffIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>`;
        const SettingsIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0 .73 2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        const ChevronLeftIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg>`;
        const ChevronRightIcon = (props = {}) => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${props.class || ''}"><path d="m9 18 6-6-6-6"></path></svg>`;
        const ArrowUpDownIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>`;
        const TrashIcon = (props = {}) => `<svg xmlns="http://www.w3.org/2000/svg" width="${props.width || 16}" height="${props.height || 16}" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${props.class || ''}"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>`;
        const CheckIcon = (props = {}) => `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${props.class || ''}"><path d="M20 6 9 17l-5-5"/></svg>`;
        const EditIcon = (props = {}) => `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${props.class || ''}"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>`;
        const ExclamationIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
        const TrendingUpIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>`;

        // --- Funções Utilitárias ---
        const formatCurrency = (value) => {
            const number = Number(value);
            if (isNaN(number)) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(0);
            }
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(number);
        };

        const ALL_CATEGORIES = {
            entrada: { "Salário": ["Adiantamento", "Pagamento Mensal"], "Renda Extra": ["Freelance", "Vendas"], "Outras Entradas": [], },
            saida: { "Moradia": ["Aluguel", "Condomínio", "Energia", "Água", "Internet"], "Alimentação": ["Supermercado", "Restaurante", "Delivery"], "Transporte": ["Combustível", "Transporte Público", "Uber/99"], "Dívidas": ["Parcela Empréstimo", "Parcela Financiamento"], "Lazer": ["Cinema", "Viagens", "Hobbies"], "Saúde": ["Farmácia", "Consulta"], "Educação": ["Cursos", "Mensalidade"], "Outras Saídas": [], },
            investimento: { "Renda Fixa": ["CDB", "Tesouro Direto", "LCI/LCA"], "Renda Variável": ["Ações", "Fundos Imobiliários", "ETFs"], "Outros Investimentos": [], }
        };

        // --- Gerenciamento de Estado ---
        let state = {
            user: null,
            isAuthReady: false,
            isLoading: true,
            transactions: [],
            debts: [],
            settings: null,
            currentDate: new Date(),
            ui: {
                showValues: false,
                monthlyOverviewShowValues: true,
                activeModal: null,
                modalData: null,
                modalFormState: {},
                transactionHistoryFilter: 'all',
                detailsModalSortConfig: { key: 'date', direction: 'descending' },
                detailsModalSubFilter: 'all',
                settingsTab: 'saida',
            }
        };

        const appElement = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');


        function setState(newState) {
            state = { ...state, ...newState, isLoading: false };
            render();
        }

        function setUiState(newUiState) {
            const oldModal = state.ui.activeModal;
            state.ui = { ...state.ui, ...newUiState };

            if (state.ui.activeModal && !oldModal) {
                document.body.classList.add('modal-open');
            } else if (!state.ui.activeModal && oldModal) {
                document.body.classList.remove('modal-open');
            }
            render();
        }

        // --- Funções de Cálculo (Derivadas do Estado) ---
        function getFinancials(transactions, debts, currentDate, settings) {
             const saldo = transactions.reduce((acc, t) => {
                if (t.transactionNature !== 'pontual' && t.status !== 'approved') return acc;
                if (t.type === 'entrada') return acc + t.amount;
                if (t.type === 'saida') return acc - t.amount;
                return acc;
            }, 0);

            const totalInvestido = transactions.reduce((acc, t) => {
                if (t.type === 'investimento' && (t.transactionNature === 'pontual' || t.status === 'approved')) return acc + t.amount;
                return acc;
            }, 0);

            const totalDebts = debts.reduce((acc, debt) => acc + debt.remainingBalance, 0);
            
            const currentMonthStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            const pendingTransactions = transactions.filter(t => {
                if (t.transactionNature !== 'recorrente') return false;
                if (t.approvedMonths && t.approvedMonths.includes(currentMonthStr)) return false;

                if (t.duration) {
                    const createdAtDate = t.createdAt?.toDate();
                    if (!createdAtDate) return true;
                    const endDate = new Date(createdAtDate);
                    endDate.setMonth(endDate.getMonth() + t.duration);
                    if (currentDate > endDate) return false;
                }
                return true;
            });

            const monthlyData = { income: 0, expenses: 0, balance: 0, categoryExpenses: {}, categoryPending: {} };
            
            const monthlyTransactions = transactions.filter(t => {
                if (t.transactionNature === 'recorrente') return false;
                const transactionDate = t.date ? new Date(t.date + 'T00:00:00') : null;
                if (!transactionDate) return false;
                return transactionDate.getFullYear() === currentDate.getFullYear() && transactionDate.getMonth() === currentDate.getMonth();
            });

            monthlyTransactions.forEach(t => {
                if (t.type === 'entrada') monthlyData.income += t.amount;
                if (t.type === 'saida') {
                    monthlyData.expenses += t.amount;
                    monthlyData.categoryExpenses[t.category] = (monthlyData.categoryExpenses[t.category] || 0) + t.amount;
                }
            });
            
            pendingTransactions.forEach(t => {
                if (t.type === 'saida') {
                    monthlyData.categoryPending[t.category] = (monthlyData.categoryPending[t.category] || 0) + t.amount;
                }
            });
            
            monthlyData.balance = monthlyData.income - monthlyData.expenses;
            
            let faturaAtual = 0;
            if (settings?.cardClosingDay) {
                const closingDay = settings.cardClosingDay;
                
                let billEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), closingDay);
                let billStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, closingDay + 1);

                if (new Date().getDate() > closingDay) {
                    billStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), closingDay + 1);
                    billEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, closingDay);
                }

                faturaAtual = transactions.reduce((acc, t) => {
                    if (t.paymentMethod === 'Cartão de Crédito' && t.date) {
                        const transactionDate = new Date(t.date + 'T00:00:00');
                        if (transactionDate >= billStartDate && transactionDate <= billEndDate) {
                            return acc + t.amount;
                        }
                    }
                    return acc;
                }, 0);
            }

            return { saldo, totalInvestido, pendingTransactions, totalDebts, monthlyData, faturaAtual, monthlyTransactions };
        }


        // --- Componentes HTML ---

        function HeaderComponent() {
            return `
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Meu Painel</h1>
                        <p class="text-gray-500">Bem-vindo(a) de volta!</p>
                    </div>
                    <div class="flex items-center space-x-2">
                         <button data-action="open-modal" data-modal="forecast" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Previsão Futura">
                            ${TrendingUpIcon()}
                        </button>
                        <button data-action="open-modal" data-modal="settings" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Configurações">
                            ${SettingsIcon()}
                        </button>
                    </div>
                </header>
            `;
        }
        
        function DashboardComponent({ saldo, totalInvestido, totalDebts, faturaAtual }) {
            const cards = [
                { title: "Saldo", value: saldo },
                { title: "Dívidas", value: totalDebts },
                { title: "Total Investido", value: totalInvestido },
                { title: "Fatura Atual", value: faturaAtual },
            ];
            return `
                <section>
                    <div class="flex justify-end mb-4"><button data-action="toggle-dashboard-values" class="p-2 rounded-full hover:bg-gray-200 transition-colors">${state.ui.showValues ? EyeOffIcon() : EyeIcon()}</button></div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                        ${cards.map(card => `
                            <div data-action="open-card-details" data-title="${card.title}" class="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition-shadow">
                                <h3 class="text-gray-500 font-medium">${card.title}</h3>
                                <p class="text-2xl font-bold truncate ${state.ui.showValues ? 'text-gray-800' : 'bg-gray-200 rounded-md text-transparent'}">${formatCurrency(card.value)}</p>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        function MonthNavigatorComponent({ currentDate }){
            const monthName = currentDate.toLocaleString('pt-BR', { month: 'long' });
            return `
                <div class="flex items-center justify-center my-4 p-2 rounded-lg bg-white shadow-sm">
                    <button data-action="change-month" data-direction="-1" class="p-2 rounded-full hover:bg-gray-100">${ChevronLeftIcon()}</button>
                    <div class="text-center font-semibold text-lg w-48"><span class="capitalize">${monthName}</span> de ${currentDate.getFullYear()}</div>
                    <button data-action="change-month" data-direction="1" class="p-2 rounded-full hover:bg-gray-100">${ChevronRightIcon()}</button>
                </div>
            `;
        }
        
        function MonthlyOverviewComponent({ data, settings }) {
            const { income, expenses, balance, categoryExpenses, categoryPending } = data;
            const { budgets = {}, savingsGoal = 0 } = settings || {};
            const showValues = state.ui.monthlyOverviewShowValues;

            const totalPendingExpenses = Object.values(categoryPending || {}).reduce((sum, value) => sum + value, 0);
            const projectedExpenses = expenses + totalPendingExpenses;
            const projectedBalance = income - projectedExpenses;

            const unbudgetedCategories = Object.keys(categoryExpenses)
                .filter(category => !budgets || !budgets[category] || budgets[category] <= 0)
                .reduce((obj, key) => {
                    obj[key] = categoryExpenses[key];
                    return obj;
                }, {});

            const PieChart = (chartData) => {
                const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1'];
                const total = Object.values(chartData).reduce((sum, value) => sum + value, 0);
                if (total === 0) return `<div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center text-sm text-gray-500">Sem dados</div>`;

                let cumulativePercent = 0;
                const slices = Object.entries(chartData).map(([key, value], index) => {
                    const percent = (value / total);
                    const startAngle = cumulativePercent * 360;
                    const endAngle = (cumulativePercent + percent) * 360;
                    cumulativePercent += percent;
                    const getCoord = (angle) => { const rad = (angle - 90) * Math.PI / 180; return [50 + 50 * Math.cos(rad), 50 + 50 * Math.sin(rad)]; };
                    const [startX, startY] = getCoord(startAngle); const [endX, endY] = getCoord(endAngle); const largeArcFlag = endAngle - startAngle > 180 ? 1 : 0;
                    const pathData = `M 50,50 L ${startX},${startY} A 50,50 0 ${largeArcFlag},1 ${endX},${endY} Z`;
                    return `<path key="${key}" d="${pathData}" fill="${colors[index % colors.length]}" />`;
                }).join('');
                return `<svg viewBox="0 0 100 100" class="w-24 h-24">${slices}</svg>`;
            };

            return `
                 <section class="mt-6 bg-white p-4 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Visão Geral do Mês</h2>
                        <button data-action="toggle-monthly-overview-values" class="p-2 rounded-full hover:bg-gray-100">${showValues ? EyeOffIcon() : EyeIcon()}</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                        <div class="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors" data-action="open-monthly-overview-details" data-type="income">
                            <p class="text-sm text-gray-500">Entradas</p>
                            <p class="font-bold text-lg ${showValues ? 'text-green-600' : 'bg-gray-200 rounded text-transparent'}">${formatCurrency(income)}</p>
                        </div>
                        <div class="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors" data-action="open-monthly-overview-details" data-type="expenses">
                            <p class="text-sm text-gray-500">Saídas</p>
                            <p class="font-bold text-lg ${showValues ? 'text-red-600' : 'bg-gray-200 rounded text-transparent'}">${formatCurrency(expenses)}</p>
                            ${totalPendingExpenses > 0 ? `<p class="text-xs mt-1 ${showValues ? 'text-gray-500' : 'bg-gray-200 rounded text-transparent'}">Previsto: ${formatCurrency(projectedExpenses)}</p>` : ''}
                        </div>
                        <div class="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors" data-action="open-monthly-overview-details" data-type="balance">
                            <p class="text-sm text-gray-500">Saldo do Mês</p>
                            <p class="font-bold text-lg ${showValues ? (balance >= 0 ? 'text-gray-800' : 'text-red-600') : 'bg-gray-200 rounded text-transparent'}">${formatCurrency(balance)}</p>
                            ${totalPendingExpenses > 0 ? `<p class="text-xs mt-1 ${showValues ? 'text-gray-500' : 'bg-gray-200 rounded text-transparent'}">Previsto: ${formatCurrency(projectedBalance)}</p>` : ''}
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="flex-shrink-0 text-center"><h3 class="font-semibold mb-2">Gastos por Categoria</h3>${PieChart(categoryExpenses)}</div>
                        <div class="flex-1 space-y-4">
                            ${Object.entries(budgets).filter(([, budgetVal]) => budgetVal > 0).map(([category, budget]) => {
                                const spent = categoryExpenses[category] || 0;
                                if(spent === 0) return '';
                                const pending = categoryPending[category] || 0;
                                const totalSpent = spent + pending;
                                const spentPercent = (spent / budget) * 100;
                                const pendingPercent = (pending / budget) * 100;
                                return `
                                    <div key="${category}" class="cursor-pointer" data-action="open-category-details" data-category="${category}">
                                        <div class="flex justify-between text-sm mb-1"><span class="font-medium">${category}</span><span class="${showValues ? 'text-gray-600' : 'bg-gray-200 rounded text-transparent'}">${`${formatCurrency(totalSpent)} / ${formatCurrency(budget)}`}</span></div>
                                        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden"><div class="bg-green-500 h-4" style="width: ${spentPercent}%; float: left;"></div><div class="bg-gray-400 h-4" style="width: ${pendingPercent}%; float: left;"></div></div>
                                    </div>
                                `;
                            }).join('')}
                            ${Object.keys(unbudgetedCategories).length > 0 ? `
                                <div class="mt-4 pt-4 border-t border-dashed space-y-3">
                                    <h4 class="text-sm font-semibold text-yellow-700">Gastos não orçados</h4>
                                    ${Object.entries(unbudgetedCategories).map(([category, spent]) => `
                                        <div key="${category}" class="flex justify-between items-center bg-yellow-50 p-2 rounded-lg">
                                            <div class="flex items-center gap-2">${ExclamationIcon()}<span class="font-medium text-sm">${category}</span></div>
                                            <div class="flex items-center gap-3"><span class="font-semibold text-sm ${showValues ? 'text-yellow-800' : 'bg-gray-200 rounded text-transparent'}">${formatCurrency(spent)}</span><button data-action="open-modal" data-modal="settings" class="text-xs bg-yellow-200 text-yellow-800 font-bold py-1 px-2 rounded hover:bg-yellow-300">Regularizar</button></div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                             ${savingsGoal > 0 ? `
                                <div>
                                    <div class="flex justify-between text-sm mb-1"><span class="font-medium">Meta de Economia</span><span class="${showValues ? 'text-gray-600' : 'bg-gray-200 rounded text-transparent'}">${`${formatCurrency(balance > 0 ? balance : 0)} / ${formatCurrency(savingsGoal)}`}</span></div>
                                    <div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-blue-500 h-4 rounded-full" style="width: ${Math.min((balance > 0 ? balance : 0) / savingsGoal * 100, 100)}%;"></div></div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </section>
            `;
        }
        
        function PendingSectionComponent({ pendingTransactions }) {
            return `
                <section class="mt-6">
                    <div data-action="open-modal" data-modal="pending" class="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition-shadow">
                        <h2 class="text-xl font-bold mb-2">Pendentes de Aprovação</h2>
                        ${pendingTransactions.length === 0 ? `<p class="text-center text-gray-500 py-4">Nenhum lançamento pendente para este mês.</p>` : `
                            <ul class="space-y-2">
                                ${pendingTransactions.slice(0, 3).map(t => `<li key="${t.id}" class="bg-gray-50 p-2 rounded-lg flex justify-between items-center text-sm"><div><p class="font-semibold">${t.description || t.category}</p><p class="text-xs text-gray-500">Dia ${t.dayOfMonth}</p></div><span class="font-semibold text-gray-700">${formatCurrency(t.amount)}</span></li>`).join('')}
                                ${pendingTransactions.length > 3 ? `<p class="text-center text-sm text-blue-600 font-semibold mt-2">e mais ${pendingTransactions.length - 3}...</p>` : ''}
                            </ul>
                        `}
                    </div>
                </section>
            `;
        }

        function TransactionHistoryComponent({ monthlyTransactions }) {
             const uniqueCategories = ['all', ...Array.from(new Set(monthlyTransactions.map(t => t.category))).sort()];
            const filterCategory = state.ui.transactionHistoryFilter;
            
            const filteredTransactions = monthlyTransactions.filter(t => filterCategory === 'all' || t.category === filterCategory);

            const filteredTotal = filteredTransactions.reduce((acc, t) => {
                if (t.type === 'entrada') return acc + t.amount;
                if (t.type === 'saida') return acc - t.amount;
                return acc;
            }, 0);

            const getTypePill = (type) => {
                const styles = { entrada: "bg-green-100 text-green-800", saida: "bg-red-100 text-red-800", investimento: "bg-blue-100 text-blue-800" };
                const text = { entrada: "Entrada", saida: "Saída", investimento: "Invest." };
                return `<span class="text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full ${styles[type]}">${text[type]}</span>`;
            };

            return `
                <section class="mt-8">
                    <h2 class="text-xl font-bold mb-4">Histórico de Transações do Mês</h2>
                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 p-2 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <label for="category-filter" class="text-sm font-medium">Filtrar:</label>
                                <select id="category-filter" data-action="filter-history" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2">
                                    ${uniqueCategories.map(cat => `<option value="${cat}" ${cat === filterCategory ? 'selected' : ''}>${cat === 'all' ? 'Todas as Categorias' : cat}</option>`).join('')}
                                </select>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Total Filtrado</p>
                                <p class="font-bold text-lg ${filteredTotal >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(filteredTotal)}</p>
                            </div>
                        </div>
                        
                        ${filteredTransactions.length === 0 ? `<p class="text-center text-gray-500 py-8">Nenhuma transação encontrada.</p>` : `
                            <ul class="divide-y divide-gray-200">
                                ${filteredTransactions.map(t => `
                                    <li key="${t.id}" data-action="open-modal" data-modal="edit-transaction" data-id="${t.id}" class="py-3 flex justify-between items-center cursor-pointer hover:bg-gray-50 px-2 rounded-md">
                                        <div>
                                            <div class="flex items-center">${getTypePill(t.type)}<p class="text-sm font-medium text-gray-800">${t.description || t.category}</p></div>
                                            <p class="text-xs text-gray-500 mt-1">${t.category}${t.subcategory ? ` > ${t.subcategory}` : ''}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm font-semibold ${t.type === 'entrada' ? 'text-green-600' : 'text-gray-800'}">${formatCurrency(t.amount)}</p>
                                            <p class="text-xs text-gray-500 mt-1">${new Date(t.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        `}
                    </div>
                </section>
            `;
        }

        function FloatingActionButtonComponent() {
            return `<button data-action="open-modal" data-modal="transaction" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-transform transform hover:scale-110" aria-label="Adicionar nova transação">${PlusIcon()}</button>`;
        }


        // --- Funções de Modal ---
        function TransactionModalComponent({ categories }) {
             // Lógica interna para o modal, se necessário
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto">
                        <!-- Conteúdo do Modal aqui -->
                         <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">Nova Transação</h2>
                                <button data-action="close-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                            </div>
                            <!-- Formulário de Transação -->
                         </div>
                         <div class="bg-gray-50 px-6 py-4">
                            <button data-action="submit-transaction" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Adicionar Transação</button>
                         </div>
                    </div>
                </div>
            `;
        }
        
        // --- Adicione outras funções de componente de modal aqui ---
        // Ex: EditTransactionModalComponent, DetailsModalComponent, etc.

        function renderActiveModal() {
            const { activeModal, modalData } = state.ui;
            switch (activeModal) {
                case 'transaction':
                    return TransactionModalComponent({ categories: state.settings.categories });
                // Adicione casos para outros modais aqui
                // case 'settings':
                //     return SettingsModalComponent(...);
                default:
                    return '';
            }
        }

        // --- Função Principal de Renderização ---
        function render() {
            if (!appElement) return;

            if (state.isLoading || !state.isAuthReady) {
                appElement.innerHTML = `<div class="flex items-center justify-center h-screen bg-gray-100"><div class="text-xl font-semibold">Carregando...</div></div>`;
                return;
            }

            const financials = getFinancials(state.transactions, state.debts, state.currentDate, state.settings);
            
            appElement.innerHTML = `
                <div id="app-content">
                    <div class="container mx-auto p-4 md:p-6">
                        ${HeaderComponent()}
                        ${DashboardComponent(financials)}
                        ${MonthNavigatorComponent({currentDate: state.currentDate})}
                        ${MonthlyOverviewComponent({data: financials.monthlyData, settings: state.settings})}
                        ${PendingSectionComponent({pendingTransactions: financials.pendingTransactions})}
                        ${TransactionHistoryComponent({monthlyTransactions: financials.monthlyTransactions})}
                        ${FloatingActionButtonComponent()}
                    </div>
                </div>
            `;
            
            modalContainer.innerHTML = renderActiveModal();
        }

        // --- Lógica de Eventos ---
        document.body.addEventListener('click', e => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

            const { action, ...data } = actionTarget.dataset;

            switch (action) {
                case 'toggle-dashboard-values':
                    setUiState({ showValues: !state.ui.showValues });
                    break;
                case 'toggle-monthly-overview-values':
                    setUiState({ monthlyOverviewShowValues: !state.ui.monthlyOverviewShowValues });
                    break;
                case 'change-month':
                    const newDate = new Date(state.currentDate);
                    const direction = parseInt(data.direction, 10);
                    newDate.setMonth(newDate.getMonth() + direction);
                    setState({ currentDate: newDate });
                    break;
                case 'open-modal':
                     setUiState({ activeModal: data.modal, modalData: data.id ? { id: data.id } : null, modalFormState: {} });
                     break;
                case 'close-modal':
                     setUiState({ activeModal: null, modalData: null, modalFormState: {} });
                     break;
                case 'open-card-details':
                     if (data.title === 'Dívidas') {
                        setUiState({ activeModal: 'debts' });
                     } else {
                        setUiState({ activeModal: 'details', modalData: { title: data.title } });
                     }
                     break;
                case 'open-monthly-overview-details':
                     setUiState({ activeModal: 'details', modalData: { title: `Lançamentos de ${data.type === 'income' ? 'Entradas' : data.type === 'expenses' ? 'Saídas' : 'Saldo'}`, type: data.type } });
                     break;
                case 'open-category-details':
                     setUiState({ activeModal: 'details', modalData: { title: `Detalhes de ${data.category}`, category: data.category } });
                     break;
                 // Adicionar ações de submit e delete dos modais aqui
                 case 'submit-transaction':
                    // Lógica para pegar dados do form e salvar no firebase
                    console.log("Submetendo transação...");
                    setUiState({ activeModal: null, modalData: null }); // Fecha o modal após submeter
                    break;
            }
        });
        
        document.body.addEventListener('change', e => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

             const { action } = actionTarget.dataset;
             switch (action) {
                case 'filter-history':
                    setUiState({ transactionHistoryFilter: e.target.value });
                    break;
             }
        });
        
        // --- Inicialização e Autenticação ---
        onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
                if (!state.user || state.user.uid !== currentUser.uid) {
                     setState({ user: currentUser, isAuthReady: true });
                     initializeDataListeners();
                }
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação:", error);
                    appElement.innerHTML = `<div class="text-red-500 text-center p-8">Falha na autenticação.</div>`
                }
            }
        });
        
        function initializeDataListeners() {
            if (!state.user || !state.isAuthReady) return;
            const userId = state.user.uid;

            const settingsDocRef = doc(db, `/artifacts/${appId}/users/${userId}/settings/main`);
            onSnapshot(settingsDocRef, (docSnap) => {
                let newSettings;
                if (docSnap.exists()) {
                    const settingsData = docSnap.data();
                    if (!settingsData.categories) settingsData.categories = ALL_CATEGORIES;
                    newSettings = settingsData;
                } else {
                    const defaultSettings = { cardClosingDay: 1, savingsGoal: 0, budgets: {}, categories: ALL_CATEGORIES };
                    setDoc(settingsDocRef, defaultSettings);
                    newSettings = defaultSettings;
                }
                setState({ ...state, settings: newSettings });
            });

            const transactionsCollection = collection(db, `/artifacts/${appId}/users/${userId}/transactions`);
            onSnapshot(query(transactionsCollection), (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setState({ ...state, transactions });
            });
            
            const debtsCollection = collection(db, `/artifacts/${appId}/users/${userId}/debts`);
             onSnapshot(query(debtsCollection), (snapshot) => {
                const debts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 setState({ ...state, debts });
            });
        }
        
        // --- Renderização Inicial ---
        render();

    </script>
</body>
</html>

