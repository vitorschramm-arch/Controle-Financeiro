<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; color: #374151; }
        .container-card { background-color: #ffffff; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .interactive-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); cursor: pointer; }
        .income-text { color: #16a34a; } .expense-text { color: #dc2626; } .investment-text { color: #2563eb; } .goal-text { color: #f59e0b; } .debt-text { color: #9333ea; }
        .income-bg { background-color: #f0fdf4; border-left: 4px solid #16a34a; } .expense-bg { background-color: #fef2f2; border-left: 4px solid #dc2626; } .investment-bg { background-color: #eff6ff; border-left: 4px solid #2563eb; } .debt-bg { background-color: #faf5ff; border-left: 4px solid #9333ea; }
        input, select, textarea { background-color: #f3f4f6; color: #1f2937; border: 1px solid #d1d5db; font-size: 0.875rem; }
        input:focus, select:focus, textarea:focus { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); outline: none; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .modal-content { background-color: #ffffff; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s; }
        .close-btn { color: #aaa; position: absolute; top: 1rem; right: 1.5rem; font-size: 28px; font-weight: bold; cursor: pointer; }
        .alert-message { padding: 0.75rem 1rem; margin-top: 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; text-align: center; }
        .alert-success { background-color: #d1fae5; color: #065f46; } .alert-error { background-color: #fee2e2; color: #991b1b; }
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden; display: flex; }
        .progress { height: 100%; transition: width 0.5s ease-in-out; }
        .progress-committed { background-color: #d1d5db; }
        .tab-btn { border-bottom: 2px solid transparent; padding-bottom: 0.5rem; transition: all 0.2s; }
        .tab-btn.active { border-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="w-full max-w-7xl mx-auto space-y-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Dashboard Financeiro</h1>
                <p id="user-id" class="text-xs text-gray-500 mt-1 break-all"></p>
            </div>
            <div class="flex items-center gap-2">
                 <button id="ai-assistant-btn" class="p-2 rounded-full hover:bg-gray-200" title="Analisar com IA"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg></button>
                 <button id="forecast-btn" class="p-2 rounded-full hover:bg-gray-200" title="Previsão Financeira"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg></button>
                 <button id="reports-btn" class="p-2 rounded-full hover:bg-gray-200" title="Ver Relatórios"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></button>
                 <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200" title="Configurações"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Coluna da Esquerda: Resumos e Ações -->
            <div class="lg:col-span-1 space-y-6">
                <div id="balance-card" class="container-card interactive-card">
                    <div class="flex justify-between items-start">
                        <div><p class="text-sm text-gray-500">Saldo Disponível</p><p id="total-balance" class="text-4xl font-bold mt-1 text-gray-900">***</p></div>
                        <button id="toggle-main-balances-btn" class="p-2 rounded-full hover:bg-gray-200" title="Mostrar/Ocultar Saldo"></button>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div id="investment-card" class="container-card interactive-card text-center"><p class="text-xs text-gray-500">Investido</p><p id="total-investment" class="text-lg font-bold mt-1 investment-text">***</p></div>
                    <div id="credit-card-card" class="container-card interactive-card text-center"><p class="text-xs text-gray-500">Fatura</p><p id="total-credit-card" class="text-lg font-bold mt-1 expense-text">***</p></div>
                    <div id="debts-card" class="container-card interactive-card text-center"><p class="text-xs text-gray-500">Dívidas</p><p id="total-debts" class="text-lg font-bold mt-1 debt-text">***</p></div>
                </div>
                <!-- Card de Nova Transação / Recorrentes -->
                <div class="container-card">
                    <div class="flex border-b mb-4">
                        <button id="show-transaction-form" class="tab-btn flex-1 text-center font-semibold active">Pontual</button>
                        <button id="show-recurring-form" class="tab-btn flex-1 text-center font-semibold">Recorrente</button>
                    </div>

                    <!-- Formulário de Transação Pontual -->
                    <div id="transaction-form-container">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">Nova Transação</h2>
                        <form id="transaction-form" class="space-y-3">
                            <input type="hidden" id="transaction-id">
                            <div><label class="block text-xs font-medium text-gray-700">Tipo</label><div id="type-selector" class="flex space-x-2 mt-1"><div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="income">Entrada</div><div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="expense">Saída</div><div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="investment">Invest.</div></div><input type="hidden" id="type" required></div>
                            <div class="grid grid-cols-2 gap-3"><div><label for="value" class="block text-xs font-medium text-gray-700">Valor</label><input type="number" id="value" required class="mt-1 block w-full rounded-lg p-2 shadow-sm" placeholder="0,00" step="0.01"></div><div><label for="date" class="block text-xs font-medium text-gray-700">Data</label><input type="date" id="date" required class="mt-1 block w-full rounded-lg p-2 shadow-sm"></div></div>
                            <div><label for="category" class="block text-xs font-medium text-gray-700">Categoria</label><select id="category" required class="mt-1 block w-full rounded-lg p-2 shadow-sm"></select></div>
                            <div id="expense-fields" class="space-y-3 hidden"><div class="grid grid-cols-2 gap-3"><div><label for="payment-method" class="block text-xs font-medium text-gray-700">Pagamento</label><select id="payment-method" class="mt-1 block w-full rounded-lg p-2 shadow-sm"><option value="Dinheiro">Dinheiro</option><option value="Pix">Pix</option><option value="Cartão de Crédito">Cartão de Crédito</option><option value="Cartão de Débito">Cartão de Débito</option></select></div><div id="installments-field" class="hidden"><label for="installments" class="block text-xs font-medium text-gray-700">Parcelas</label><select id="installments" class="mt-1 block w-full rounded-lg p-2 shadow-sm"></select></div></div></div>
                            <div><label for="description" class="block text-xs font-medium text-gray-700">Descrição</label><textarea id="description" rows="2" class="mt-1 block w-full rounded-lg p-2 shadow-sm" placeholder="Ex: Salário, Jantar com amigos"></textarea></div>
                            <div id="transaction-alert-message" class="alert-message hidden"></div>
                            <div class="flex gap-2"><button type="button" id="cancel-edit-btn" class="w-1/3 py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 hidden">Cancelar</button><button type="submit" id="submit-btn" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar</button></div>
                        </form>
                    </div>

                    <!-- Formulário de Transação Recorrente -->
                    <div id="recurring-form-container" class="hidden">
                         <h2 class="text-xl font-bold text-gray-900 mb-4">Novo Recorrente</h2>
                         <form id="recurring-form" class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700">Tipo</label>
                                <div id="recurring-type-selector-main" class="flex space-x-2 mt-1">
                                    <div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="income">Entrada</div>
                                    <div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="expense">Saída</div>
                                    <div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="investment">Invest.</div>
                                </div>
                                <input type="hidden" id="recurring-type-main" value="expense" required>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label for="recurring-description-main" class="block text-xs font-medium text-gray-700">Descrição</label><input type="text" id="recurring-description-main" required class="mt-1 block w-full rounded-lg p-2 shadow-sm" placeholder="Ex: Aluguel"></div>
                                <div><label for="recurring-category-main" class="block text-xs font-medium text-gray-700">Categoria</label><select id="recurring-category-main" required class="mt-1 block w-full rounded-lg p-2 shadow-sm"></select></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 items-end">
                                <div><label for="recurring-value-main" class="block text-xs font-medium text-gray-700">Valor Fixo / Estimativa</label><input type="number" id="recurring-value-main" class="mt-1 block w-full rounded-lg p-2 shadow-sm" placeholder="0,00" step="0.01"></div>
                                <div class="flex items-center pb-2"><input type="checkbox" id="recurring-is-variable-main" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="recurring-is-variable-main" class="ml-2 block text-sm text-gray-900">Valor Variável</label></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label for="recurring-day-of-month-main" class="block text-xs font-medium text-gray-700">Dia do Lançamento</label><input type="number" id="recurring-day-of-month-main" required class="mt-1 block w-full rounded-lg p-2 shadow-sm" placeholder="Ex: 10" min="1" max="31"></div>
                                <div><label for="recurring-duration-main" class="block text-xs font-medium text-gray-700">Duração (meses)</label><input type="number" id="recurring-duration-main" class="mt-1 block w-full rounded-lg p-2 shadow-sm" placeholder="Em branco para sempre" min="1"></div>
                            </div>
                            <div id="recurring-payment-field-main">
                                <label for="recurring-payment-method-main" class="block text-xs font-medium text-gray-700">Forma de Pagamento</label>
                                <select id="recurring-payment-method-main" class="mt-1 block w-full rounded-lg p-2 shadow-sm">
                                    <option value="Débito em Conta">Débito em Conta</option><option value="Boleto">Boleto</option><option value="Cartão de Crédito">Cartão de Crédito</option><option value="Pix Programado">Pix Programado</option>
                                </select>
                            </div>
                            <div id="recurring-alert-message-main" class="alert-message hidden"></div>
                            <button type="submit" class="w-full py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Recorrente</button>
                        </form>
                    </div>
                </div>
                 <!-- Lançamentos Pendentes -->
                <div id="pending-transactions-card" class="container-card hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">Pendentes</h2>
                        <div class="flex flex-row items-center space-x-2">
                            <button id="prev-pending-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <span id="current-pending-month-display" class="text-sm font-medium text-gray-700 w-32 text-center"></span>
                            <button id="next-pending-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                        </div>
                    </div>
                    <div id="pending-transactions-list" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Coluna da Direita: Histórico e Visão Geral -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Dashboard do Mês (Visão Geral) -->
                <div class="container-card">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1"><h2 class="text-xl font-bold text-gray-900">Visão Geral do Mês</h2><button id="toggle-overview-balances-btn" class="p-2 rounded-full hover:bg-gray-200" title="Mostrar/Ocultar Saldos do Mês"></button></div>
                            <div class="flex flex-row items-center space-x-2"><button id="prev-overview-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><span id="current-overview-month-display" class="text-sm font-medium text-gray-700 w-32 text-center"></span><button id="next-overview-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button></div>
                        </div>
                        <div class="flex justify-end space-x-4 text-sm font-semibold mt-4 sm:mt-0">
                            <div id="income-summary-card" class="text-center interactive-card p-2 rounded-lg"><p class="text-sm text-gray-500">Entradas</p><p id="total-income" class="text-lg font-bold income-text">R$ 0,00</p></div>
                            <div id="expense-summary-card" class="text-center interactive-card p-2 rounded-lg"><p class="text-sm text-gray-500">Saídas</p><p id="total-expense" class="text-lg font-bold expense-text">R$ 0,00</p></div>
                            <div id="monthly-balance-card" class="text-center interactive-card p-2 rounded-lg"><p class="text-sm text-gray-500">Saldo do Mês</p><p id="monthly-balance" class="text-lg font-bold text-gray-800">R$ 0,00</p></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div><h3 class="text-md font-bold text-gray-800 mb-2">Gastos por Categoria</h3><div class="relative h-[280px]"><canvas id="expense-chart"></canvas></div></div>
                        <div class="space-y-4">
                            <div>
                                <h3 class="text-md font-bold text-gray-800 mb-2">Orçamentos do Mês</h3>
                                <div id="budgets-list" class="space-y-3 max-h-32 overflow-y-auto pr-2"></div>
                            </div>
                            <div class="border-t pt-4">
                                <h3 class="text-md font-bold text-gray-800 mb-2">Metas de Economia</h3>
                                <div id="goals-list" class="space-y-3 max-h-32 overflow-y-auto pr-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Histórico de Transações -->
                <div class="container-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">Histórico de Transações</h2>
                        <div class="flex gap-4">
                            <button id="manage-recurring-btn" class="text-indigo-600 text-sm font-semibold hover:text-indigo-800">Recorrentes</button>
                            <button id="import-btn" class="text-blue-600 text-sm font-semibold hover:text-blue-800">Importar</button>
                            <button id="export-btn" class="text-green-600 text-sm font-semibold hover:text-green-800">Exportar</button>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 items-center mb-2 p-2 bg-gray-50 rounded-lg"><div class="flex flex-row items-center space-x-2 flex-grow"><button id="prev-history-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><span id="current-history-month-display" class="text-sm font-medium text-gray-700 w-32 text-center"></span><button id="next-history-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button></div><select id="category-filter" class="flex-grow rounded-lg p-2 text-sm bg-white border border-gray-300"></select></div>
                    <div class="flex justify-end items-center mb-4 pr-2"><span class="text-sm font-semibold text-gray-600 mr-2">Total Filtrado:</span><span id="filtered-sum" class="text-lg font-bold text-gray-800">R$ 0,00</span></div>
                    <div id="transaction-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS -->
    <div id="settings-modal" class="modal hidden"></div>
    <div id="recurring-modal" class="modal hidden"></div>
    <div id="reports-modal" class="modal hidden"></div>
    <div id="details-modal" class="modal hidden"></div>
    <div id="forecast-modal" class="modal hidden"></div>
    <div id="input-modal" class="modal hidden"></div>
    <div id="ai-insights-modal" class="modal hidden"></div>
    <div id="import-modal" class="modal hidden"></div>
    <div id="debts-modal" class="modal hidden"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, getDoc, doc, setDoc, updateDoc, deleteDoc, writeBatch, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & STATE ---
        let db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let expenseChart, reportsChart, forecastChart;

        const state = {
            transactions: [],
            recurringTemplates: [],
            goals: [],
            debts: [],
            categories: { income: ['Salário', 'Freelance'], expense: ['Alimentação', 'Transporte', 'Moradia', 'Lazer', 'Pagamento de Dívidas', 'Financiamentos'], investment: ['Ações', 'Fundos Imobiliários'] },
            settings: { faturaDay: 20, budgets: {} },
            overviewSelectedDate: new Date(),
            historySelectedDate: new Date(),
            pendingSelectedDate: new Date(),
            isMainBalanceHidden: true,
            isOverviewBalanceHidden: true,
            isEditing: false,
            isEditingRecurring: false,
            editingRecurringId: null,
            selectedType: 'expense',
            filters: { category: 'all' }
        };

        const elements = {
            app: document.getElementById('app'),
            userId: document.getElementById('user-id'),
            totalBalance: document.getElementById('total-balance'),
            totalInvestment: document.getElementById('total-investment'),
            totalCreditCard: document.getElementById('total-credit-card'),
            totalDebts: document.getElementById('total-debts'),
            monthlyBalance: document.getElementById('monthly-balance'),
            totalIncome: document.getElementById('total-income'),
            totalExpense: document.getElementById('total-expense'),
            transactionForm: document.getElementById('transaction-form'),
            transactionIdInput: document.getElementById('transaction-id'),
            hiddenTypeInput: document.getElementById('type'),
            categorySelect: document.getElementById('category'),
            valueInput: document.getElementById('value'),
            dateInput: document.getElementById('date'),
            descriptionInput: document.getElementById('description'),
            expenseFields: document.getElementById('expense-fields'),
            paymentMethodSelect: document.getElementById('payment-method'),
            installmentsField: document.getElementById('installments-field'),
            installmentsSelect: document.getElementById('installments'),
            submitBtn: document.getElementById('submit-btn'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            transactionAlertMessage: document.getElementById('transaction-alert-message'),
            transactionListEl: document.getElementById('transaction-list'),
            currentOverviewMonthDisplay: document.getElementById('current-overview-month-display'),
            currentHistoryMonthDisplay: document.getElementById('current-history-month-display'),
            currentPendingMonthDisplay: document.getElementById('current-pending-month-display'),
            expenseChartCanvas: document.getElementById('expense-chart'),
            budgetsList: document.getElementById('budgets-list'),
            goalsList: document.getElementById('goals-list'),
            toggleMainBalancesBtn: document.getElementById('toggle-main-balances-btn'),
            toggleOverviewBalancesBtn: document.getElementById('toggle-overview-balances-btn'),
            categoryFilter: document.getElementById('category-filter'),
            filteredSum: document.getElementById('filtered-sum'),
            pendingTransactionsCard: document.getElementById('pending-transactions-card'),
            pendingTransactionsList: document.getElementById('pending-transactions-list'),
            settingsModal: document.getElementById('settings-modal'),
            recurringModal: document.getElementById('recurring-modal'),
            reportsModal: document.getElementById('reports-modal'),
            detailsModal: document.getElementById('details-modal'),
            forecastModal: document.getElementById('forecast-modal'),
            inputModal: document.getElementById('input-modal'),
            aiInsightsModal: document.getElementById('ai-insights-modal'),
            importModal: document.getElementById('import-modal'),
            debtsModal: document.getElementById('debts-modal'),
            showTransactionFormBtn: document.getElementById('show-transaction-form'),
            showRecurringFormBtn: document.getElementById('show-recurring-form'),
            transactionFormContainer: document.getElementById('transaction-form-container'),
            recurringFormContainer: document.getElementById('recurring-form-container'),
            recurringForm: document.getElementById('recurring-form'),
        };

        const icons = {
            eye: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7S3.732 16.057 2.458 12z" /></svg>`,
            eyeSlash: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.11 3.522-5.584 6.643-6.522M6.54 6.54L21 21m-4.56-4.56l-1.39-1.39a3 3 0 00-4.242-4.242L6.54 6.54z" /></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`
        };
        
        // --- UTILITY & FINANCE FUNCTIONS ---
        const formatCurrency = (value) => `R$ ${Number(value).toFixed(2).replace('.', ',')}`;
        const showAlert = (message, type, element) => { element.textContent = message; element.className = `alert-message alert-${type}`; element.classList.remove('hidden'); setTimeout(() => element.classList.add('hidden'), 3000); };
        const generateInstallmentOptions = (selectEl) => { selectEl.innerHTML = ''; for (let i = 1; i <= 24; i++) { const option = document.createElement('option'); option.value = i; option.textContent = `${i}x`; selectEl.appendChild(option); } };
        const setCurrentDate = () => { elements.dateInput.value = new Date().toISOString().slice(0, 10); };
        const openModal = (modalEl) => modalEl.classList.remove('hidden');
        const closeModal = (modalEl) => { modalEl.classList.add('hidden'); modalEl.innerHTML = ''; };
        
        const calculatePriceInstallment = (total, monthlyInterestRate, term) => {
            if (monthlyInterestRate <= 0) return total / term;
            const i = monthlyInterestRate / 100;
            return total * (i * Math.pow(1 + i, term)) / (Math.pow(1 + i, term) - 1);
        };
        
        const getDebtInstallmentForDate = (debt, targetDate) => {
            const startDate = new Date(debt.startDate + 'T12:00:00');
            const targetMonth = targetDate.getMonth();
            const targetYear = targetDate.getFullYear();

            const monthsDiff = (targetYear - startDate.getFullYear()) * 12 + (targetMonth - startDate.getMonth());

            if (monthsDiff >= 0 && monthsDiff < debt.installmentsTotal) {
                const installmentIdentifier = `${debt.id}-${targetYear}-${String(targetMonth + 1).padStart(2, '0')}`;
                const paymentExists = state.transactions.some(t => t.debtInstallmentId === installmentIdentifier);
                if (paymentExists) return 0;
                
                if (debt.amortizationType === 'price') {
                    return calculatePriceInstallment(debt.totalAmount, debt.interestRate, debt.installmentsTotal);
                } else { // SAC
                    const principalPerInstallment = debt.totalAmount / debt.installmentsTotal;
                    const remainingPrincipal = debt.totalAmount - (principalPerInstallment * monthsDiff);
                    const interest = remainingPrincipal * (debt.interestRate / 100);
                    return principalPerInstallment + interest; 
                }
            }
            return 0;
        };

        const markdownToHtml = (text) => {
            let html = text.replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>').replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-5 mb-3">$1</h2>').replace(/^# (.*$)/gim, '<h1 class="text-2xl font-extrabold mt-6 mb-4">$1</h1>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n\s*\n/g, '<br><br>').replace(/(\r\n|\n|\r)/gm, '<br>');
            html = html.replace(/<br>\s*-\s(.*?)(?=<br>|$)/g, '<li class="ml-4 list-disc">$1</li>');
            html = html.replace(/(<li.*?>.*?<\/li>)+/g, '<ul>$&</ul>');
            return html;
        };
        
        // --- FIREBASE & DATA INITIALIZATION ---
        const initializeAppAndListeners = async () => {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) await signInWithCustomToken(auth, token); else await signInAnonymously(auth);
                userId = auth.currentUser.uid;
                elements.userId.textContent = `ID do Utilizador: ${userId}`;
                
                onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/transactions`), s => { state.transactions = s.docs.map(d => ({ id: d.id, ...d.data() })); updateUI(); });
                onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/recurring_templates`), s => { state.recurringTemplates = s.docs.map(d => ({ id: d.id, ...d.data() })); updateUI(); });
                onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/goals`), s => { state.goals = s.docs.map(d => ({ id: d.id, ...d.data() })); updateUI(); });
                onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/debts`), s => { state.debts = s.docs.map(d => ({ id: d.id, ...d.data() })); updateUI(); });
                onSnapshot(doc(db, `/artifacts/${appId}/users/${userId}/settings`, 'user_settings'), async d => { if (d.exists()) Object.assign(state.settings, d.data()); else await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/settings`, 'user_settings'), state.settings); updateUI(); });
                onSnapshot(doc(db, `/artifacts/${appId}/users/${userId}/categories`, 'user_categories'), async d => { if (d.exists() && Object.keys(d.data()).length > 0) { state.categories = d.data(); } else { await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/categories`, 'user_categories'), state.categories); } updateUI(); });
            } catch (error) { console.error("Erro na inicialização:", error); }
        };

        // --- UI RENDERING ---
        const updateUI = () => { if (!userId) return; renderCategoryDropdown(); renderCategoryFilter(); renderTransactions(); updateAllBalances(); renderDashboard(); renderPendingTransactions(); };
        const renderDashboard = () => { elements.currentOverviewMonthDisplay.textContent = state.overviewSelectedDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }); const monthlyTransactions = state.transactions.filter(t => t.date && t.date.startsWith(state.overviewSelectedDate.toISOString().slice(0, 7))); updateExpenseChart(monthlyTransactions); renderBudgets(monthlyTransactions); renderGoals(); };
        const updateAllBalances = () => { let tI=0, tE=0, tInv=0, tCC=0; const tDebt=state.debts.reduce((sum,d)=>sum+d.remainingBalance,0); const today=new Date(); const cD=state.settings.faturaDay; const sD=new Date(today.getFullYear(),today.getMonth()-(today.getDate()>cD?0:1),cD+1); const eD=new Date(today.getFullYear(),today.getMonth()+(today.getDate()>cD?1:0),cD); state.transactions.forEach(t=>{const tD=t.date ? new Date(t.date+'T12:00:00') : new Date(); if(t.type==='income')tI+=t.value;else if(t.type==='expense'){tE+=t.value;if(t.paymentMethod==='Cartão de Crédito'&&tD>=sD&&tD<=eD)tCC+=t.value;}else if(t.type==='investment')tInv+=t.value;}); const tB=tI-tE-tInv; const overviewMonthStr = state.overviewSelectedDate.toISOString().slice(0, 7); let mI=0, mE=0, mInv=0; state.transactions.filter(t=>t.date && t.date.startsWith(overviewMonthStr)).forEach(t=>{if(t.type==='income')mI+=t.value;else if(t.type==='expense')mE+=t.value;else if(t.type==='investment')mInv+=t.value;}); elements.totalBalance.textContent=state.isMainBalanceHidden?'***':formatCurrency(tB); elements.totalInvestment.textContent=state.isMainBalanceHidden?'***':formatCurrency(tInv); elements.totalCreditCard.textContent=state.isMainBalanceHidden?'***':formatCurrency(tCC); elements.totalDebts.textContent=state.isMainBalanceHidden?'***':formatCurrency(tDebt); elements.totalIncome.textContent=state.isOverviewBalanceHidden?'***':formatCurrency(mI); elements.totalExpense.textContent=state.isOverviewBalanceHidden?'***':formatCurrency(mE); elements.monthlyBalance.textContent=state.isOverviewBalanceHidden?'***':formatCurrency(mI-mE-mInv);};
        const updateExpenseChart = (transactions) => { const eD = transactions.filter(t => t.type === 'expense').reduce((a, t) => { a[t.category] = (a[t.category] || 0) + t.value; return a; }, {}); const l = Object.keys(eD); const d = Object.values(eD); const cD = { labels: l.length ? l : ['Sem Saídas'], datasets: [{ data: d.length ? d : [1], backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981'], borderColor: '#fff', borderWidth: 2 }] }; if (expenseChart) { expenseChart.data = cD; expenseChart.update(); } else if (elements.expenseChartCanvas) { expenseChart = new Chart(elements.expenseChartCanvas, { type: 'doughnut', data: cD, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 12 } } } } }); } };
        const renderCategoryDropdown = (selectEl = elements.categorySelect, type = state.selectedType) => { const cats = state.categories[type] || []; selectEl.innerHTML = cats.map(cat => `<option value="${cat}">${cat}</option>`).join('') || `<option value="">Crie uma categoria</option>`; };
        const renderCategoryFilter = () => { const allCategories = [...(state.categories.income || []), ...(state.categories.expense || []), ...(state.categories.investment || [])]; const uniqueCategories = [...new Set(allCategories)].sort((a,b) => a.localeCompare(b)); elements.categoryFilter.innerHTML = `<option value="all">Todas as Categorias</option>`; uniqueCategories.forEach(cat => { elements.categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`; }); };
        
        const renderBudgets = (monthlyTransactions) => {
            elements.budgetsList.innerHTML = '';
            const budgets = state.settings.budgets || {};
            if (Object.keys(budgets).length === 0) { elements.budgetsList.innerHTML = '<p class="text-center text-gray-500 text-sm">Crie orçamentos nas Configurações.</p>'; return; }

            const expensesByCategory = monthlyTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.value; return acc; }, {});

            Object.entries(budgets).forEach(([category, budgetValue]) => {
                const spentAmount = expensesByCategory[category] || 0;
                let committedAmount = 0;
                
                if (category === 'Pagamento de Dívidas' || category === 'Financiamentos') { state.debts.forEach(debt => { committedAmount += getDebtInstallmentForDate(debt, state.overviewSelectedDate); }); }
                
                const postedRecurringIds = new Set(monthlyTransactions.filter(t => t.recurringTemplateId).map(t => t.recurringTemplateId));
                state.recurringTemplates.forEach(rec => { if (rec.type === 'expense' && rec.category === category && !postedRecurringIds.has(rec.id)) { committedAmount += rec.value; } });
                
                const totalUsed = spentAmount + committedAmount;
                const spentPercentage = budgetValue > 0 ? (spentAmount / budgetValue) * 100 : 0;
                const committedPercentage = budgetValue > 0 ? (committedAmount / budgetValue) * 100 : 0;
                const progressBarColor = totalUsed > budgetValue ? 'bg-red-500' : totalUsed > budgetValue * 0.8 ? 'bg-yellow-500' : 'bg-green-500';

                const el = document.createElement('div');
                el.className = 'budget-item-card interactive-card p-2 -m-2 rounded-lg';
                el.dataset.category = category;
                // --- ATUALIZADO: Mostra o valor total previsto (gasto + pendente) ---
                el.innerHTML = `
                    <div class="flex justify-between items-center text-sm mb-1">
                        <span class="font-semibold text-gray-700">${category}</span>
                        <span class="text-xs ${totalUsed > budgetValue ? 'expense-text' : 'text-gray-600'} font-semibold">
                            ${formatCurrency(totalUsed)} / ${formatCurrency(budgetValue)}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress ${progressBarColor}" style="width: ${Math.min(spentPercentage, 100)}%;"></div>
                        <div class="progress progress-committed" style="width: ${Math.min(committedPercentage, 100 - spentPercentage)}%;"></div>
                    </div>`;
                elements.budgetsList.appendChild(el);
            });
        };

        const renderGoals = () => { elements.goalsList.innerHTML = ''; if (!state.goals.length) { elements.goalsList.innerHTML = '<p class="text-center text-gray-500 text-sm">Crie metas de economia nas Configurações.</p>'; return; } const totalInvested = state.transactions.filter(t => t.type === 'investment').reduce((sum, t) => sum + t.value, 0); state.goals.forEach(goal => { const savedAmount = Math.min(totalInvested, goal.targetValue); const percentage = goal.targetValue > 0 ? (savedAmount / goal.targetValue) * 100 : 0; const el = document.createElement('div'); el.innerHTML = `<div class="flex justify-between items-center text-sm mb-1"><span class="font-semibold text-gray-700">${goal.name}</span><span class="text-xs goal-text">${formatCurrency(savedAmount)} / ${formatCurrency(goal.targetValue)}</span></div><div class="progress-bar"><div class="progress bg-amber-500" style="width: ${percentage}%;"></div></div>`; elements.goalsList.appendChild(el); }); };
        const getFilteredTransactions = () => state.transactions.filter(t => (t.date && t.date.startsWith(state.historySelectedDate.toISOString().slice(0, 7))) && (state.filters.category === 'all' || t.category === state.filters.category)).sort((a, b) => new Date(b.date) - new Date(a.date));
        const renderTransactions = () => { elements.currentHistoryMonthDisplay.textContent = state.historySelectedDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }); const filtered = getFilteredTransactions(); const filteredTotal = filtered.reduce((sum, t) => (t.type === 'income' ? sum + t.value : sum - t.value), 0); elements.filteredSum.textContent = formatCurrency(filteredTotal); elements.filteredSum.classList.toggle('income-text', filteredTotal >= 0); elements.filteredSum.classList.toggle('expense-text', filteredTotal < 0); elements.transactionListEl.innerHTML = ''; if (!filtered.length) { elements.transactionListEl.innerHTML = '<p class="text-center text-gray-500 text-sm py-8">Nenhuma transação encontrada.</p>'; return; } filtered.forEach(t => { const vC = t.type === 'income' ? 'income-text' : t.type === 'expense' ? 'expense-text' : 'investment-text'; const bC = t.type === 'income' ? 'income-bg' : t.type === 'expense' ? 'expense-bg' : 'investment-bg'; const i = t.type === 'income' ? '↑' : t.type === 'expense' ? '↓' : '📈'; const fV = (t.type !== 'income' ? `- ` : `+ `) + formatCurrency(t.value); const tE = document.createElement('div'); tE.className = `flex justify-between items-center p-3 rounded-lg ${bC} group`; tE.dataset.id = t.id; tE.innerHTML = `<div class="flex items-center space-x-3 flex-1"><span class="text-xl ${vC}">${i}</span><div><p class="font-semibold text-gray-900 text-sm">${t.description||'N/A'}</p><p class="text-xs text-gray-500">${t.category||'N/A'} - ${t.date ? new Date(t.date+'T12:00:00').toLocaleDateString('pt-BR') : 'Data Inválida'}</p></div></div><div class="flex items-center space-x-2"><div class="text-sm font-bold ${vC} mr-2">${fV}</div><div class="flex opacity-0 group-hover:opacity-100 transition-opacity"><button class="edit-btn p-1 rounded-full hover:bg-gray-300" data-id="${t.id}"><svg class="h-4 w-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button><button class="delete-btn p-1 rounded-full hover:bg-gray-300" data-id="${t.id}"><svg class="h-4 w-4 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div></div>`; elements.transactionListEl.appendChild(tE); }); };
        const resetTransactionForm = () => { elements.transactionForm.reset(); elements.transactionIdInput.value=''; state.isEditing=false; elements.submitBtn.textContent='Adicionar'; elements.cancelEditBtn.classList.add('hidden'); elements.submitBtn.classList.remove('w-2/3'); elements.submitBtn.classList.add('w-full'); setCurrentDate(); updateFormColor('expense'); };
        const updateFormColor = (type) => { state.selectedType=type; elements.hiddenTypeInput.value=type; document.querySelectorAll('#type-selector > div').forEach(el=>{el.classList.remove('bg-green-500','bg-red-500','bg-blue-500','text-white','font-semibold'); el.classList.add('bg-gray-200','text-gray-800');}); const sE=document.querySelector(`#type-selector [data-type="${type}"]`); sE.classList.add(type==='income'?'bg-green-500':type==='expense'?'bg-red-500':'bg-blue-500','text-white','font-semibold'); elements.expenseFields.classList.toggle('hidden',type!=='expense'); renderCategoryDropdown(); };
        const renderPendingTransactions = () => {
            const selectedDate = state.pendingSelectedDate;
            elements.currentPendingMonthDisplay.textContent = selectedDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            let pendingItems = [];
            const postedRecurringIds = new Set(state.transactions.filter(t => t.recurringTemplateId && t.date.startsWith(selectedDate.toISOString().slice(0, 7))).map(t => t.recurringTemplateId));
            state.recurringTemplates.filter(t => {
                if (postedRecurringIds.has(t.id)) return false;
                const startDate = t.createdAt?.toDate() || new Date(1970, 0, 1);
                if (startDate > selectedDate) return false;
                if (t.durationMonths) { const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + t.durationMonths, startDate.getDate()); if (selectedDate > endDate) return false; }
                return true;
            }).forEach(t => pendingItems.push({ ...t, pendingType: 'recurring' }));
            state.debts.forEach(d => {
                const installmentValue = getDebtInstallmentForDate(d, selectedDate);
                if (installmentValue > 0) { pendingItems.push({ id: d.id, description: `Parcela: ${d.name}`, value: installmentValue, isVariable: false, type: 'expense', pendingType: 'debt' }); }
            });
            if (pendingItems.length === 0) { elements.pendingTransactionsList.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">Nenhum lançamento pendente encontrado para este mês.</p>'; elements.pendingTransactionsCard.classList.remove('hidden'); return; }
            elements.pendingTransactionsCard.classList.remove('hidden');
            elements.pendingTransactionsList.innerHTML = pendingItems.map(item => { let valueDisplay = item.isVariable ? `<span class="text-xs text-blue-600">Valor Variável${item.value > 0 ? ` (Est. ${formatCurrency(item.value)})` : ''}</span>` : formatCurrency(item.value); const bgClass = item.type === 'income' ? 'income-bg' : item.type === 'expense' ? 'expense-bg' : 'investment-bg'; const buttonText = item.pendingType === 'debt' ? 'Pagar' : 'Lançar'; return `<div class="p-3 rounded-lg ${bgClass} flex justify-between items-center" data-pending-type="${item.pendingType}" data-template-id="${item.id}"><div><p class="font-semibold text-sm">${item.description}</p><p class="text-xs text-gray-600">${valueDisplay}</p></div><button class="post-pending-btn text-sm bg-indigo-500 text-white py-1 px-3 rounded-lg hover:bg-indigo-600">${buttonText}</button></div>`; }).join('');
        };
        
        // --- MODAL RENDERING FUNCTIONS ---
        const renderDebtsModal = () => {
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            const debtsListHTML = state.debts.length > 0 ? state.debts.map(debt => { const paidAmount = debt.totalAmount - debt.remainingBalance; const percentage = (paidAmount / debt.totalAmount) * 100; return `<div class="p-4 rounded-lg debt-bg space-y-2"><div class="flex justify-between items-start"><div><p class="font-bold text-gray-800">${debt.name} (${debt.amortizationType.toUpperCase()})</p><p class="text-sm debt-text font-semibold">${formatCurrency(debt.remainingBalance)} <span class="text-xs text-gray-500 font-normal">restantes de ${formatCurrency(debt.totalAmount)}</span></p></div><div class="flex gap-2"><button class="register-payment-btn text-sm bg-purple-600 text-white font-semibold py-1 px-3 rounded-lg hover:bg-purple-700" data-id="${debt.id}">Lançar Pagamento</button><button class="delete-debt-btn p-1 rounded-full hover:bg-gray-200" data-id="${debt.id}">${icons.trash}</button></div></div><div><div class="flex justify-between items-center text-xs text-gray-600 mb-1"><span>Progresso (${debt.installmentsPaid} / ${debt.installmentsTotal})</span><span>${percentage.toFixed(1)}%</span></div><div class="progress-bar"><div class="progress bg-purple-500" style="width: ${percentage}%;"></div></div></div></div>` }).join('') : '<p class="text-center text-gray-500 text-sm py-4">Nenhuma dívida cadastrada.</p>';
            modalContent.innerHTML = `<span class="close-btn">&times;</span><h2 class="text-2xl font-bold mb-4">Gerenciar Dívidas e Financiamentos</h2><div id="debts-list" class="space-y-4 mb-6 max-h-60 overflow-y-auto pr-2">${debtsListHTML}</div><div class="border-t pt-4"><h3 class="text-xl font-bold text-gray-900 mb-4">Adicionar Nova Dívida</h3><form id="debt-form" class="space-y-3"><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div><label for="debt-name" class="block text-xs font-medium text-gray-700">Descrição</label><input type="text" id="debt-name" required class="mt-1 block w-full rounded-lg p-2" placeholder="Ex: Financiamento do Carro"></div><div><label for="debt-total-amount" class="block text-xs font-medium text-gray-700">Valor Total Financiado</label><input type="number" id="debt-total-amount" required class="mt-1 block w-full rounded-lg p-2" placeholder="25000,00" step="0.01"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div><label for="debt-installments-total" class="block text-xs font-medium text-gray-700">Total de Parcelas</label><input type="number" id="debt-installments-total" required class="mt-1 block w-full rounded-lg p-2" placeholder="36" min="1"></div><div><label for="debt-start-date" class="block text-xs font-medium text-gray-700">Data da 1ª Parcela</label><input type="date" id="debt-start-date" required class="mt-1 block w-full rounded-lg p-2"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><div><label for="debt-amortization-type" class="block text-xs font-medium text-gray-700">Tipo de Amortização</label><select id="debt-amortization-type" class="mt-1 block w-full rounded-lg p-2"><option value="price">Price</option><option value="sac">SAC</option></select></div><div id="debt-interest-rate-field"><label for="debt-interest-rate" class="block text-xs font-medium text-gray-700">Taxa de Juros (% a.m.)</label><input type="number" id="debt-interest-rate" class="mt-1 block w-full rounded-lg p-2" placeholder="1.99" step="0.01" required></div></div><div id="debt-alert-message" class="alert-message hidden"></div><button type="submit" class="w-full py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Adicionar Dívida</button></form></div>`;
            elements.debtsModal.innerHTML = '';
            elements.debtsModal.appendChild(modalContent);
            document.getElementById('debt-start-date').value = new Date().toISOString().slice(0, 10);
            openModal(elements.debtsModal);
        };
        const renderRecurringModalContent = (isEditing = false) => {
            const itemToEdit = isEditing ? state.recurringTemplates.find(t => t.id === state.editingRecurringId) : null;
            let contentHTML = '';
            if (isEditing) { contentHTML = `<h2 class="text-2xl font-bold mb-4">Editar Recorrente</h2><form id="recurring-form-modal" class="space-y-3 mb-6 p-4 border rounded-lg bg-gray-50"><input type="hidden" id="recurring-id-modal" value="${itemToEdit?.id || ''}"><div><label class="block text-xs font-medium text-gray-700">Tipo</label><div id="recurring-type-selector-modal" class="flex space-x-2 mt-1"><div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="income">Entrada</div><div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="expense">Saída</div><div class="flex-1 py-2 px-4 text-center rounded-lg shadow-sm cursor-pointer" data-type="investment">Invest.</div></div><input type="hidden" id="recurring-type-modal" value="${itemToEdit?.type || 'expense'}" required></div><div class="grid grid-cols-2 gap-3"><div><label for="recurring-description-modal" class="block text-xs font-medium text-gray-700">Descrição</label><input type="text" id="recurring-description-modal" value="${itemToEdit?.description || ''}" required class="mt-1 block w-full rounded-lg p-2 shadow-sm"></div><div><label for="recurring-category-modal" class="block text-xs font-medium text-gray-700">Categoria</label><select id="recurring-category-modal" required class="mt-1 block w-full rounded-lg p-2 shadow-sm"></select></div></div><div class="grid grid-cols-2 gap-3 items-end"><div><label for="recurring-value-modal" class="block text-xs font-medium text-gray-700">Valor Fixo / Estimativa</label><input type="number" id="recurring-value-modal" value="${itemToEdit?.value || ''}" class="mt-1 block w-full rounded-lg p-2 shadow-sm" step="0.01"></div><div class="flex items-center pb-2"><input type="checkbox" id="recurring-is-variable-modal" ${itemToEdit?.isVariable ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><label for="recurring-is-variable-modal" class="ml-2 block text-sm text-gray-900">Valor Variável</label></div></div><div class="grid grid-cols-2 gap-3"><div><label for="recurring-day-of-month-modal" class="block text-xs font-medium text-gray-700">Dia do Lançamento</label><input type="number" id="recurring-day-of-month-modal" value="${itemToEdit?.dayOfMonth || ''}" required class="mt-1 block w-full rounded-lg p-2 shadow-sm" min="1" max="31"></div><div><label for="recurring-duration-modal" class="block text-xs font-medium text-gray-700">Duração (meses)</label><input type="number" id="recurring-duration-modal" value="${itemToEdit?.durationMonths || ''}" class="mt-1 block w-full rounded-lg p-2 shadow-sm" min="1"></div></div><div id="recurring-payment-field-modal" class="${(itemToEdit?.type || 'expense') !== 'expense' ? 'hidden' : ''}"><label for="recurring-payment-method-modal" class="block text-xs font-medium text-gray-700">Forma de Pagamento</label><select id="recurring-payment-method-modal" class="mt-1 block w-full rounded-lg p-2 shadow-sm"><option value="Débito em Conta">Débito em Conta</option> <option value="Boleto">Boleto</option> <option value="Cartão de Crédito">Cartão de Crédito</option> <option value="Pix Programado">Pix Programado</option></select></div><div id="recurring-alert-message-modal" class="alert-message hidden"></div><div class="flex gap-2 pt-2"><button type="button" id="cancel-recurring-edit-btn" class="w-1/3 py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button><button type="submit" class="w-full py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar Alterações</button></div></form>`; }
            else { contentHTML = `<h2 class="text-2xl font-bold mb-4">Gerenciar Recorrentes</h2><div id="recurring-list-modal" class="space-y-2 max-h-[70vh] overflow-y-auto pr-2">${state.recurringTemplates.length ? state.recurringTemplates.map(t => { const durationText = t.durationMonths ? `${t.durationMonths} meses` : 'Contínuo'; const dayText = `Dia ${t.dayOfMonth}`; const valueText = t.isVariable ? `Variável (Est. ${formatCurrency(t.value)})` : formatCurrency(t.value); const bgClass = t.type === 'income' ? 'income-bg' : t.type === 'expense' ? 'expense-bg' : 'investment-bg'; return `<div class="flex justify-between items-center p-3 rounded-lg ${bgClass}"><div><p class="font-semibold text-sm">${t.description}</p><p class="text-xs text-gray-600">${t.category} | ${valueText}</p><p class="text-xs text-gray-500 mt-1">${dayText} | ${durationText}</p></div><div class="flex"><button class="edit-recurring-btn p-1 rounded-full hover:bg-gray-300" data-id="${t.id}"><svg class="h-4 w-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg></button><button class="delete-recurring-btn p-1 rounded-full hover:bg-gray-300" data-id="${t.id}"><svg class="h-4 w-4 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button></div></div>`; }).join('') : '<p class="text-center text-gray-500 text-sm py-8">Nenhum lançamento recorrente salvo.</p>'}</div>`; }
            elements.recurringModal.innerHTML = `<div class="modal-content relative"><span class="close-btn">&times;</span>${contentHTML}</div>`;
            if (isEditing) { const type = itemToEdit?.type || 'expense'; const typeSelector = document.querySelector(`#recurring-type-selector-modal [data-type="${type}"]`); document.querySelectorAll('#recurring-type-selector-modal > div').forEach(el => { el.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500', 'text-white', 'font-semibold'); el.classList.add('bg-gray-200', 'text-gray-800'); }); typeSelector.classList.add(type === 'income' ? 'bg-green-500' : type === 'expense' ? 'bg-red-500' : 'bg-blue-500', 'text-white', 'font-semibold'); const categorySelect = document.getElementById('recurring-category-modal'); renderCategoryDropdown(categorySelect, type); categorySelect.value = itemToEdit.category; if (itemToEdit.paymentMethod) { document.getElementById('recurring-payment-method-modal').value = itemToEdit.paymentMethod; } }
        };

        // --- ATUALIZADO: Modal de detalhes agora mostra lançamentos realizados E pendentes ---
        const openDetailsModal = (type, options = {}) => {
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content relative';
            let title = ''; 
            let transactionsToShow = [];
            let pendingItemsToShow = [];
            const overviewMonthFilter = t => t.date && t.date.startsWith(state.overviewSelectedDate.toISOString().slice(0, 7));

            switch(type) {
                // (outros cases permanecem os mesmos)
                case 'balance': title = 'Detalhes do Saldo'; transactionsToShow = state.transactions; break;
                case 'investment': title = 'Detalhes de Investimentos'; transactionsToShow = state.transactions.filter(t => t.type === 'investment'); break;
                case 'credit-card': title = 'Fatura Atual do Cartão'; const today=new Date(); const cD=state.settings.faturaDay; const sD=new Date(today.getFullYear(),today.getMonth()-(today.getDate()>cD?0:1),cD+1); const eD=new Date(today.getFullYear(),today.getMonth()+(today.getDate()>cD?1:0),cD); transactionsToShow = state.transactions.filter(t => { const tD = t.date ? new Date(t.date+'T12:00:00') : null; return t.paymentMethod === 'Cartão de Crédito' && tD && tD >= sD && tD <= eD; }); break;
                case 'income': title = 'Entradas do Mês'; transactionsToShow = state.transactions.filter(t => overviewMonthFilter(t) && t.type === 'income'); break;
                case 'expense': title = 'Saídas do Mês'; transactionsToShow = state.transactions.filter(t => overviewMonthFilter(t) && t.type === 'expense'); break;
                
                case 'budget-category':
                    const category = options.category;
                    title = `Gastos em "${category}"`;
                    transactionsToShow = state.transactions.filter(t => overviewMonthFilter(t) && t.type === 'expense' && t.category === category);

                    // Lógica para encontrar pendentes da categoria
                    const monthlyTransactions = state.transactions.filter(overviewMonthFilter);
                    const postedRecurringIds = new Set(monthlyTransactions.filter(t => t.recurringTemplateId).map(t => t.recurringTemplateId));
                    state.recurringTemplates.forEach(rec => {
                        if (rec.type === 'expense' && rec.category === category && !postedRecurringIds.has(rec.id)) {
                            pendingItemsToShow.push({ description: rec.description, value: rec.value });
                        }
                    });
                     if (category === 'Pagamento de Dívidas' || category === 'Financiamentos') {
                        state.debts.forEach(debt => {
                            const installmentValue = getDebtInstallmentForDate(debt, state.overviewSelectedDate);
                            if (installmentValue > 0) {
                                pendingItemsToShow.push({ description: `Parcela: ${debt.name}`, value: installmentValue });
                            }
                        });
                    }
                    break;
                default: title = 'Detalhes'; transactionsToShow = [];
            }
            
            const renderList = (items, isPending = false) => {
                if (items.length === 0) return `<p class="text-sm text-gray-500">Nenhum lançamento.</p>`;
                return items.map(item => `
                    <div class="flex justify-between p-2 rounded ${isPending ? 'bg-gray-100' : (item.type === 'expense' ? 'expense-bg' : 'income-bg')}">
                        <p class="text-gray-800">${item.description}</p>
                        <p class="font-semibold ${isPending ? 'text-gray-600' : (item.type === 'expense' ? 'expense-text' : 'income-text')}">${formatCurrency(item.value)}</p>
                    </div>`).join('');
            };

            let modalHTML = `<span class="close-btn">&times;</span><h2 class="text-2xl font-bold mb-4">${title}</h2><div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">`;
            
            if (type === 'budget-category') {
                modalHTML += `<div><h3 class="font-semibold text-gray-800 text-md mb-2">Lançamentos Realizados</h3>${renderList(transactionsToShow)}</div>`;
                if(pendingItemsToShow.length > 0) {
                   modalHTML += `<div><h3 class="font-semibold text-gray-800 text-md mb-2 mt-4">Lançamentos Pendentes</h3>${renderList(pendingItemsToShow, true)}</div>`;
                }
            } else {
                modalHTML += renderList(transactionsToShow);
            }

            modalHTML += '</div>';
            modalContent.innerHTML = modalHTML;

            elements.detailsModal.innerHTML = '';
            elements.detailsModal.appendChild(modalContent);
            openModal(elements.detailsModal);
        };

        const renderReportsModal = () => { const modalContent = document.createElement('div'); modalContent.className = 'modal-content relative'; modalContent.innerHTML = `<span class="close-btn">&times;</span><h2 class="text-2xl font-bold mb-4">Relatórios</h2><div class="h-96"><canvas id="reports-chart"></canvas></div>`; elements.reportsModal.innerHTML = ''; elements.reportsModal.appendChild(modalContent); const ctx = document.getElementById('reports-chart').getContext('2d'); const data = { labels: [], datasets: [{ label: 'Entradas', data: [], backgroundColor: '#16a34a' }, { label: 'Saídas', data: [], backgroundColor: '#dc2626' }] }; for(let i=5; i>=0; i--) { const d = new Date(); d.setMonth(d.getMonth()-i); const monthStr = d.toISOString().slice(0, 7); data.labels.push(d.toLocaleDateString('pt-BR', {month: 'short'})); const monthTransactions = state.transactions.filter(t => t.date && t.date.startsWith(monthStr)); data.datasets[0].data.push(monthTransactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.value,0)); data.datasets[1].data.push(monthTransactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.value,0)); } if(reportsChart) reportsChart.destroy(); reportsChart = new Chart(ctx, { type: 'bar', data, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); };
        const renderSettingsModal = () => { const modalContent = document.createElement('div'); modalContent.className = 'modal-content relative'; const renderCategoryManager = (title, type) => { const categories = state.categories[type] || []; return `<div class="border-t pt-4"><h3 class="text-lg font-semibold mb-2">${title}</h3><form class="add-category-form flex gap-2 mb-2"><input type="hidden" name="type" value="${type}"><input name="name" class="flex-grow rounded-lg p-2 shadow-sm" placeholder="Nova categoria..." required><button type="submit" class="bg-indigo-600 text-white px-4 rounded-lg text-sm font-semibold hover:bg-indigo-700">Adicionar</button></form><div class="space-y-1 max-h-32 overflow-y-auto pr-2">${categories.map(cat => `<div class="flex justify-between items-center p-2 bg-gray-100 rounded text-sm"><span>${cat}</span><button class="delete-category-btn p-1" data-category-name="${cat}" data-category-type="${type}">${icons.trash}</button></div>`).join('')}</div></div>`; }; modalContent.innerHTML = `<span class="close-btn">&times;</span><h2 class="text-2xl font-bold mb-4">Configurações</h2><div class="space-y-6"><div><label for="fatura-day" class="block text-sm font-medium text-gray-700">Dia de Fechamento da Fatura</label><input type="number" id="fatura-day" value="${state.settings.faturaDay}" class="mt-1 block w-full rounded-lg p-2 shadow-sm" min="1" max="31"></div>${renderCategoryManager('Categorias de Entradas', 'income')}${renderCategoryManager('Categorias de Saídas', 'expense')}${renderCategoryManager('Categorias de Investimentos', 'investment')}<div class="border-t pt-4"><h3 class="text-lg font-semibold mb-2">Orçamentos Mensais</h3><div id="budgets-settings-list" class="space-y-2 max-h-32 overflow-y-auto pr-2">${(state.categories.expense || []).map(cat => `<div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm">${cat}</label><input type="number" data-category="${cat}" value="${state.settings.budgets[cat] || ''}" class="block w-full rounded-lg p-2 shadow-sm" placeholder="R$ 0,00"></div>`).join('')}</div></div><div class="border-t pt-4"><h3 class="text-lg font-semibold mb-2">Metas de Economia</h3><form id="goal-form" class="flex gap-2 mb-2"><input id="goal-name" class="flex-grow rounded-lg p-2" placeholder="Nome da Meta" required><input type="number" id="goal-value" class="w-32 rounded-lg p-2" placeholder="Valor" required><button type="submit" class="bg-indigo-600 text-white px-3 rounded-lg">Criar</button></form><div id="goals-settings-list" class="space-y-2">${state.goals.map(g => `<div class="flex justify-between items-center p-2 bg-gray-100 rounded"><span>${g.name} - ${formatCurrency(g.targetValue)}</span><button class="delete-goal-btn text-red-500 font-bold" data-id="${g.id}">X</button></div>`).join('')}</div></div><div id="settings-alert" class="alert-message hidden"></div><button id="save-settings-btn" class="w-full py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Salvar Configurações</button></div>`; elements.settingsModal.innerHTML = ''; elements.settingsModal.appendChild(modalContent); };
        const renderForecastModal = () => { const modalContent = document.createElement('div'); modalContent.className = 'modal-content relative'; modalContent.innerHTML = `<span class="close-btn">&times;</span><h2 class="text-2xl font-bold mb-4">Previsão Financeira Futura</h2><div class="flex border-b mb-4"><button id="forecast-tab-standard" class="tab-btn flex-1 text-center font-semibold active">Previsão Padrão</button><button id="forecast-tab-whatif" class="tab-btn flex-1 text-center font-semibold">Análise "E se?"</button></div><div id="forecast-standard-content"><div id="forecast-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center p-4 bg-gray-50 rounded-lg mb-4"></div><div class="relative h-80"><canvas id="forecast-chart"></canvas></div><div id="forecast-details" class="mt-4 max-h-48 overflow-y-auto"></div></div><div id="forecast-whatif-content" class="hidden"><p class="text-sm text-gray-600 mb-4">Adicione um gasto ou investimento pontual ou recorrente para ver o impacto na sua previsão de saldo.</p><form id="whatif-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end p-4 border rounded-lg bg-gray-50"><div><label for="whatif-desc" class="text-xs font-medium">Descrição</label><input type="text" id="whatif-desc" class="w-full mt-1 p-2 rounded" placeholder="Ex: Viagem" required></div><div><label for="whatif-value" class="text-xs font-medium">Valor (mensal)</label><input type="number" id="whatif-value" class="w-full mt-1 p-2 rounded" placeholder="250,00" required></div><div><label for="whatif-duration" class="text-xs font-medium">Duração (meses)</label><input type="number" id="whatif-duration" class="w-full mt-1 p-2 rounded" value="1" min="1" required></div><button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 w-full">Simular</button></form><div id="whatif-impact" class="mt-4 text-center p-4 bg-blue-50 rounded-lg hidden"></div></div>`; elements.forecastModal.innerHTML = ''; elements.forecastModal.appendChild(modalContent); const standardTab = document.getElementById('forecast-tab-standard'); const whatifTab = document.getElementById('forecast-tab-whatif'); const standardContent = document.getElementById('forecast-standard-content'); const whatifContent = document.getElementById('forecast-whatif-content'); standardTab.addEventListener('click', () => { standardTab.classList.add('active'); whatifTab.classList.remove('active'); standardContent.classList.remove('hidden'); whatifContent.classList.add('hidden'); }); whatifTab.addEventListener('click', () => { whatifTab.classList.add('active'); standardTab.classList.remove('active'); whatifContent.classList.remove('hidden'); standardContent.classList.add('hidden'); }); generateAndRenderForecast(); document.getElementById('whatif-form').addEventListener('submit', (e) => { e.preventDefault(); const desc = document.getElementById('whatif-desc').value; const value = parseFloat(document.getElementById('whatif-value').value); const duration = parseInt(document.getElementById('whatif-duration').value); if (desc && !isNaN(value) && !isNaN(duration)) { const whatIfScenario = { desc, value, duration, startMonth: 0 }; generateAndRenderForecast(whatIfScenario); standardTab.click(); } }); };
        const generateAndRenderForecast = (whatIfScenario = null) => { const forecastSummaryEl = document.getElementById('forecast-summary'); const forecastDetailsEl = document.getElementById('forecast-details'); const ctx = document.getElementById('forecast-chart').getContext('2d'); const recurringIncome = state.recurringTemplates.filter(t => t.type === 'income').reduce((s, t) => s + t.value, 0); const recurringExpense = state.recurringTemplates.filter(t => t.type === 'expense').reduce((s, t) => s + t.value, 0); const recurringInvestment = state.recurringTemplates.filter(t => t.type === 'investment').reduce((s, t) => s + t.value, 0); const budgetTotal = Object.values(state.settings.budgets || {}).reduce((s, v) => s + v, 0); const historicalIncomes = {}; state.transactions.forEach(t => { if(t.type === 'income' && t.date && !state.recurringTemplates.some(rec => rec.description === t.description)) { const month = t.date.slice(0, 7); historicalIncomes[month] = (historicalIncomes[month] || 0) + t.value; } }); const last6MonthsIncomes = Object.values(historicalIncomes).slice(-6); const avgVariableIncome = last6MonthsIncomes.length > 0 ? last6MonthsIncomes.reduce((s, v) => s + v, 0) / last6MonthsIncomes.length : 0; const monthlyProjectedIncome = recurringIncome + avgVariableIncome; const monthlyProjectedExpense = recurringExpense + budgetTotal; const monthlyProjectedInvestment = recurringInvestment; const monthlyNetAvg = monthlyProjectedIncome - monthlyProjectedExpense - monthlyProjectedInvestment; forecastSummaryEl.innerHTML = `<div><p class="text-xs text-gray-500">Renda Mensal Média</p><p class="font-bold text-lg income-text">${formatCurrency(monthlyProjectedIncome)}</p></div><div><p class="text-xs text-gray-500">Despesa Mensal Média</p><p class="font-bold text-lg expense-text">${formatCurrency(monthlyProjectedExpense)}</p></div><div><p class="text-xs text-gray-500">Invest. Mensal Médio</p><p class="font-bold text-lg investment-text">${formatCurrency(monthlyProjectedInvestment)}</p></div><div><p class="text-xs text-gray-500">Saldo Mensal Médio</p><p class="font-bold text-lg ${monthlyNetAvg >= 0 ? 'text-gray-800' : 'expense-text'}">${formatCurrency(monthlyNetAvg)}</p></div>`; const currentBalance = state.transactions.reduce((acc, t) => (t.type === 'income' ? acc + t.value : acc - t.value), 0); const labels = []; const baseProjectionData = []; const whatIfProjectionData = []; let projectedBalance = currentBalance; let whatIfBalance = currentBalance; forecastDetailsEl.innerHTML = `<table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-4 py-2">Mês</th><th class="px-4 py-2 text-right">Entradas</th><th class="px-4 py-2 text-right">Saídas</th><th class="px-4 py-2 text-right">Saldo Final</th></tr></thead><tbody></tbody></table>`; const tableBody = forecastDetailsEl.querySelector('tbody'); for (let i = 1; i <= 12; i++) { const futureDate = new Date(); futureDate.setMonth(futureDate.getMonth() + i); labels.push(futureDate.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' })); let debtPaymentsThisMonth = 0; state.debts.forEach(debt => { debtPaymentsThisMonth += getDebtInstallmentForDate(debt, futureDate); }); const monthlyTotalExpense = monthlyProjectedExpense + debtPaymentsThisMonth; const monthlyNet = monthlyProjectedIncome - monthlyTotalExpense - monthlyProjectedInvestment; let whatIfCost = 0; if(whatIfScenario && i-1 >= whatIfScenario.startMonth && i-1 < whatIfScenario.startMonth + whatIfScenario.duration) { whatIfCost = whatIfScenario.value; } projectedBalance += monthlyNet; whatIfBalance += (monthlyNet - whatIfCost); baseProjectionData.push(projectedBalance); if (whatIfScenario) whatIfProjectionData.push(whatIfBalance); tableBody.innerHTML += `<tr class="border-b"><td class="px-4 py-2 font-medium">${labels[i-1]}</td><td class="px-4 py-2 text-right income-text">${formatCurrency(monthlyProjectedIncome)}</td><td class="px-4 py-2 text-right expense-text">${formatCurrency(monthlyTotalExpense + monthlyProjectedInvestment)}</td><td class="px-4 py-2 text-right font-bold">${formatCurrency(projectedBalance)}</td></tr>`; } const datasets = [{ label: 'Saldo Projetado (Padrão)', data: baseProjectionData, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3 }]; if(whatIfScenario) { datasets.push({ label: `Saldo com "${whatIfScenario.desc}"`, data: whatIfProjectionData, borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true, tension: 0.3, borderDash: [5, 5] }); const impact = baseProjectionData[baseProjectionData.length - 1] - whatIfProjectionData[whatIfProjectionData.length - 1]; const impactEl = document.getElementById('whatif-impact'); impactEl.innerHTML = `O cenário simulado teria um impacto de <strong class="expense-text">-${formatCurrency(impact)}</strong> no seu saldo final em 12 meses.`; impactEl.classList.remove('hidden'); } else { document.getElementById('whatif-impact').classList.add('hidden'); } if (forecastChart) forecastChart.destroy(); forecastChart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: value => formatCurrency(value) } } }, plugins: { tooltip: { callbacks: { label: context => ` Saldo: ${formatCurrency(context.raw)}` } } } } }); };
        const renderValueInputModal = (templateOrDebt, callback) => { const isDebt = !!templateOrDebt.remainingBalance || templateOrDebt.pendingType === 'debt'; const title = isDebt ? `Lançar Pagamento: ${templateOrDebt.description}` : `Lançar ${templateOrDebt.description}`; const default_value = templateOrDebt.value; const modalContent = document.createElement('div'); modalContent.className = 'modal-content relative'; modalContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">${title}</h2><form id="value-input-form"><label for="pending-value" class="block text-sm font-medium text-gray-700">Valor do Pagamento</label><input type="number" id="pending-value" value="${default_value.toFixed(2) || ''}" class="mt-1 block w-full rounded-lg p-2 shadow-sm" placeholder="0,00" step="0.01" required><div id="input-modal-alert" class="alert-message hidden"></div><div class="flex gap-4 mt-6"><button type="button" id="cancel-input-btn" class="w-full py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button><button type="submit" class="w-full py-2 px-4 border rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Confirmar</button></div></form>`; elements.inputModal.innerHTML = ''; elements.inputModal.appendChild(modalContent); openModal(elements.inputModal); const form = document.getElementById('value-input-form'); const cancelBtn = document.getElementById('cancel-input-btn'); const inputField = document.getElementById('pending-value'); inputField.focus(); inputField.select(); const submitHandler = (e) => { e.preventDefault(); const value = parseFloat(inputField.value); if (isNaN(value) || value <= 0) { showAlert('Por favor, insira um valor válido.', 'error', document.getElementById('input-modal-alert')); return; } callback(value); closeModal(elements.inputModal); }; form.addEventListener('submit', submitHandler); cancelBtn.addEventListener('click', () => closeModal(elements.inputModal)); };
        const renderImportModal = () => { const modalContent = document.createElement('div'); modalContent.className = 'modal-content relative'; modalContent.innerHTML = `<span class="close-btn">&times;</span><h2 class="text-2xl font-bold mb-4">Importar Transações</h2><div class="space-y-4"><div><h3 class="font-semibold">Passo 1: Baixe o modelo</h3><p class="text-sm text-gray-600">Use nosso modelo para garantir que seus dados estão no formato correto. Ambos os formatos (CSV e Excel) são aceitos.</p><div class="flex gap-4 mt-2"><a href="template_importacao.csv" download="template_importacao.csv" class="inline-block bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 text-sm">Baixar Modelo (.csv)</a><a href="template_importacao.xlsx" download="template_importacao.xlsx" class="inline-block bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 text-sm">Baixar Modelo (.xlsx)</a></div></div><div class="border-t pt-4"><h3 class="font-semibold">Passo 2: Preencha o modelo</h3><p class="text-sm text-gray-600">Abra o arquivo e adicione suas transações. Siga as colunas exatamente como no modelo.</p><ul class="text-xs text-gray-500 list-disc list-inside mt-2 space-y-1"><li><span class="font-semibold">data:</span> Formato YYYY-MM-DD (ano-mês-dia).</li><li><span class="font-semibold">valor:</span> Use ponto como separador decimal (ex: 50.99).</li><li><span class="font-semibold">tipo:</span> Escreva 'income', 'expense' ou 'investment'.</li><li><span class="font-semibold">categoria:</span> Opcional. Se preenchida, deve existir no app.</li><li><span class="font-semibold">metodo_pagamento:</span> Opcional, apenas para despesas ('expense').</li></ul></div><div class="border-t pt-4"><h3 class="font-semibold">Passo 3: Envie o arquivo</h3><p class="text-sm text-gray-600">Salve seu arquivo preenchido e envie abaixo.</p><input type="file" id="file-input" accept=".csv, .xls, .xlsx" class="mt-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/></div><div id="import-feedback" class="mt-4"></div></div>`; elements.importModal.innerHTML = ''; elements.importModal.appendChild(modalContent); openModal(elements.importModal); document.getElementById('file-input').addEventListener('change', handleFileUpload); };
        const handleFileUpload = async (event) => { const file = event.target.files[0]; const feedbackEl = document.getElementById('import-feedback'); if (!file) return; feedbackEl.innerHTML = `<p class="text-sm text-blue-600">Processando arquivo...</p>`; let dataAsJson = []; try { if (file.name.endsWith('.csv')) { const text = await file.text(); const lines = text.split(/\r\n|\n/).filter(line => line); const header = lines[0].split(',').map(h => h.trim()); dataAsJson = lines.slice(1).map(line => { const data = line.split(','); return header.reduce((obj, nextKey, index) => { obj[nextKey] = data[index] ? data[index].trim().replace(/"/g, '') : ''; return obj; }, {}); }); } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) { const data = await file.arrayBuffer(); const workbook = XLSX.read(data); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; dataAsJson = XLSX.utils.sheet_to_json(worksheet, { raw: false, dateNF: 'yyyy-mm-dd' }); } else { feedbackEl.innerHTML = `<div class="alert-message alert-error">Formato de arquivo não suportado.</div>`; return; } processImportedData(dataAsJson); } catch (error) { console.error("Erro ao ler o arquivo:", error); feedbackEl.innerHTML = `<div class="alert-message alert-error">Ocorreu um erro ao ler o arquivo. Verifique se ele não está corrompido.</div>`; } };
        const processImportedData = async (data) => { const feedbackEl = document.getElementById('import-feedback'); const transactionsToImport = []; const errors = []; for (let i = 0; i < data.length; i++) { const row = data[i]; const rowNum = i + 2; const normalizedRow = {}; for (const key in row) { normalizedRow[key.toLowerCase().trim()] = row[key]; } const { data: date, descricao, valor, tipo, categoria, metodo_pagamento } = normalizedRow; if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) { errors.push(`Linha ${rowNum}: Formato de data inválido (esperado: AAAA-MM-DD).`); continue; } if (isNaN(parseFloat(valor)) || parseFloat(valor) <= 0) { errors.push(`Linha ${rowNum}: Valor inválido.`); continue; } if (!['income', 'expense', 'investment'].includes(tipo)) { errors.push(`Linha ${rowNum}: Tipo inválido (use 'income', 'expense' ou 'investment').`); continue; } const transaction = { date: date, description: descricao || 'Transação Importada', value: parseFloat(valor), type: tipo, category: categoria || 'Outros', paymentMethod: tipo === 'expense' ? (metodo_pagamento || 'Dinheiro') : null, timestamp: serverTimestamp() }; transactionsToImport.push(transaction); } if (transactionsToImport.length > 0) { try { const batch = writeBatch(db); transactionsToImport.forEach(t => { const newDocRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`)); batch.set(newDocRef, t); }); await batch.commit(); feedbackEl.innerHTML = `<div class="alert-message alert-success">${transactionsToImport.length} transações importadas com sucesso!</div>`; } catch (error) { console.error("Erro ao importar em lote:", error); feedbackEl.innerHTML = `<div class="alert-message alert-error">Ocorreu um erro ao salvar as transações.</div>`; } } else if (errors.length === 0) { feedbackEl.innerHTML = `<div class="alert-message alert-error">Nenhuma transação encontrada no arquivo.</div>`; } if (errors.length > 0) { feedbackEl.innerHTML += `<div class="mt-4 p-2 bg-red-50 rounded-lg max-h-32 overflow-y-auto"><h4 class="font-semibold text-sm text-red-800">Erros encontrados:</h4><ul class="text-xs text-red-700 list-disc list-inside">${errors.map(e => `<li>${e}</li>`).join('')}</ul></div>`; } };
        const updateRecurringFormType = (type, selectorPrefix) => { document.getElementById(`recurring-type-${selectorPrefix}`).value = type; document.querySelectorAll(`#recurring-type-selector-${selectorPrefix} > div`).forEach(el => { el.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500', 'text-white', 'font-semibold'); el.classList.add('bg-gray-200', 'text-gray-800'); }); const selectedEl = document.querySelector(`#recurring-type-selector-${selectorPrefix} [data-type="${type}"]`); selectedEl.classList.add(type === 'income' ? 'bg-green-500' : type === 'expense' ? 'bg-red-500' : 'bg-blue-500', 'text-white', 'font-semibold'); renderCategoryDropdown(document.getElementById(`recurring-category-${selectorPrefix}`), type); document.getElementById(`recurring-payment-field-${selectorPrefix}`).classList.toggle('hidden', type !== 'expense'); };
        const saveCategories = async () => { try { await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/categories`, 'user_categories'), state.categories); showAlert('Categorias atualizadas!', 'success', document.getElementById('settings-alert')); } catch (error) { showAlert('Erro ao salvar categorias!', 'error', document.getElementById('settings-alert')); console.error("Error saving categories: ", error); } };
        const handleAIAssistantClick = async () => { elements.aiInsightsModal.innerHTML = `<div class="modal-content relative"><span class="close-btn">&times;</span><h2 class="text-2xl font-bold mb-4">Analisando suas finanças...</h2><div class="text-center py-10"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600 mx-auto"></div><p class="mt-4 text-gray-600">Aguarde, nosso assistente de IA está preparando seus insights.</p></div></div>`; openModal(elements.aiInsightsModal); try { const ninetyDaysAgo = new Date(); ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90); const recentTransactions = state.transactions.filter(t => new Date(t.date) >= ninetyDaysAgo); if (recentTransactions.length < 5) { elements.aiInsightsModal.innerHTML = `<div class="modal-content relative"><span class="close-btn">&times;</span><h2 class="text-2xl font-bold mb-4">Ops!</h2><div class="text-center py-10"><p class="mt-4 text-gray-600">Precisamos de mais dados para uma análise completa. Continue lançando suas transações por mais alguns dias!</p></div></div>`; return; } const expenseSummary = recentTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.value; return acc; }, {}); const incomeSummary = recentTransactions.filter(t => t.type === 'income').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.value; return acc; }, {}); const dataForAI = { periodo: "Últimos 90 dias", resumo_despesas_por_categoria: expenseSummary, resumo_receitas_por_categoria: incomeSummary, orcamentos_mensais_definidos: state.settings.budgets, metas_de_economia: state.goals, }; const systemPrompt = "Você é um assistente financeiro amigável e proativo. Seu objetivo é analisar os dados financeiros do usuário e fornecer insights claros, positivos e acionáveis em português do Brasil. Use uma linguagem encorajadora. Formate sua resposta em Markdown, usando títulos (##), listas (*) e negrito (**). Comece com uma saudação e um resumo geral. Em seguida, divida a análise em seções: 'Pontos Fortes', 'Pontos de Melhoria' e 'Dicas Práticas'. Seja conciso e direto ao ponto. Não ultrapasse 250 palavras."; const userQuery = `Analise os seguintes dados financeiros e me dê insights:\n\n${JSON.stringify(dataForAI, null, 2)}`; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, }; const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API Error: ${response.statusText}`); const result = await response.json(); const text = result.candidates[0].content.parts[0].text; elements.aiInsightsModal.innerHTML = `<div class="modal-content relative"><span class="close-btn">&times;</span><h2 class="text-2xl font-bold mb-4">Seus Insights Financeiros ✨</h2><div class="prose max-w-none">${markdownToHtml(text)}</div></div>`; } catch (error) { console.error("Erro ao chamar a IA:", error); elements.aiInsightsModal.innerHTML = `<div class="modal-content relative"><span class="close-btn">&times;</span><h2 class="text-2xl font-bold mb-4">Erro na Análise</h2><div class="text-center py-10"><p class="mt-4 text-gray-600">Não foi possível gerar os insights no momento. Por favor, tente novamente mais tarde.</p></div></div>`; } };

        // --- APP INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndListeners();
            setCurrentDate();
            generateInstallmentOptions(elements.installmentsSelect);
            updateFormColor('expense');
            elements.toggleMainBalancesBtn.innerHTML = icons.eyeSlash;
            elements.toggleOverviewBalancesBtn.innerHTML = icons.eyeSlash;
            updateRecurringFormType('expense', 'main');

            elements.app.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.closest('#debts-card')) { renderDebtsModal(); }
                if (target.closest('#import-btn')) { renderImportModal(); }
                if (target.closest('#ai-assistant-btn')) { handleAIAssistantClick(); }
                if (target.closest('#manage-recurring-btn')) { renderRecurringModalContent(); openModal(elements.recurringModal); }
                if (target.closest('#forecast-btn')) { renderForecastModal(); openModal(elements.forecastModal); }
                if (target.closest('#reports-btn')) { renderReportsModal(); openModal(elements.reportsModal); }
                if (target.closest('#settings-btn')) { renderSettingsModal(); openModal(elements.settingsModal); }
                if (target.closest('#balance-card')) { openDetailsModal('balance'); }
                if (target.closest('#investment-card')) { openDetailsModal('investment'); }
                if (target.closest('#credit-card-card')) { openDetailsModal('credit-card'); }
                if (target.closest('#income-summary-card')) { openDetailsModal('income'); }
                if (target.closest('#expense-summary-card')) { openDetailsModal('expense'); }
                if (target.closest('#monthly-balance-card')) { openDetailsModal('monthly-balance'); }
                if (target.closest('#prev-pending-month-btn')) { state.pendingSelectedDate.setMonth(state.pendingSelectedDate.getMonth() - 1); renderPendingTransactions(); }
                if (target.closest('#next-pending-month-btn')) { state.pendingSelectedDate.setMonth(state.pendingSelectedDate.getMonth() + 1); renderPendingTransactions(); }
                if (target.closest('.budget-item-card')) { const category = target.closest('.budget-item-card').dataset.category; openDetailsModal('budget-category', { category }); }
                
                const typeSelector = target.closest('#type-selector .cursor-pointer');
                if (typeSelector) { updateFormColor(typeSelector.dataset.type); }
                if (target.closest('#prev-overview-month-btn')) { state.overviewSelectedDate.setMonth(state.overviewSelectedDate.getMonth() - 1); updateUI(); }
                if (target.closest('#next-overview-month-btn')) { state.overviewSelectedDate.setMonth(state.overviewSelectedDate.getMonth() + 1); updateUI(); }
                if (target.closest('#prev-history-month-btn')) { state.historySelectedDate.setMonth(state.historySelectedDate.getMonth() - 1); renderTransactions(); }
                if (target.closest('#next-history-month-btn')) { state.historySelectedDate.setMonth(state.historySelectedDate.getMonth() + 1); renderTransactions(); }
                if (target.closest('#toggle-main-balances-btn')) { state.isMainBalanceHidden = !state.isMainBalanceHidden; elements.toggleMainBalancesBtn.innerHTML = state.isMainBalanceHidden ? icons.eyeSlash : icons.eye; updateAllBalances(); }
                if (target.closest('#toggle-overview-balances-btn')) { state.isOverviewBalanceHidden = !state.isOverviewBalanceHidden; elements.toggleOverviewBalancesBtn.innerHTML = state.isOverviewBalanceHidden ? icons.eyeSlash : icons.eye; updateAllBalances(); }

                const postPendingBtn = target.closest('.post-pending-btn');
                if (postPendingBtn) {
                    const parent = postPendingBtn.closest('[data-template-id]');
                    const templateId = parent.dataset.templateId;
                    const pendingType = parent.dataset.pendingType;
                    
                    if (pendingType === 'recurring') {
                        const template = state.recurringTemplates.find(t => t.id === templateId); if (!template) return;
                        const launchDate = new Date(state.pendingSelectedDate.getFullYear(), state.pendingSelectedDate.getMonth(), template.dayOfMonth);
                        const dateString = launchDate.toISOString().slice(0, 10);
                        const postTransaction = async (value, date) => { try { const { createdAt, ...dataToPost } = template; await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`), { ...dataToPost, value, date: date, recurringTemplateId: template.id, timestamp: serverTimestamp() }); showAlert('Transação recorrente lançada!', 'success', elements.transactionAlertMessage); } catch (err) { console.error("Erro ao lançar recorrente:", err); showAlert('Erro ao lançar transação.', 'error', elements.transactionAlertMessage); } }
                        if (template.isVariable) { renderValueInputModal(template, (newValue) => postTransaction(newValue, dateString)); } else { postTransaction(template.value, dateString); }
                    } else if (pendingType === 'debt') {
                        const debt = state.debts.find(d => d.id === templateId); if (!debt) return;
                        const installmentValue = getDebtInstallmentForDate(debt, state.pendingSelectedDate);
                        const installmentIdentifier = `${debt.id}-${state.pendingSelectedDate.getFullYear()}-${String(state.pendingSelectedDate.getMonth() + 1).padStart(2, '0')}`;
                        const newTransaction = { type: 'expense', value: installmentValue, category: 'Pagamento de Dívidas', date: new Date(state.pendingSelectedDate).toISOString().slice(0, 10), description: `Pagamento Parcela: ${debt.name}`, paymentMethod: 'Débito em Conta', timestamp: serverTimestamp(), debtInstallmentId: installmentIdentifier };
                        
                        const debtRef = doc(db, `/artifacts/${appId}/users/${userId}/debts`, debt.id);
                        const transactionRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`));
                        const batch = writeBatch(db);
                        batch.set(transactionRef, newTransaction);
                        batch.update(debtRef, { remainingBalance: increment(-installmentValue), installmentsPaid: increment(1) });
                        await batch.commit();
                        showAlert('Pagamento de dívida lançado!', 'success', elements.transactionAlertMessage);
                    }
                }

                const editBtn = target.closest('.edit-btn');
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    const t = state.transactions.find(tr => tr.id === id); if (!t) return;
                    state.isEditing = true; elements.transactionIdInput.value = t.id; updateFormColor(t.type);
                    elements.valueInput.value = t.value; elements.dateInput.value = t.date; elements.descriptionInput.value = t.description;
                    setTimeout(() => { elements.categorySelect.value = t.category; if (t.type === 'expense') { elements.paymentMethodSelect.value = t.paymentMethod; elements.installmentsField.classList.toggle('hidden', t.paymentMethod !== 'Cartão de Crédito'); } }, 100);
                    elements.submitBtn.textContent = 'Salvar Alterações'; 
                    elements.cancelEditBtn.classList.remove('hidden');
                    elements.submitBtn.classList.add('w-2/3');
                    elements.submitBtn.classList.remove('w-full');
                    elements.transactionForm.scrollIntoView({ behavior: 'smooth' });
                }
                if (target.closest('.delete-btn')) { const id = target.closest('.delete-btn').dataset.id; try { await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/transactions`, id)); } catch (err) { console.error(err); } }
                if(target.closest('#cancel-edit-btn')){ resetTransactionForm(); }

                const recurringTypeSelectorMain = target.closest('#recurring-type-selector-main .cursor-pointer');
                if (recurringTypeSelectorMain) {
                    updateRecurringFormType(recurringTypeSelectorMain.dataset.type, 'main');
                }
            });

            elements.showTransactionFormBtn.addEventListener('click', () => { elements.transactionFormContainer.classList.remove('hidden'); elements.recurringFormContainer.classList.add('hidden'); elements.showTransactionFormBtn.classList.add('active'); elements.showRecurringFormBtn.classList.remove('active'); });
            elements.showRecurringFormBtn.addEventListener('click', () => { elements.transactionFormContainer.classList.add('hidden'); elements.recurringFormContainer.classList.remove('hidden'); elements.showTransactionFormBtn.classList.remove('active'); elements.showRecurringFormBtn.classList.add('active'); updateRecurringFormType('expense', 'main'); });
            
            [elements.settingsModal, elements.recurringModal, elements.reportsModal, elements.detailsModal, elements.forecastModal, elements.inputModal, elements.aiInsightsModal, elements.importModal, elements.debtsModal].forEach(modal => {
                modal.addEventListener('click', async e => {
                    const target = e.target;
                    if (target === modal || target.closest('.close-btn')) { state.isEditingRecurring = false; state.editingRecurringId = null; closeModal(modal); }
                    if (target.closest('#save-settings-btn')) { const faturaDay = parseInt(document.getElementById('fatura-day').value); const budgets = {}; document.querySelectorAll('#budgets-settings-list input').forEach(input => { if(input.value) budgets[input.dataset.category] = parseFloat(input.value); }); try { await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/settings`, 'user_settings'), { faturaDay, budgets }); await saveCategories(); } catch (error) { showAlert('Erro ao salvar!', 'error', document.getElementById('settings-alert')); console.error(error); } }
                    if (target.closest('.delete-goal-btn')) { const id = target.closest('.delete-goal-btn').dataset.id; await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/goals`, id)); renderSettingsModal(); }
                    if (target.closest('.delete-category-btn')) { const btn = target.closest('.delete-category-btn'); const { categoryName, categoryType } = btn.dataset; state.categories[categoryType] = state.categories[categoryType].filter(c => c !== categoryName); await saveCategories(); renderSettingsModal(); }
                    if (target.closest('.delete-debt-btn')) { const id = target.closest('.delete-debt-btn').dataset.id; await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/debts`, id)); renderDebtsModal(); }

                    const registerPaymentBtn = target.closest('.register-payment-btn');
                    if (registerPaymentBtn) {
                        const debtId = registerPaymentBtn.dataset.id;
                        const debt = state.debts.find(d => d.id === debtId);
                        if(debt && debt.remainingBalance > 0){
                            const currentInstallmentValue = getDebtInstallmentForDate(debt, new Date());
                            renderValueInputModal({description: `Pagamento: ${debt.name}`, value: currentInstallmentValue, pendingType: 'debt'}, async (paymentValue) => {
                                const newTransaction = { type: 'expense', value: paymentValue, category: 'Pagamento de Dívidas', date: new Date().toISOString().slice(0, 10), description: `Pagamento: ${debt.name}`, paymentMethod: 'Débito em Conta', timestamp: serverTimestamp(), };
                                const debtRef = doc(db, `/artifacts/${appId}/users/${userId}/debts`, debtId);
                                const transactionRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`));
                                const batch = writeBatch(db);
                                batch.set(transactionRef, newTransaction);
                                batch.update(debtRef, { remainingBalance: increment(-paymentValue), installmentsPaid: increment(1) });
                                await batch.commit();
                                renderDebtsModal();
                            });
                        }
                    }

                    const recurringTypeSelectorModal = target.closest('#recurring-type-selector-modal .cursor-pointer');
                    if (recurringTypeSelectorModal) { updateRecurringFormType(recurringTypeSelectorModal.dataset.type, 'modal'); }
                    if(target.closest('.delete-recurring-btn')){ const id = target.closest('.delete-recurring-btn').dataset.id; await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/recurring_templates`, id)); if (state.editingRecurringId === id) { state.isEditingRecurring = false; state.editingRecurringId = null; } renderRecurringModalContent(); }
                    if(target.closest('.edit-recurring-btn')){ const id = target.closest('.edit-recurring-btn').dataset.id; state.isEditingRecurring = true; state.editingRecurringId = id; renderRecurringModalContent(true); }
                    if(target.closest('#cancel-recurring-edit-btn')){ state.isEditingRecurring = false; state.editingRecurringId = null; renderRecurringModalContent(); }
                });
                
                modal.addEventListener('submit', async e => {
                    e.preventDefault();
                    if(e.target.id === 'debt-form') {
                        const name = document.getElementById('debt-name').value;
                        const totalAmount = parseFloat(document.getElementById('debt-total-amount').value);
                        const installmentsTotal = parseInt(document.getElementById('debt-installments-total').value);
                        const startDate = document.getElementById('debt-start-date').value;
                        const amortizationType = document.getElementById('debt-amortization-type').value;
                        const interestRate = parseFloat(document.getElementById('debt-interest-rate').value);
                        const alertEl = document.getElementById('debt-alert-message');

                        if (name && totalAmount > 0 && installmentsTotal > 0 && startDate && !isNaN(interestRate)) {
                            const newDebt = { name, totalAmount, installmentsTotal, startDate, amortizationType, interestRate, remainingBalance: totalAmount, installmentsPaid: 0, createdAt: serverTimestamp(), };
                            await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/debts`), newDebt);
                            e.target.reset(); document.getElementById('debt-start-date').value = new Date().toISOString().slice(0, 10);
                            showAlert('Dívida adicionada com sucesso!', 'success', alertEl);
                            renderDebtsModal();
                        } else { showAlert('Por favor, preencha todos os campos corretamente.', 'error', alertEl); }
                    }
                    if(e.target.matches('.add-category-form')) { const formData = new FormData(e.target); const type = formData.get('type'); const name = formData.get('name').trim(); if (name && type && !state.categories[type].includes(name)) { state.categories[type].push(name); state.categories[type].sort(); await saveCategories(); renderSettingsModal(); } e.target.reset(); }
                    if(e.target.id === 'goal-form') { const name = document.getElementById('goal-name').value; const targetValue = parseFloat(document.getElementById('goal-value').value); if(name && targetValue > 0) { await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/goals`), { name, targetValue }); renderSettingsModal(); } }
                    if(e.target.id === 'recurring-form-modal') { const id = document.getElementById('recurring-id-modal').value; const data = { description: document.getElementById('recurring-description-modal').value, category: document.getElementById('recurring-category-modal').value, type: document.getElementById('recurring-type-modal').value, isVariable: document.getElementById('recurring-is-variable-modal').checked, value: parseFloat(document.getElementById('recurring-value-modal').value) || 0, dayOfMonth: parseInt(document.getElementById('recurring-day-of-month-modal').value), durationMonths: parseInt(document.getElementById('recurring-duration-modal').value) || null, paymentMethod: document.getElementById('recurring-type-modal').value === 'expense' ? document.getElementById('recurring-payment-method-modal').value : null }; if (!data.description || !data.category || !data.dayOfMonth) { showAlert('Descrição, Categoria e Dia são obrigatórios!', 'error', document.getElementById('recurring-alert-message-modal')); return; } try { await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/recurring_templates`, id), data); state.isEditingRecurring = false; state.editingRecurringId = null; renderRecurringModalContent(); } catch (err) { console.error(err); showAlert('Erro ao salvar!', 'error', document.getElementById('recurring-alert-message-modal')); } }
                });
            });

            elements.paymentMethodSelect.addEventListener('change', (e) => { elements.installmentsField.classList.toggle('hidden', e.target.value !== 'Cartão de Crédito'); });
            elements.categoryFilter.addEventListener('change', () => { state.filters.category = elements.categoryFilter.value; renderTransactions(); });
            elements.transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = elements.transactionIdInput.value;
                const data = { type: elements.hiddenTypeInput.value, value: parseFloat(elements.valueInput.value), category: elements.categorySelect.value, date: elements.dateInput.value, description: elements.descriptionInput.value, paymentMethod: state.selectedType === 'expense' ? elements.paymentMethodSelect.value : null, timestamp: serverTimestamp() };
                if(!data.category) { showAlert('Por favor, selecione ou crie uma categoria.', 'error', elements.transactionAlertMessage); return; }
                try {
                    if (state.isEditing) {
                        await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/transactions`, id), data);
                        showAlert('Transação atualizada!', 'success', elements.transactionAlertMessage);
                    } else {
                        const isInstallment = state.selectedType === 'expense' && data.paymentMethod === 'Cartão de Crédito' && parseInt(elements.installmentsSelect.value) > 1;
                        if (isInstallment) {
                            const totalValue = data.value; const installments = parseInt(elements.installmentsSelect.value); const installmentValue = parseFloat((totalValue / installments).toFixed(2)); const originalDesc = data.description; const startDate = new Date(data.date + 'T12:00:00Z'); const batch = writeBatch(db);
                            for (let i = 0; i < installments; i++) { const installmentDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, startDate.getDate()); const newDocRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`)); batch.set(newDocRef, { ...data, value: installmentValue, date: installmentDate.toISOString().slice(0, 10), description: `${originalDesc} (${i + 1}/${installments})` }); }
                            await batch.commit();
                            showAlert(`${installments} parcelas adicionadas!`, 'success', elements.transactionAlertMessage);
                        } else {
                            await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`), data);
                            showAlert('Transação adicionada!', 'success', elements.transactionAlertMessage);
                        }
                    }
                } catch (err) { console.error(err); showAlert('Ocorreu um erro', 'error', elements.transactionAlertMessage); }
                finally { resetTransactionForm(); }
            });

            elements.recurringForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = { description: document.getElementById('recurring-description-main').value, category: document.getElementById('recurring-category-main').value, type: document.getElementById('recurring-type-main').value, isVariable: document.getElementById('recurring-is-variable-main').checked, value: parseFloat(document.getElementById('recurring-value-main').value) || 0, dayOfMonth: parseInt(document.getElementById('recurring-day-of-month-main').value), durationMonths: parseInt(document.getElementById('recurring-duration-main').value) || null, paymentMethod: document.getElementById('recurring-type-main').value === 'expense' ? document.getElementById('recurring-payment-method-main').value : null, createdAt: serverTimestamp() };
                if (!data.description || !data.category || !data.dayOfMonth) { showAlert('Descrição, Categoria e Dia são obrigatórios!', 'error', document.getElementById('recurring-alert-message-main')); return; }
                if(!data.category) { showAlert('Por favor, selecione ou crie uma categoria.', 'error', document.getElementById('recurring-alert-message-main')); return; }
                try {
                    await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/recurring_templates`), data);
                    showAlert('Recorrente salvo com sucesso!', 'success', document.getElementById('recurring-alert-message-main'));
                    e.target.reset();
                    updateRecurringFormType('expense', 'main');
                } catch (err) { console.error(err); showAlert('Erro ao salvar recorrente.', 'error', document.getElementById('recurring-alert-message-main')); }
            });
        });
    </script>
</body>
</html>

