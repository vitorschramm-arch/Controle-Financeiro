import React from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, writeBatch, where, getDocs } from 'firebase/firestore';

// --- Ícones SVG como Componentes ---
const PlusIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
);
const EyeIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
);
const EyeOffIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>
);
const SettingsIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0 .73 2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
);
const ChevronLeftIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"></path></svg>
);
const ChevronRightIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 18 6-6-6-6"></path></svg>
);
const ArrowUpDownIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></svg>
);
const TrashIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
);
const CheckIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 6 9 17l-5-5"/></svg>
);
const EditIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
);
const ExclamationIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-500"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
);
const TrendingUpIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
);


// --- Configuração do Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyAlvRBErv2pG8BObnX8Ew0CqOQKypTM39c",
  authDomain: "controle-612f2.firebaseapp.com",
  projectId: "controle-612f2",
  storageBucket: "controle-612f2.firebasestorage.app",
  messagingSenderId: "39791655795",
  appId: "1:39791655795:web:1b6ad76afa568af3b86306",
  measurementId: "G-7X9S01NMWX"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- Funções Utilitárias ---
const formatCurrency = (value) => {
    const number = Number(value);
    if (isNaN(number)) {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(0);
    }
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
    }).format(number);
};

const ALL_CATEGORIES = {
    entrada: { "Salário": ["Adiantamento", "Pagamento Mensal"], "Renda Extra": ["Freelance", "Vendas"], "Outras Entradas": [], },
    saida: { "Moradia": ["Aluguel", "Condomínio", "Energia", "Água", "Internet"], "Alimentação": ["Supermercado", "Restaurante", "Delivery"], "Transporte": ["Combustível", "Transporte Público", "Uber/99"], "Dívidas": ["Parcela Empréstimo", "Parcela Financiamento"], "Lazer": ["Cinema", "Viagens", "Hobbies"], "Saúde": ["Farmácia", "Consulta"], "Educação": ["Cursos", "Mensalidade"], "Outras Saídas": [], },
    investimento: { "Renda Fixa": ["CDB", "Tesouro Direto", "LCI/LCA"], "Renda Variável": ["Ações", "Fundos Imobiliários", "ETFs"], "Outros Investimentos": [], }
};


// --- Componente Principal ---
export default function App() {
    const [user, setUser] = React.useState(null);
    const [isAuthReady, setIsAuthReady] = React.useState(false);
    const [showTransactionModal, setShowTransactionModal] = React.useState(false);
    const [editingTransaction, setEditingTransaction] = React.useState(null);
    const [editingRecurrent, setEditingRecurrent] = React.useState(null);
    const [showDetailsModal, setShowDetailsModal] = React.useState(null);
    const [showMonthlyOverviewDetails, setShowMonthlyOverviewDetails] = React.useState(null);
    const [showCategoryDetailsModal, setShowCategoryDetailsModal] = React.useState(null);
    const [showSettingsModal, setShowSettingsModal] = React.useState(false);
    const [showPendingModal, setShowPendingModal] = React.useState(false);
    const [showDebtsModal, setShowDebtsModal] = React.useState(false);
    const [showForecastModal, setShowForecastModal] = React.useState(false);
    const [transactions, setTransactions] = React.useState([]);
    const [debts, setDebts] = React.useState([]);
    const [settings, setSettings] = React.useState(null);
    const [currentDate, setCurrentDate] = React.useState(new Date());

    // Efeito para autenticação e carregamento de scripts
    React.useEffect(() => {
        const script = document.createElement('script');
        script.src = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";
        script.async = true;
        document.body.appendChild(script);

        const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
                setUser(currentUser);
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined') { await signInWithCustomToken(auth, __initial_auth_token); } 
                    else { await signInAnonymously(auth); }
                } catch (error) { console.error("Erro na autenticação:", error); }
            }
            setIsAuthReady(true);
        });

        return () => {
            unsubscribe();
            if (document.body.contains(script)) {
                document.body.removeChild(script);
            }
        };
    }, []);
    
    // Efeito para buscar dados do Firestore
    React.useEffect(() => {
        if (isAuthReady && user) {
            const unsubscribers = [];
            
            const transactionsCollection = collection(db, `/artifacts/${appId}/users/${user.uid}/transactions`);
            unsubscribers.push(onSnapshot(query(transactionsCollection), (snapshot) => setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })))));
            
            const debtsCollection = collection(db, `/artifacts/${appId}/users/${user.uid}/debts`);
            unsubscribers.push(onSnapshot(query(debtsCollection), (snapshot) => setDebts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })))));

            const settingsDocRef = doc(db, `/artifacts/${appId}/users/${user.uid}/settings/main`);
            unsubscribers.push(onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const settingsData = docSnap.data();
                    if (!settingsData.categories) settingsData.categories = ALL_CATEGORIES;
                    setSettings(settingsData);
                } else {
                    const defaultSettings = { cardClosingDay: 1, savingsGoal: 0, budgets: {}, categories: ALL_CATEGORIES };
                    setDoc(settingsDocRef, defaultSettings);
                    setSettings(defaultSettings);
                }
            }));

            return () => unsubscribers.forEach(unsub => unsub());
        }
    }, [isAuthReady, user]);


    // Cálculos Financeiros
    const { saldo, totalInvestido, pendingTransactions, totalDebts, monthlyData, faturaAtual } = React.useMemo(() => {
        const saldo = transactions.reduce((acc, t) => {
            if (t.transactionNature !== 'pontual' && t.status !== 'approved') return acc;
            if (t.type === 'entrada') return acc + t.amount;
            if (t.type === 'saida') return acc - t.amount;
            return acc;
        }, 0);

        const totalInvestido = transactions.reduce((acc, t) => {
            if (t.type === 'investimento' && (t.transactionNature === 'pontual' || t.status === 'approved')) return acc + t.amount;
            return acc;
        }, 0);

        const totalDebts = debts.reduce((acc, debt) => acc + debt.remainingBalance, 0);
        
        const currentMonthStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        const pending = transactions.filter(t => {
            if (t.transactionNature !== 'recorrente') return false;
            if (t.approvedMonths && t.approvedMonths.includes(currentMonthStr)) return false;

            if (t.duration) {
                const createdAtDate = t.createdAt?.toDate();
                if (!createdAtDate) return true;
                const endDate = new Date(createdAtDate);
                endDate.setMonth(endDate.getMonth() + t.duration);
                if (currentDate > endDate) return false;
            }
            return true;
        });

        // Cálculos para Visão Geral do Mês
        const monthly = { income: 0, expenses: 0, balance: 0, categoryExpenses: {}, categoryPending: {} };
        transactions.forEach(t => {
            const transactionDate = t.date ? new Date(t.date + 'T00:00:00') : null;
            if (!transactionDate || transactionDate.getFullYear() !== currentDate.getFullYear() || transactionDate.getMonth() !== currentDate.getMonth()) return;
            if(t.transactionNature === 'recorrente') return;
            
            if (t.type === 'entrada') monthly.income += t.amount;
            if (t.type === 'saida') {
                monthly.expenses += t.amount;
                monthly.categoryExpenses[t.category] = (monthly.categoryExpenses[t.category] || 0) + t.amount;
            }
        });
        
        pending.forEach(t => {
            if (t.type === 'saida') {
                monthly.categoryPending[t.category] = (monthly.categoryPending[t.category] || 0) + t.amount;
            }
        });
        
        monthly.balance = monthly.income - monthly.expenses;
        
        // Cálculo da Fatura Atual
        let fatura = 0;
        if (settings?.cardClosingDay) {
            const closingDay = settings.cardClosingDay;
            
            let billEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), closingDay);
            let billStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, closingDay + 1);

            if (new Date().getDate() > closingDay) {
                billStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), closingDay + 1);
                billEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, closingDay);
            }

            fatura = transactions.reduce((acc, t) => {
                if (t.paymentMethod === 'Cartão de Crédito' && t.date) {
                    const transactionDate = new Date(t.date + 'T00:00:00');
                    if (transactionDate >= billStartDate && transactionDate <= billEndDate) {
                        return acc + t.amount;
                    }
                }
                return acc;
            }, 0);
        }

        return { saldo, totalInvestido, pendingTransactions: pending, totalDebts, monthlyData: monthly, faturaAtual: fatura };
    }, [transactions, debts, currentDate, settings]);
    
    const monthlyTransactions = React.useMemo(() => {
        return transactions.filter(t => {
            if (t.transactionNature === 'recorrente') return false; 
            const transactionDate = t.date ? new Date(t.date + 'T00:00:00') : null;
            if (!transactionDate) return false;
            return transactionDate.getFullYear() === currentDate.getFullYear() && transactionDate.getMonth() === currentDate.getMonth();
        });
    }, [transactions, currentDate]);


    if (!isAuthReady || !user || !settings) {
        return <div className="flex items-center justify-center h-screen bg-gray-100"><div className="text-xl font-semibold">Carregando...</div></div>;
    }
    
    const getModalData = (title) => {
        switch(title) {
            case 'Saldo': return transactions.filter(t => (t.type === 'entrada' || t.type === 'saida') && (t.transactionNature === 'pontual' || t.status === 'approved'));
            case 'Total Investido': return transactions.filter(t => t.type === 'investimento' && (t.transactionNature === 'pontual' || t.status === 'approved'));
            case 'Fatura Atual': {
                if (!settings?.cardClosingDay) return [];
                const closingDay = settings.cardClosingDay;
                let billEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), closingDay);
                let billStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, closingDay + 1);

                if (new Date().getDate() > closingDay) {
                    billStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), closingDay + 1);
                    billEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, closingDay);
                }
                
                return transactions.filter(t => {
                    if (t.paymentMethod === 'Cartão de Crédito' && t.date) {
                        const transactionDate = new Date(t.date + 'T00:00:00');
                        return transactionDate >= billStartDate && transactionDate <= billEndDate;
                    }
                    return false;
                });
            }
            default: return [];
        }
    };
    
    const getCategoryModalData = (category) => {
        return monthlyTransactions.filter(t => t.category === category);
    };

    const getMonthlyOverviewData = (type) => {
        if (type === 'income') return monthlyTransactions.filter(t => t.type === 'entrada');
        if (type === 'expenses') return monthlyTransactions.filter(t => t.type === 'saida');
        if (type === 'balance') return monthlyTransactions.filter(t => t.type === 'entrada' || t.type === 'saida');
        return [];
    };

    const handleCardClick = (title) => {
        if (title === 'Dívidas') setShowDebtsModal(true);
        else setShowDetailsModal(title);
    };

    return (
        <div className="bg-gray-50 min-h-screen font-sans text-gray-800">
            <div className="container mx-auto p-4 md:p-6">
                <Header onOpenSettings={() => setShowSettingsModal(true)} onOpenForecast={() => setShowForecastModal(true)} />
                <Dashboard saldo={saldo} totalInvestido={totalInvestido} totalDebts={totalDebts} faturaAtual={faturaAtual} onCardClick={handleCardClick}/>
                <MonthNavigator currentDate={currentDate} setCurrentDate={setCurrentDate}/>
                <MonthlyOverview data={monthlyData} settings={settings} onBarClick={(category) => setShowCategoryDetailsModal(category)} onOverviewClick={(type) => setShowMonthlyOverviewDetails(type)} onOpenSettings={() => setShowSettingsModal(true)} />
                <PendingSection pendingTransactions={pendingTransactions} onOpenModal={() => setShowPendingModal(true)} />
                <TransactionHistory transactions={monthlyTransactions} onTransactionClick={setEditingTransaction} />
                <FloatingActionButton onOpenModal={() => setShowTransactionModal(true)} />
                
                {showTransactionModal && <TransactionModal onClose={() => setShowTransactionModal(false)} userId={user.uid} categories={settings.categories} />}
                {editingTransaction && <EditTransactionModal transaction={editingTransaction} onClose={() => setEditingTransaction(null)} userId={user.uid} categories={settings.categories} />}
                {editingRecurrent && <EditRecurrentModal transaction={editingRecurrent} onClose={() => setEditingRecurrent(null)} userId={user.uid} categories={settings.categories} />}

                {showDetailsModal && <DetailsModal title={showDetailsModal} transactions={getModalData(showDetailsModal)} onClose={() => setShowDetailsModal(null)} />}
                {showCategoryDetailsModal && <DetailsModal title={`Detalhes de ${showCategoryDetailsModal}`} transactions={getCategoryModalData(showCategoryDetailsModal)} onClose={() => setShowCategoryDetailsModal(null)} />}
                {showMonthlyOverviewDetails && <DetailsModal title={`Lançamentos de ${showMonthlyOverviewDetails === 'income' ? 'Entradas' : showMonthlyOverviewDetails === 'expenses' ? 'Saídas' : 'Saldo'} do Mês`} transactions={getMonthlyOverviewData(showMonthlyOverviewDetails)} onClose={() => setShowMonthlyOverviewDetails(null)} />}
                {showSettingsModal && <SettingsModal onClose={() => setShowSettingsModal(false)} userId={user.uid} currentSettings={settings} transactions={transactions} debts={debts} onEditRecurrent={setEditingRecurrent}/>}
                {showPendingModal && <PendingApprovalModal onClose={() => setShowPendingModal(false)} userId={user.uid} transactions={transactions} pendingTransactions={pendingTransactions} currentDate={currentDate} />}
                {showDebtsModal && <DebtsModal onClose={() => setShowDebtsModal(false)} userId={user.uid} debts={debts}/>}
                {showForecastModal && <FutureForecastModal onClose={() => setShowForecastModal(false)} transactions={transactions} debts={debts} currentBalance={saldo} />}
            </div>
        </div>
    );
}

// --- Componentes da UI ---

function Header({ onOpenSettings, onOpenForecast }) {
     return (
        <header className="flex justify-between items-center mb-6">
            <div>
                <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Meu Painel</h1>
                <p className="text-gray-500">Bem-vindo(a) de volta!</p>
            </div>
            <div className="flex items-center space-x-2">
                <button onClick={onOpenForecast} className="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Previsão Futura">
                    <TrendingUpIcon />
                </button>
                <button onClick={onOpenSettings} className="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Configurações">
                    <SettingsIcon />
                </button>
            </div>
        </header>
     );
}

function MonthNavigator({ currentDate, setCurrentDate }){
    const handlePreviousMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
    const handleNextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
    const monthName = currentDate.toLocaleString('pt-BR', { month: 'long' });
    return (
        <div className="flex items-center justify-center my-4 p-2 rounded-lg bg-white shadow-sm">
            <button onClick={handlePreviousMonth} className="p-2 rounded-full hover:bg-gray-100"><ChevronLeftIcon /></button>
            <div className="text-center font-semibold text-lg w-48"><span className="capitalize">{monthName}</span> de {currentDate.getFullYear()}</div>
            <button onClick={handleNextMonth} className="p-2 rounded-full hover:bg-gray-100"><ChevronRightIcon /></button>
        </div>
    );
}

function Dashboard({ saldo, totalInvestido, totalDebts, faturaAtual, onCardClick }) {
    const [showValues, setShowValues] = React.useState(false);
    const cards = [
        { title: "Saldo", value: saldo, modal: true },
        { title: "Dívidas", value: totalDebts, modal: true },
        { title: "Total Investido", value: totalInvestido, modal: true },
        { title: "Fatura Atual", value: faturaAtual, modal: true },
    ];
    return (
        <section>
            <div className="flex justify-end mb-4"><button onClick={() => setShowValues(!showValues)} className="p-2 rounded-full hover:bg-gray-200 transition-colors">{showValues ? <EyeOffIcon /> : <EyeIcon />}</button></div>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                {cards.map(card => (
                    <div key={card.title} onClick={() => card.modal && onCardClick(card.title)} className="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition-shadow">
                        <h3 className="text-gray-500 font-medium">{card.title}</h3>
                        <p className={`text-2xl font-bold truncate ${showValues ? 'text-gray-800' : 'bg-gray-200 rounded-md text-transparent'}`}>{formatCurrency(card.value)}</p>
                    </div>
                ))}
            </div>
        </section>
    );
}

function MonthlyOverview({ data, settings, onBarClick, onOverviewClick, onOpenSettings }) {
    const [showValues, setShowValues] = React.useState(true);
    const { income, expenses, balance, categoryExpenses, categoryPending } = data;
    const { budgets, savingsGoal } = settings;

    const totalPendingExpenses = React.useMemo(() => {
        return Object.values(categoryPending || {}).reduce((sum, value) => sum + value, 0);
    }, [categoryPending]);
    
    const projectedExpenses = expenses + totalPendingExpenses;
    const projectedBalance = income - projectedExpenses;

    const unbudgetedCategories = React.useMemo(() => {
        return Object.keys(categoryExpenses)
            .filter(category => !budgets || !budgets[category] || budgets[category] <= 0)
            .reduce((obj, key) => {
                obj[key] = categoryExpenses[key];
                return obj;
            }, {});
    }, [categoryExpenses, budgets]);

    const PieChart = ({ data }) => {
        const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1'];
        const total = Object.values(data).reduce((sum, value) => sum + value, 0);
        if (total === 0) return <div className="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center text-sm text-gray-500">Sem dados</div>;

        let cumulativePercent = 0;
        const slices = Object.entries(data).map(([key, value], index) => {
            const percent = (value / total);
            const startAngle = cumulativePercent * 360;
            const endAngle = (cumulativePercent + percent) * 360;
            cumulativePercent += percent;
            const getCoord = (angle) => { const rad = (angle - 90) * Math.PI / 180; return [50 + 50 * Math.cos(rad), 50 + 50 * Math.sin(rad)]; };
            const [startX, startY] = getCoord(startAngle); const [endX, endY] = getCoord(endAngle); const largeArcFlag = endAngle - startAngle > 180 ? 1 : 0;
            const pathData = `M 50,50 L ${startX},${startY} A 50,50 0 ${largeArcFlag},1 ${endX},${endY} Z`;
            return <path key={key} d={pathData} fill={colors[index % colors.length]} />;
        });
        return <svg viewBox="0 0 100 100" className="w-24 h-24">{slices}</svg>;
    };

    return (
        <section className="mt-6 bg-white p-4 rounded-xl shadow-md">
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">Visão Geral do Mês</h2>
                <button onClick={() => setShowValues(!showValues)} className="p-2 rounded-full hover:bg-gray-100">{showValues ? <EyeOffIcon /> : <EyeIcon />}</button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div className="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors" onClick={() => onOverviewClick('income')}>
                    <p className="text-sm text-gray-500">Entradas</p>
                    <p className={`font-bold text-lg ${showValues ? 'text-green-600' : 'bg-gray-200 rounded text-transparent'}`}>{formatCurrency(income)}</p>
                </div>
                <div className="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors" onClick={() => onOverviewClick('expenses')}>
                    <p className="text-sm text-gray-500">Saídas</p>
                    <p className={`font-bold text-lg ${showValues ? 'text-red-600' : 'bg-gray-200 rounded text-transparent'}`}>{formatCurrency(expenses)}</p>
                     {totalPendingExpenses > 0 && (
                        <p className={`text-xs mt-1 ${showValues ? 'text-gray-500' : 'bg-gray-200 rounded text-transparent'}`}>Previsto: {formatCurrency(projectedExpenses)}</p>
                    )}
                </div>
                <div className="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors" onClick={() => onOverviewClick('balance')}>
                    <p className="text-sm text-gray-500">Saldo do Mês</p>
                    <p className={`font-bold text-lg ${showValues ? (balance >= 0 ? 'text-gray-800' : 'text-red-600') : 'bg-gray-200 rounded text-transparent'}`}>{formatCurrency(balance)}</p>
                     {totalPendingExpenses > 0 && (
                        <p className={`text-xs mt-1 ${showValues ? 'text-gray-500' : 'bg-gray-200 rounded text-transparent'}`}>Previsto: {formatCurrency(projectedBalance)}</p>
                    )}
                </div>
            </div>

            <div className="flex flex-col md:flex-row gap-6">
                <div className="flex-shrink-0 text-center"><h3 className="font-semibold mb-2">Gastos por Categoria</h3><PieChart data={categoryExpenses} /></div>
                <div className="flex-1 space-y-4">
                    {Object.entries(budgets).filter(([, budgetVal]) => budgetVal > 0).map(([category, budget]) => {
                        const spent = categoryExpenses[category] || 0;
                        if(spent === 0) return null;
                        const pending = categoryPending[category] || 0;
                        const totalSpent = spent + pending;
                        const spentPercent = (spent / budget) * 100;
                        const pendingPercent = (pending / budget) * 100;
                        return (
                            <div key={category} className="cursor-pointer" onClick={() => onBarClick(category)}>
                                <div className="flex justify-between text-sm mb-1"><span className="font-medium">{category}</span><span className={showValues ? 'text-gray-600' : 'bg-gray-200 rounded text-transparent'}>{`${formatCurrency(totalSpent)} / ${formatCurrency(budget)}`}</span></div>
                                <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden"><div className="bg-green-500 h-4" style={{ width: `${spentPercent}%`, float: 'left' }}></div><div className="bg-gray-400 h-4" style={{ width: `${pendingPercent}%`, float: 'left' }}></div></div>
                            </div>
                        );
                    })}
                     {Object.keys(unbudgetedCategories).length > 0 && (
                        <div className="mt-4 pt-4 border-t border-dashed space-y-3">
                            <h4 className="text-sm font-semibold text-yellow-700">Gastos não orçados</h4>
                            {Object.entries(unbudgetedCategories).map(([category, spent]) => (
                                <div key={category} className="flex justify-between items-center bg-yellow-50 p-2 rounded-lg">
                                    <div className="flex items-center gap-2"><ExclamationIcon /><span className="font-medium text-sm">{category}</span></div>
                                    <div className="flex items-center gap-3"><span className={`font-semibold text-sm ${showValues ? 'text-yellow-800' : 'bg-gray-200 rounded text-transparent'}`}>{formatCurrency(spent)}</span><button onClick={onOpenSettings} className="text-xs bg-yellow-200 text-yellow-800 font-bold py-1 px-2 rounded hover:bg-yellow-300">Regularizar</button></div>
                                </div>
                            ))}
                        </div>
                    )}
                     {savingsGoal > 0 && (
                        <div>
                            <div className="flex justify-between text-sm mb-1"><span className="font-medium">Meta de Economia</span><span className={showValues ? 'text-gray-600' : 'bg-gray-200 rounded text-transparent'}>{`${formatCurrency(balance > 0 ? balance : 0)} / ${formatCurrency(savingsGoal)}`}</span></div>
                            <div className="w-full bg-gray-200 rounded-full h-4"><div className="bg-blue-500 h-4 rounded-full" style={{ width: `${Math.min((balance > 0 ? balance : 0) / savingsGoal * 100, 100)}%` }}></div></div>
                        </div>
                    )}
                </div>
            </div>
        </section>
    );
}

function PendingSection({ pendingTransactions, onOpenModal }) {
    return (
        <section className="mt-6">
            <div onClick={onOpenModal} className="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition-shadow">
                <h2 className="text-xl font-bold mb-2">Pendentes de Aprovação</h2>
                {pendingTransactions.length === 0 ? (<p className="text-center text-gray-500 py-4">Nenhum lançamento pendente para este mês.</p>) : (
                    <ul className="space-y-2">
                        {pendingTransactions.slice(0, 3).map(t => (<li key={t.id} className="bg-gray-50 p-2 rounded-lg flex justify-between items-center text-sm"><div><p className="font-semibold">{t.description || t.category}</p><p className="text-xs text-gray-500">Dia {t.dayOfMonth}</p></div><span className="font-semibold text-gray-700">{formatCurrency(t.amount)}</span></li>))}
                        {pendingTransactions.length > 3 && (<p className="text-center text-sm text-blue-600 font-semibold mt-2">e mais {pendingTransactions.length - 3}...</p>)}
                    </ul>
                )}
            </div>
        </section>
    )
}

function TransactionHistory({ transactions, onTransactionClick }) {
    const [filterCategory, setFilterCategory] = React.useState('all');

    const uniqueCategories = React.useMemo(() => {
        const cats = new Set(transactions.map(t => t.category));
        return ['all', ...Array.from(cats).sort()];
    }, [transactions]);

    const filteredTransactions = React.useMemo(() => {
        if (filterCategory === 'all') return transactions;
        return transactions.filter(t => t.category === filterCategory);
    }, [transactions, filterCategory]);

    const filteredTotal = React.useMemo(() => {
        return filteredTransactions.reduce((acc, t) => {
            if (t.type === 'entrada') return acc + t.amount;
            if (t.type === 'saida') return acc - t.amount;
            return acc;
        }, 0);
    }, [filteredTransactions]);

    const getTypePill = (type) => {
        const styles = { entrada: "bg-green-100 text-green-800", saida: "bg-red-100 text-red-800", investimento: "bg-blue-100 text-blue-800" };
        const text = { entrada: "Entrada", saida: "Saída", investimento: "Invest." };
        return <span className={`text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full ${styles[type]}`}>{text[type]}</span>;
    }

    return (
        <section className="mt-8">
            <h2 className="text-xl font-bold mb-4">Histórico de Transações do Mês</h2>
            <div className="bg-white p-4 rounded-xl shadow-md">
                <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 p-2 bg-gray-50 rounded-lg">
                    <div className="flex items-center gap-2">
                        <label htmlFor="category-filter" className="text-sm font-medium">Filtrar:</label>
                        <select id="category-filter" value={filterCategory} onChange={e => setFilterCategory(e.target.value)} className="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2">
                            {uniqueCategories.map(cat => <option key={cat} value={cat}>{cat === 'all' ? 'Todas as Categorias' : cat}</option>)}
                        </select>
                    </div>
                    <div className="text-right">
                        <p className="text-sm text-gray-500">Total Filtrado</p>
                        <p className={`font-bold text-lg ${filteredTotal >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(filteredTotal)}</p>
                    </div>
                </div>
                
                {filteredTransactions.length === 0 ? (<p className="text-center text-gray-500 py-8">Nenhuma transação encontrada.</p>) : (
                    <ul className="divide-y divide-gray-200">
                        {filteredTransactions.map(t => (
                            <li key={t.id} onClick={() => onTransactionClick(t)} className="py-3 flex justify-between items-center cursor-pointer hover:bg-gray-50 px-2 rounded-md">
                                <div>
                                    <div className="flex items-center">{getTypePill(t.type)}<p className="text-sm font-medium text-gray-800">{t.description || t.category}</p></div>
                                    <p className="text-xs text-gray-500 mt-1">{t.category}{t.subcategory ? ` > ${t.subcategory}` : ''}</p>
                                </div>
                                <div className="text-right">
                                     <p className={`text-sm font-semibold ${t.type === 'entrada' ? 'text-green-600' : 'text-gray-800'}`}>{formatCurrency(t.amount)}</p>
                                     <p className="text-xs text-gray-500 mt-1">{new Date(t.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                                </div>
                            </li>
                        ))}
                    </ul>
                )}
            </div>
        </section>
    );
}

function FloatingActionButton({ onOpenModal }) {
    return (<button onClick={onOpenModal} className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-transform transform hover:scale-110" aria-label="Adicionar nova transação"><PlusIcon /></button>);
}

function TransactionModal({ onClose, userId, categories }) {
    const [transactionNature, setTransactionNature] = React.useState('pontual');
    const [type, setType] = React.useState('saida');
    const [amount, setAmount] = React.useState('');
    const [date, setDate] = React.useState(new Date().toISOString().slice(0, 10));
    const [dayOfMonth, setDayOfMonth] = React.useState('');
    const [duration, setDuration] = React.useState('');
    const [isVariable, setIsVariable] = React.useState(false);
    const [category, setCategory] = React.useState('');
    const [subcategory, setSubcategory] = React.useState('');
    const [paymentMethod, setPaymentMethod] = React.useState('');
    const [description, setDescription] = React.useState('');
    const paymentMethods = ["Cartão de Crédito", "Débito", "PIX", "Dinheiro"];
    const handleTypeChange = (newType) => { setType(newType); setCategory(''); setSubcategory(''); };
    const getTypeClasses = (currentType) => {
        const base = "flex-1 text-center p-2 rounded-md cursor-pointer transition-colors font-semibold";
        const colors = { entrada: 'bg-green-500', saida: 'bg-red-500', investimento: 'bg-blue-500' };
        return type === currentType ? `${base} ${colors[currentType]} text-white` : `${base} bg-gray-200 hover:bg-gray-300`;
    };
    const getNatureTabClasses = (nature) => transactionNature === nature ? "w-1/2 py-2 text-center font-semibold cursor-pointer text-blue-600 border-b-2 border-blue-600" : "w-1/2 py-2 text-center font-semibold cursor-pointer text-gray-500 border-b-2 border-transparent hover:bg-gray-100";
    const handleAddTransaction = async () => {
        if (!amount || !category || (type === 'saida' && !paymentMethod)) { return; }
        const transactionData = { type, amount: parseFloat(amount), category, subcategory, description, transactionNature, createdAt: serverTimestamp() };
        if(type === 'saida') transactionData.paymentMethod = paymentMethod;
        if (transactionNature === 'pontual') {
            if (!date) return;
            transactionData.date = date;
        } else {
            if (!dayOfMonth || parseInt(dayOfMonth) < 1 || parseInt(dayOfMonth) > 31) return;
            transactionData.dayOfMonth = parseInt(dayOfMonth);
            transactionData.isVariable = isVariable;
            transactionData.duration = duration ? parseInt(duration) : null;
        }
        await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`), transactionData);
        onClose();
    };
    const currentCategories = categories[type] || {};
    const currentSubcategories = currentCategories[category] || [];
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto">
                <div className="border-b"><div className="flex"><div onClick={() => setTransactionNature('pontual')} className={getNatureTabClasses('pontual')}>Pontual</div><div onClick={() => setTransactionNature('recorrente')} className={getNatureTabClasses('recorrente')}>Recorrente</div></div></div>
                <div className="p-6">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">{transactionNature === 'pontual' ? 'Nova Transação' : 'Novo Recorrente'}</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div>
                     <div className="space-y-4">
                        <div className="flex space-x-2"><div onClick={() => handleTypeChange('entrada')} className={getTypeClasses('entrada')}>Entrada</div><div onClick={() => handleTypeChange('saida')} className={getTypeClasses('saida')}>Saída</div><div onClick={() => handleTypeChange('investimento')} className={getTypeClasses('investimento')}>Investimento</div></div>
                        {transactionNature === 'pontual' ? (<div className="flex space-x-4"><div className="flex-1"><label className="block text-sm font-medium">Valor</label><input type="number" placeholder="0,00" value={amount} onChange={(e) => setAmount(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"/></div><div className="flex-1"><label className="block text-sm font-medium">Data</label><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"/></div></div>) : (<><div><label className="block text-sm font-medium">Valor Fixo / Estimativa</label><input type="number" placeholder="0,00" value={amount} onChange={(e) => setAmount(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"/></div><div className="flex items-center"><input id="isVariable" type="checkbox" checked={isVariable} onChange={(e) => setIsVariable(e.target.checked)} className="h-4 w-4 text-blue-600 border-gray-300 rounded"/><label htmlFor="isVariable" className="ml-2 block text-sm">Valor Variável</label></div><div className="flex space-x-4"><div className="flex-1"><label className="block text-sm font-medium">Dia do Lançamento</label><input type="number" placeholder="Ex: 10" min="1" max="31" value={dayOfMonth} onChange={(e) => setDayOfMonth(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"/></div><div className="flex-1"><label className="block text-sm font-medium">Duração (meses)</label><input type="number" placeholder="Em branco para sem fim" min="1" value={duration} onChange={(e) => setDuration(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"/></div></div></>)}
                        <div className="flex space-x-4"><div className="flex-1"><label className="block text-sm font-medium">Categoria</label><select value={category} onChange={(e) => { setCategory(e.target.value); setSubcategory(''); }} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-white" ><option value="" disabled>Selecione</option>{Object.keys(currentCategories).sort().map(cat => <option key={cat} value={cat}>{cat}</option>)}</select></div><div className="flex-1"><label className="block text-sm font-medium">Subcategoria</label><select value={subcategory} onChange={(e) => setSubcategory(e.target.value)} disabled={!category} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-white disabled:bg-gray-100"><option value="" disabled>Selecione</option>{currentSubcategories.sort().map(sub => <option key={sub} value={sub}>{sub}</option>)}</select></div></div>
                        {type === 'saida' && (<div><label className="block text-sm font-medium">Forma de Pagamento</label><select value={paymentMethod} onChange={(e) => setPaymentMethod(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-white"><option value="" disabled>Selecione</option>{paymentMethods.map(method => <option key={method} value={method}>{method}</option>)}</select></div>)}
                        <div><label className="block text-sm font-medium">Descrição</label><textarea placeholder="Ex: Compras do mês" value={description} onChange={(e) => setDescription(e.target.value)} rows="2" className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea></div>
                    </div>
                </div>
                <div className="bg-gray-50 px-6 py-4"><button onClick={handleAddTransaction} className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">{transactionNature === 'pontual' ? 'Adicionar Transação' : 'Adicionar Recorrente'}</button></div>
            </div>
        </div>
    );
}

function EditTransactionModal({ transaction, onClose, userId, categories }) {
    const [type, setType] = React.useState(transaction.type);
    const [amount, setAmount] = React.useState(transaction.amount);
    const [date, setDate] = React.useState(transaction.date);
    const [category, setCategory] = React.useState(transaction.category);
    const [subcategory, setSubcategory] = React.useState(transaction.subcategory);
    const [paymentMethod, setPaymentMethod] = React.useState(transaction.paymentMethod || '');
    const [description, setDescription] = React.useState(transaction.description);
    const paymentMethods = ["Cartão de Crédito", "Débito", "PIX", "Dinheiro"];
    const handleTypeChange = (newType) => { setType(newType); setCategory(''); setSubcategory(''); };
    const getTypeClasses = (currentType) => {
        const base = "flex-1 text-center p-2 rounded-md cursor-pointer transition-colors font-semibold";
        const colors = { entrada: 'bg-green-500', saida: 'bg-red-500', investimento: 'bg-blue-500' };
        return type === currentType ? `${base} ${colors[currentType]} text-white` : `${base} bg-gray-200 hover:bg-gray-300`;
    };

    const handleUpdate = async () => {
        if (!amount || !category || (type === 'saida' && !paymentMethod)) { return; }
        const updatedData = { type, amount: parseFloat(amount), date, category, subcategory, description, paymentMethod, };
        if(type !== 'saida') delete updatedData.paymentMethod;
        await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/transactions/${transaction.id}`), updatedData);
        onClose();
    };

    const handleDelete = async () => {
        await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/transactions/${transaction.id}`));
        onClose();
    };

    const currentCategories = categories[type] || {};
    const currentSubcategories = currentCategories[category] || [];

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto">
                <div className="p-6">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">Editar Transação</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div>
                    <div className="space-y-4">
                        <div className="flex space-x-2"><div onClick={() => handleTypeChange('entrada')} className={getTypeClasses('entrada')}>Entrada</div><div onClick={() => handleTypeChange('saida')} className={getTypeClasses('saida')}>Saída</div><div onClick={() => handleTypeChange('investimento')} className={getTypeClasses('investimento')}>Investimento</div></div>
                        <div className="flex space-x-4"><div className="flex-1"><label className="block text-sm font-medium">Valor</label><input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"/></div><div className="flex-1"><label className="block text-sm font-medium">Data</label><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"/></div></div>
                        <div className="flex space-x-4"><div className="flex-1"><label className="block text-sm font-medium">Categoria</label><select value={category} onChange={(e) => { setCategory(e.target.value); setSubcategory(''); }} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-white" ><option value="" disabled>Selecione</option>{Object.keys(currentCategories).sort().map(cat => <option key={cat} value={cat}>{cat}</option>)}</select></div><div className="flex-1"><label className="block text-sm font-medium">Subcategoria</label><select value={subcategory} onChange={(e) => setSubcategory(e.target.value)} disabled={!category} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-white disabled:bg-gray-100"><option value="" disabled>Selecione</option>{currentSubcategories.sort().map(sub => <option key={sub} value={sub}>{sub}</option>)}</select></div></div>
                        {type === 'saida' && (<div><label className="block text-sm font-medium">Forma de Pagamento</label><select value={paymentMethod} onChange={(e) => setPaymentMethod(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-white"><option value="" disabled>Selecione</option>{paymentMethods.map(method => <option key={method} value={method}>{method}</option>)}</select></div>)}
                        <div><label className="block text-sm font-medium">Descrição</label><textarea value={description} onChange={(e) => setDescription(e.target.value)} rows="2" className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea></div>
                    </div>
                </div>
                <div className="bg-gray-50 px-6 py-4 flex justify-between items-center">
                    <button onClick={handleDelete} className="bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700">Excluir</button>
                    <button onClick={handleUpdate} className="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Salvar Alterações</button>
                </div>
            </div>
        </div>
    );
}

function EditRecurrentModal({ transaction, onClose, userId, categories }) {
    const [type, setType] = React.useState(transaction.type);
    const [amount, setAmount] = React.useState(transaction.amount);
    const [dayOfMonth, setDayOfMonth] = React.useState(transaction.dayOfMonth);
    const [duration, setDuration] = React.useState(transaction.duration || '');
    const [isVariable, setIsVariable] = React.useState(transaction.isVariable);
    const [category, setCategory] = React.useState(transaction.category);
    const [subcategory, setSubcategory] = React.useState(transaction.subcategory);
    const [description, setDescription] = React.useState(transaction.description);

    const handleUpdate = async () => {
        if (!amount || !category || !dayOfMonth) return;
        const updatedData = {
            type,
            amount: parseFloat(amount),
            dayOfMonth: parseInt(dayOfMonth),
            duration: duration ? parseInt(duration) : null,
            isVariable,
            category,
            subcategory,
            description,
        };
        await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/transactions/${transaction.id}`), updatedData);
        onClose();
    };

    const currentCategories = categories[type] || {};
    const currentSubcategories = currentCategories[category] || [];

    return (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto">
                <div className="p-6">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">Editar Recorrente</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div>
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium">Valor Fixo / Estimativa</label><input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"/></div>
                        <div className="flex items-center"><input id="isVariableEdit" type="checkbox" checked={isVariable} onChange={(e) => setIsVariable(e.target.checked)} className="h-4 w-4 text-blue-600 border-gray-300 rounded"/><label htmlFor="isVariableEdit" className="ml-2 block text-sm">Valor Variável</label></div>
                        <div className="flex space-x-4"><div className="flex-1"><label className="block text-sm font-medium">Dia do Lançamento</label><input type="number" value={dayOfMonth} onChange={(e) => setDayOfMonth(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"/></div><div className="flex-1"><label className="block text-sm font-medium">Duração (meses)</label><input type="number" value={duration} onChange={(e) => setDuration(e.target.value)} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"/></div></div>
                        <div className="flex space-x-4"><div className="flex-1"><label className="block text-sm font-medium">Categoria</label><select value={category} onChange={(e) => { setCategory(e.target.value); setSubcategory(''); }} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-white"><option value="">Selecione</option>{Object.keys(currentCategories).sort().map(cat => <option key={cat} value={cat}>{cat}</option>)}</select></div><div className="flex-1"><label className="block text-sm font-medium">Subcategoria</label><select value={subcategory} onChange={(e) => setSubcategory(e.target.value)} disabled={!category} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-white disabled:bg-gray-100"><option value="">Selecione</option>{currentSubcategories.sort().map(sub => <option key={sub} value={sub}>{sub}</option>)}</select></div></div>
                        <div><label className="block text-sm font-medium">Descrição</label><textarea value={description} onChange={(e) => setDescription(e.target.value)} rows="2" className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea></div>
                    </div>
                </div>
                <div className="bg-gray-50 px-6 py-4 flex justify-end">
                    <button onClick={handleUpdate} className="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Salvar Alterações</button>
                </div>
            </div>
        </div>
    );
}

function DetailsModal({ title, transactions, onClose }) {
    const [sortConfig, setSortConfig] = React.useState({ key: 'date', direction: 'descending' });
    const [filterSubcategory, setFilterSubcategory] = React.useState('all');

    const uniqueSubcategories = React.useMemo(() => {
        const subs = new Set(transactions.map(t => t.subcategory).filter(Boolean));
        return ['all', ...Array.from(subs).sort()];
    }, [transactions]);
    
    const sortedAndFilteredTransactions = React.useMemo(() => {
        let processable = [...transactions];

        if (filterSubcategory !== 'all') {
            processable = processable.filter(t => t.subcategory === filterSubcategory);
        }

        processable.sort((a, b) => {
            if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'ascending' ? -1 : 1;
            if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'ascending' ? 1 : -1;
            return 0;
        });
        return processable;
    }, [transactions, sortConfig, filterSubcategory]);

    const filteredTotal = React.useMemo(() => {
        return sortedAndFilteredTransactions.reduce((acc, t) => {
            if (t.type === 'entrada') return acc + t.amount;
            if (t.type === 'saida') return acc - t.amount;
            return acc;
        }, 0);
    }, [sortedAndFilteredTransactions]);

    const requestSort = (key) => setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'ascending' ? 'descending' : 'ascending' }));
    
    const headers = [
        { key: 'date', label: 'Data' }, 
        { key: 'description', label: 'Descrição' }, 
        { key: 'category', label: 'Categoria' },
        { key: 'amount', label: 'Valor' }
    ];

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
                <div className="p-6 border-b"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold">{title}</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div></div>
                <div className="p-6 overflow-y-auto">
                    {uniqueSubcategories.length > 1 && (
                         <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 p-2 bg-gray-50 rounded-lg">
                            <div className="flex items-center gap-2">
                                <label htmlFor="subcategory-filter" className="text-sm font-medium">Filtrar por Subcategoria:</label>
                                <select id="subcategory-filter" value={filterSubcategory} onChange={e => setFilterSubcategory(e.target.value)} className="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2">
                                    {uniqueSubcategories.map(sub => <option key={sub} value={sub}>{sub === 'all' ? 'Todas' : sub}</option>)}
                                </select>
                            </div>
                            <div className="text-right">
                                <p className="text-sm text-gray-500">Total Filtrado</p>
                                <p className={`font-bold text-lg ${filteredTotal >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(filteredTotal)}</p>
                            </div>
                        </div>
                    )}
                    <table className="w-full text-left">
                        <thead>
                            <tr>
                                {headers.map(h => (
                                    <th key={h.key} className="pb-2 cursor-pointer" onClick={() => requestSort(h.key)}>
                                        <div className="flex items-center space-x-2 text-sm font-semibold text-gray-500">
                                            <span>{h.label}</span>
                                            <ArrowUpDownIcon/>
                                        </div>
                                    </th>
                                ))}
                            </tr>
                        </thead>
                         <tbody>
                            {sortedAndFilteredTransactions.map(t => (
                                <tr key={t.id} className="border-t">
                                    <td className="py-2 text-sm">{t.date ? new Date(t.date + 'T00:00:00').toLocaleDateString('pt-BR') : 'Rec.'}</td>
                                    <td className="py-2 text-sm">{t.description || t.category}</td>
                                    <td className="py-2 text-sm text-gray-600">{t.category}{t.subcategory ? ` / ${t.subcategory}` : ''}</td>
                                    <td className={`py-2 text-sm font-semibold ${t.type === 'entrada' ? 'text-green-600' : 'text-gray-800'}`}>{formatCurrency(t.amount)}</td>
                                </tr>
                            ))}
                         </tbody>
                    </table>
                     {sortedAndFilteredTransactions.length === 0 && <p className="text-center text-gray-500 py-8">Nenhuma transação encontrada.</p>}
                </div>
                <div className="bg-gray-50 px-6 py-4 flex justify-end rounded-b-xl"><button onClick={onClose} className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Fechar</button></div>
            </div>
        </div>
    );
}

function SettingsModal({ onClose, userId, currentSettings, transactions, debts, onEditRecurrent }) {
    const [localSettings, setLocalSettings] = React.useState(JSON.parse(JSON.stringify(currentSettings)));
    const [activeCategoryTab, setActiveCategoryTab] = React.useState('saida');
    const [newCategory, setNewCategory] = React.useState('');
    const [newSubcategories, setNewSubcategories] = React.useState({});
    const [importStatus, setImportStatus] = React.useState('');
    
    const recurrentTransactions = React.useMemo(() => {
        return transactions.filter(t => t.transactionNature === 'recorrente');
    }, [transactions]);

    const handleSave = async () => { await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/settings/main`), localSettings, { merge: true }); onClose(); };
    const handleBudgetChange = (category, value) => setLocalSettings(prev => ({ ...prev, budgets: { ...prev.budgets, [category]: Number(value) } }));
    const handleAddCategory = () => {
        const trimmed = newCategory.trim();
        if (!trimmed) return;
        setLocalSettings(prev => { const cats = { ...prev.categories }; if (!cats[activeCategoryTab][trimmed]) cats[activeCategoryTab][trimmed] = []; return { ...prev, categories: cats }; });
        setNewCategory('');
    };
    const handleDeleteCategory = (catToDelete) => setLocalSettings(prev => { const cats = JSON.parse(JSON.stringify(prev.categories)); delete cats[activeCategoryTab][catToDelete]; return { ...prev, categories: cats }; });
    const handleAddSubcategory = (category) => {
        const subName = newSubcategories[category]?.trim();
        if (!subName) return;
        setLocalSettings(prev => { const cats = { ...prev.categories }; if (!cats[activeCategoryTab][category].includes(subName)) cats[activeCategoryTab][category].push(subName); return { ...prev, categories: cats }; });
        setNewSubcategories(prev => ({ ...prev, [category]: '' }));
    };
    const handleDeleteSubcategory = (cat, subToDelete) => setLocalSettings(prev => { const cats = { ...prev.categories }; cats[activeCategoryTab][cat] = cats[activeCategoryTab][cat].filter(s => s !== subToDelete); return { ...prev, categories: cats }; });
    const handleDeleteRecurrent = async (id) => { await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/transactions/${id}`)); };

    const handleDownloadTemplate = () => {
        const wsData = [["date", "type", "amount", "category", "subcategory", "description", "paymentMethod"]];
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Transacoes");
        XLSX.writeFile(wb, "modelo_transacoes.xlsx");
    };

    const handleExportData = () => {
        const transactionsToExport = transactions
            .filter(t => t.transactionNature === 'pontual' || t.status === 'approved')
            .map(t => ({
                date: t.date, type: t.type, amount: t.amount, category: t.category,
                subcategory: t.subcategory || '', description: t.description || '', paymentMethod: t.paymentMethod || ''
            }));
        
        const debtsToExport = debts.map(d => ({
            description: d.description, totalValue: d.totalValue, installments: d.installments, interestRate: d.interestRate,
            firstInstallmentDate: d.firstInstallmentDate, amortizationSystem: d.amortizationSystem,
            remainingBalance: d.remainingBalance, paidInstallments: d.paidInstallments,
        }));

        const wb = XLSX.utils.book_new();
        const wsTrans = XLSX.utils.json_to_sheet(transactionsToExport);
        const wsDebts = XLSX.utils.json_to_sheet(debtsToExport);
        
        XLSX.utils.book_append_sheet(wb, wsTrans, "Transacoes");
        XLSX.utils.book_append_sheet(wb, wsDebts, "Dividas");
        
        XLSX.writeFile(wb, "dados_financeiros_backup.xlsx");
    };

    const handleImportData = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        setImportStatus('importing');
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames.find(name => name.toLowerCase() === 'transacoes');
                if (!sheetName) { setImportStatus('Planilha "Transacoes" não encontrada.'); return; }

                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                const batch = writeBatch(db);
                let importedCount = 0;
                let errors = [];

                json.forEach((row, index) => {
                    const { date, type, amount, category, subcategory, description, paymentMethod } = row;
                    if (!date || !type || !amount || !category) { errors.push(`Linha ${index + 2}: Faltam dados obrigatórios.`); return; }
                    if (typeof amount !== 'number' || amount <= 0) { errors.push(`Linha ${index + 2}: 'amount' inválido.`); return; }
                    const lowerType = String(type).toLowerCase();
                    if (!['entrada', 'saida', 'investimento'].includes(lowerType)) { errors.push(`Linha ${index + 2}: 'type' inválido.`); return; }

                    const jsDate = new Date(Math.round((date - 25569) * 86400 * 1000));
                    if (isNaN(jsDate.getTime())) { errors.push(`Linha ${index + 2}: 'date' inválida.`); return; }

                    const newTransaction = {
                        transactionNature: 'pontual', date: jsDate.toISOString().slice(0, 10), type: lowerType, amount: parseFloat(amount),
                        category, subcategory: subcategory || '', description: description || '', paymentMethod: paymentMethod || '', createdAt: serverTimestamp(),
                    };
                    const docRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`));
                    batch.set(docRef, newTransaction);
                    importedCount++;
                });

                if (importedCount > 0) {
                    await batch.commit();
                    setImportStatus(`${importedCount} transações importadas com sucesso!`);
                } else if (errors.length > 0) {
                     setImportStatus(`Importação falhou. Erro: ${errors[0]}`);
                } else {
                    setImportStatus('Nenhuma transação válida encontrada.');
                }

            } catch (error) {
                console.error("Erro ao importar:", error);
                setImportStatus('Erro ao ler o arquivo. Verifique o formato.');
            } finally {
                setTimeout(() => setImportStatus(''), 5000);
                event.target.value = null; 
            }
        };
        reader.readAsArrayBuffer(file);
    };

    const getTabClass = (tabName) => activeCategoryTab === tabName ? "px-3 py-2 font-semibold text-sm rounded-md text-white bg-blue-600" : "px-3 py-2 font-semibold text-sm rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300";
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div className="p-6 border-b"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Configurações</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div></div>
                <div className="p-6 space-y-6 overflow-y-auto">
                    <div className="p-4 border rounded-lg"><h3 className="text-lg font-semibold mb-4">Geral</h3><div className="grid md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium">Dia de Fechamento do Cartão</label><input type="number" min="1" max="31" value={localSettings.cardClosingDay} onChange={e => setLocalSettings({...localSettings, cardClosingDay: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-md p-2"/></div><div><label className="block text-sm font-medium">Meta de Economia Mensal</label><input type="number" placeholder="0,00" value={localSettings.savingsGoal} onChange={e => setLocalSettings({...localSettings, savingsGoal: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-md p-2"/></div></div></div>
                    
                    <div className="p-4 border rounded-lg">
                        <h3 className="text-lg font-semibold mb-4">Gerenciar Lançamentos Recorrentes</h3>
                        <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                            {recurrentTransactions.map(t => (
                                <div key={t.id} className="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                                    <div>
                                        <p className="font-medium">{t.description || t.category}</p>
                                        <p className="text-sm text-gray-600">{formatCurrency(t.amount)} - Dia {t.dayOfMonth}</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => onEditRecurrent(t)} className="p-1 rounded-full hover:bg-blue-100" title="Editar"><EditIcon className="h-4 w-4 text-blue-600" /></button>
                                        <button onClick={() => handleDeleteRecurrent(t.id)} className="p-1 rounded-full hover:bg-red-100" title="Excluir"><TrashIcon className="h-4 w-4 text-red-500" /></button>
                                    </div>
                                </div>
                            ))}
                             {recurrentTransactions.length === 0 && <p className="text-sm text-gray-500 text-center">Nenhum lançamento recorrente encontrado.</p>}
                        </div>
                    </div>
                    
                    <div className="p-4 border rounded-lg">
                        <h3 className="text-lg font-semibold mb-4">Gerenciar Categorias e Orçamentos</h3>
                        <div className="border-b mb-4"><nav className="flex space-x-2"><button onClick={() => setActiveCategoryTab('entrada')} className={getTabClass('entrada')}>Entradas</button><button onClick={() => setActiveCategoryTab('saida')} className={getTabClass('saida')}>Saídas</button><button onClick={() => setActiveCategoryTab('investimento')} className={getTabClass('investimento')}>Investimentos</button></nav></div>
                        <div className="pt-2">
                            <div className="flex gap-2 mb-4"><input type="text" placeholder="Nova Categoria" value={newCategory} onChange={(e) => setNewCategory(e.target.value)} className="flex-1 w-full border-gray-300 rounded-md p-2"/><button onClick={handleAddCategory} className="bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600">Adicionar</button></div>
                            <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                {Object.keys(localSettings.categories[activeCategoryTab] || {}).sort().map(cat => (
                                    <details key={cat} className="group bg-gray-50 rounded-lg">
                                        <summary className="flex justify-between items-center p-2 cursor-pointer list-none">
                                            <div className="flex items-center gap-2"><ChevronRightIcon className="group-open:rotate-90 transition-transform h-5 w-5"/><span className="font-medium">{cat}</span></div>
                                            <div className="flex items-center gap-2">
                                                {activeCategoryTab === 'saida' && (
                                                    <input
                                                        type="number"
                                                        placeholder="Orçamento"
                                                        value={localSettings.budgets[cat] || ''}
                                                        onClick={(e) => e.preventDefault()}
                                                        onChange={(e) => handleBudgetChange(cat, e.target.value)}
                                                        className="w-28 border-gray-300 rounded-md p-1 text-right text-sm"
                                                    />
                                                )}
                                                <button onClick={(e) => { e.preventDefault(); handleDeleteCategory(cat);}} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100"><TrashIcon /></button>
                                            </div>
                                        </summary>
                                        <div className="p-3 border-t bg-white">
                                            <ul className="space-y-1 mb-3">{(localSettings.categories[activeCategoryTab][cat] || []).map(sub => (<li key={sub} className="flex justify-between items-center text-sm p-1 rounded hover:bg-gray-100"><span>- {sub}</span><button onClick={() => handleDeleteSubcategory(cat, sub)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100"><TrashIcon width="14" height="14" /></button></li>))}</ul>
                                            <div className="flex gap-2 mt-3"><input type="text" placeholder="Nova Subcategoria" value={newSubcategories[cat] || ''} onChange={(e) => setNewSubcategories(prev => ({...prev, [cat]: e.target.value}))} className="flex-1 text-sm w-full border-gray-300 rounded-md p-2"/><button onClick={() => handleAddSubcategory(cat)} className="bg-gray-600 text-white font-semibold py-1 px-3 text-sm rounded-md hover:bg-gray-700">Adicionar</button></div>
                                        </div>
                                    </details>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="p-4 border rounded-lg">
                        <h3 className="text-lg font-semibold mb-4">Importar/Exportar Dados</h3>
                        <p className="text-sm text-gray-500 mb-4">Faça backup dos seus dados ou importe lançamentos de uma planilha.</p>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <button onClick={handleDownloadTemplate} className="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 text-sm">Baixar Modelo</button>
                            <button onClick={handleExportData} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 text-sm">Exportar Tudo (.xlsx)</button>
                            <div>
                                <input type="file" id="import-file" className="hidden" accept=".xlsx, .xls" onChange={handleImportData} />
                                <label htmlFor="import-file" className="w-full text-center cursor-pointer bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 text-sm block">
                                    {importStatus === 'importing' ? 'Importando...' : 'Importar Lançamentos'}
                                </label>
                            </div>
                        </div>
                        {importStatus && importStatus !== 'importing' && (
                            <p className={`mt-3 text-sm font-medium ${importStatus.includes('sucesso') ? 'text-green-600' : 'text-red-600'}`}>{importStatus}</p>
                        )}
                    </div>
                </div>
                <div className="bg-gray-50 px-6 py-4 flex justify-end gap-3 rounded-b-xl"><button onClick={onClose} className="bg-gray-200 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button><button onClick={handleSave} className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Salvar</button></div>
            </div>
        </div>
    );
}

function PendingApprovalModal({ onClose, userId, pendingTransactions, currentDate }) {
    const [editing, setEditing] = React.useState({});

    const handleApprove = async (transaction) => {
        const batch = writeBatch(db);
        const amountToApprove = editing[transaction.id] ? parseFloat(editing[transaction.id]) : transaction.amount;
        
        // 1. Cria nova transação PONTUAL (aprovada)
        const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), transaction.dayOfMonth);
        const newTransactionData = { ...transaction, amount: amountToApprove, transactionNature: 'pontual', date: date.toISOString().slice(0, 10), createdAt: serverTimestamp(), originalRecurrentId: transaction.id, status: 'approved' };
        delete newTransactionData.id; delete newTransactionData.approvedMonths;
        const newTransactionRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`));
        batch.set(newTransactionRef, newTransactionData);

        // 2. Atualiza a transação RECORRENTE original
        const currentMonthStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        const updatedApprovedMonths = [...(transaction.approvedMonths || []), currentMonthStr];
        const recurrentDocRef = doc(db, `/artifacts/${appId}/users/${userId}/transactions/${transaction.id}`);
        batch.update(recurrentDocRef, { approvedMonths: updatedApprovedMonths });

        // 3. Atualiza a DÍVIDA relacionada, se houver
        if (transaction.relatedDebtId) {
            const debtDocRef = doc(db, `/artifacts/${appId}/users/${userId}/debts/${transaction.relatedDebtId}`);
            const debtDoc = await getDoc(debtDocRef);
            if (debtDoc.exists()) {
                const debt = debtDoc.data();
                const monthlyI = (debt.interestRate / 100) / 12;
                const interestPayment = debt.remainingBalance * monthlyI;
                const principalPayment = amountToApprove - interestPayment;
                const newRemainingBalance = debt.remainingBalance - principalPayment;
                const newTotalPaid = debt.totalPaid + amountToApprove;
                const newPaidInstallments = debt.paidInstallments + 1;
                batch.update(debtDocRef, { remainingBalance: newRemainingBalance, totalPaid: newTotalPaid, paidInstallments: newPaidInstallments, });
            }
        }
        await batch.commit();
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col">
                <div className="p-6 border-b"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Pendentes de Aprovação</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div></div>
                <div className="p-6 overflow-y-auto space-y-3">
                    {pendingTransactions.length === 0 ? (<p className="text-center text-gray-500 py-8">Nenhuma transação pendente para este mês.</p>) : (
                        pendingTransactions.map(t => (
                            <div key={t.id} className="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                                <div>
                                    <p className="font-semibold">{t.description || t.category}</p>
                                    <div className="flex items-center gap-2 mt-1">
                                        {t.isVariable ? (
                                            <input 
                                                type="number" 
                                                value={editing[t.id] ?? t.amount}
                                                onChange={(e) => setEditing(prev => ({...prev, [t.id]: e.target.value}))}
                                                className="w-28 border-gray-300 rounded-md p-1 text-sm"
                                            />
                                        ) : (
                                            <p className="text-sm text-gray-600">{formatCurrency(t.amount)}</p>
                                        )}
                                        <p className="text-sm text-gray-600">- Dia {t.dayOfMonth}</p>
                                    </div>
                                </div>
                                <button onClick={() => handleApprove(t)} className="flex items-center gap-2 bg-green-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-600 text-sm"><CheckIcon />Aprovar</button>
                            </div>
                        ))
                    )}
                </div>
                <div className="bg-gray-50 px-6 py-4 flex justify-end rounded-b-xl"><button onClick={onClose} className="bg-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Fechar</button></div>
            </div>
        </div>
    );
}

function DebtsModal({ onClose, userId, debts }) {
    const [description, setDescription] = React.useState('');
    const [totalValue, setTotalValue] = React.useState('');
    const [installments, setInstallments] = React.useState('');
    const [interestRate, setInterestRate] = React.useState('');
    const [firstInstallmentDate, setFirstInstallmentDate] = React.useState('');
    const [amortizationSystem, setAmortizationSystem] = React.useState('price');
    const [advancePayment, setAdvancePayment] = React.useState({});
    const [advanceOptions, setAdvanceOptions] = React.useState({});

    const handleAddDebt = async () => {
        const n = Number(installments); const pv = Number(totalValue); const annualI = Number(interestRate);
        if (!description || n <= 0 || pv <= 0 || annualI < 0 || !firstInstallmentDate) return;

        const monthlyI = (annualI / 100) / 12; let pmt = 0; let isVariable = false;
        if (amortizationSystem === 'price') { pmt = monthlyI > 0 ? pv * (monthlyI * Math.pow(1 + monthlyI, n)) / (Math.pow(1 + monthlyI, n) - 1) : pv / n; } 
        else { const amortization = pv / n; pmt = amortization + (pv * monthlyI); isVariable = true; }
        
        let totalWithInterest = pmt * n;
        if (amortizationSystem === 'sac') { let balance = pv; let totalInterestPaid = 0; for (let i = 0; i < n; i++) { totalInterestPaid += balance * monthlyI; balance -= (pv/n); } totalWithInterest = pv + totalInterestPaid; }

        const debtData = { description, totalValue: pv, installments: n, interestRate: annualI, firstInstallmentDate, monthlyPayment: pmt, remainingBalance: pv, amortizationSystem, totalWithInterest, paidInstallments: 0, totalPaid: 0, createdAt: serverTimestamp() };
        const transactionData = { type: 'saida', amount: pmt, category: 'Dívidas', description: `Parcela ${description}`, transactionNature: 'recorrente', dayOfMonth: new Date(firstInstallmentDate + 'T00:00:00').getUTCDate(), duration: n, isVariable, createdAt: serverTimestamp() };

        const batch = writeBatch(db); const debtDocRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/debts`)); batch.set(debtDocRef, debtData);
        const transactionDocRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`)); batch.set(transactionDocRef, { ...transactionData, relatedDebtId: debtDocRef.id });
        await batch.commit();
        setDescription(''); setTotalValue(''); setInstallments(''); setInterestRate(''); setFirstInstallmentDate('');
    };
    
    const handleAdvancePayment = async (debtId) => {
        const amount = Number(advancePayment[debtId]); const choice = advanceOptions[debtId]; if (!amount || amount <= 0 || !choice) return;
        
        const debtRef = doc(db, `/artifacts/${appId}/users/${userId}/debts/${debtId}`); const debtDoc = await getDoc(debtRef); if(!debtDoc.exists()) return;

        const debt = debtDoc.data();
        const newRemainingBalance = debt.remainingBalance - amount;
        const newTotalPaid = debt.totalPaid + amount;
        let updatedDebtData = { remainingBalance: newRemainingBalance, totalPaid: newTotalPaid };

        const monthlyI = (debt.interestRate / 100) / 12;
        const remainingInstallments = debt.installments - debt.paidInstallments;

        if (choice === 'reduce_term') {
            const pmt = debt.monthlyPayment;
            const newN = -Math.log(1 - (newRemainingBalance * monthlyI / pmt)) / Math.log(1 + monthlyI);
            updatedDebtData.installments = debt.paidInstallments + Math.ceil(newN);
        } else if (choice === 'reduce_payment') {
            const n = remainingInstallments;
            const newPmt = newRemainingBalance * (monthlyI * Math.pow(1 + monthlyI, n)) / (Math.pow(1 + monthlyI, n) - 1);
            updatedDebtData.monthlyPayment = newPmt;
        }

        const batch = writeBatch(db);
        batch.update(debtRef, updatedDebtData);
        const advanceTransaction = { type: 'saida', amount, category: 'Dívidas', subcategory: 'Amortização Extra', description: `Pagamento adiantado: ${debt.description}`, transactionNature: 'pontual', date: new Date().toISOString().slice(0, 10), createdAt: serverTimestamp() };
        const newTransactionRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/transactions`));
        batch.set(newTransactionRef, advanceTransaction);

        await batch.commit();
        setAdvancePayment(prev => ({...prev, [debtId]: ''}));
        setAdvanceOptions(prev => ({...prev, [debtId]: ''}));
    };

    const handleDeleteDebt = async (debt) => {
        const batch = writeBatch(db);
        batch.delete(doc(db, `/artifacts/${appId}/users/${userId}/debts/${debt.id}`));
        const q = query(collection(db, `/artifacts/${appId}/users/${userId}/transactions`), where("relatedDebtId", "==", debt.id));
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach((doc) => batch.delete(doc.ref));
        await batch.commit();
    }
    
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div className="p-6 border-b"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Gerenciar Dívidas</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div></div>
                <div className="flex-1 p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="bg-gray-50 p-6 rounded-lg">
                        <h3 className="text-xl font-semibold mb-4">Nova Dívida</h3>
                        <div className="space-y-4">
                            <div><label className="text-sm font-medium">Descrição</label><input type="text" value={description} onChange={e => setDescription(e.target.value)} placeholder="Ex: Financiamento Veículo" className="mt-1 w-full border-gray-300 rounded-md p-2" /></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-sm font-medium">Valor Financiado</label><input type="number" value={totalValue} onChange={e => setTotalValue(e.target.value)} placeholder="20000,00" className="mt-1 w-full border-gray-300 rounded-md p-2" /></div>
                                <div><label className="text-sm font-medium">Nº de Parcelas</label><input type="number" value={installments} onChange={e => setInstallments(e.target.value)} placeholder="48" className="mt-1 w-full border-gray-300 rounded-md p-2" /></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-sm font-medium">Juros (% a.a.)</label><input type="number" value={interestRate} onChange={e => setInterestRate(e.target.value)} placeholder="18.5" className="mt-1 w-full border-gray-300 rounded-md p-2" /></div>
                                <div><label className="text-sm font-medium">Data da 1ª Parcela</label><input type="date" value={firstInstallmentDate} onChange={e => setFirstInstallmentDate(e.target.value)} className="mt-1 w-full border-gray-300 rounded-md p-2" /></div>
                            </div>
                             <div><label className="text-sm font-medium">Sistema de Amortização</label><select value={amortizationSystem} onChange={e => setAmortizationSystem(e.target.value)} className="mt-1 w-full border-gray-300 rounded-md p-2 bg-white"><option value="price">Tabela Price (Parcelas Fixas)</option><option value="sac">Tabela SAC (Parcelas Decrescentes)</option></select></div>
                             <button onClick={handleAddDebt} className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Adicionar Dívida</button>
                        </div>
                    </div>
                    <div>
                        <h3 className="text-xl font-semibold mb-4">Suas Dívidas</h3>
                        <div className="space-y-3">
                            {debts.length === 0 ? <p className="text-gray-500 text-center py-8">Nenhuma dívida cadastrada.</p> :
                            debts.map(debt => (
                                <details key={debt.id} className="bg-gray-50 p-4 rounded-lg group">
                                    <summary className="flex justify-between items-center cursor-pointer list-none">
                                        <div><p className="font-semibold">{debt.description}</p><p className="text-sm text-gray-500">Saldo Devedor: <span className="font-bold text-red-600">{formatCurrency(debt.remainingBalance)}</span></p></div>
                                        <div className="flex items-center gap-2">
                                             <button onClick={(e) => { e.preventDefault(); handleDeleteDebt(debt);}} className="p-1 rounded-full hover:bg-red-100"><TrashIcon className="text-red-500 h-4 w-4"/></button>
                                             <ChevronRightIcon className="group-open:rotate-90 transition-transform h-5 w-5"/>
                                        </div>
                                    </summary>
                                    <div className="mt-4 pt-4 border-t">
                                        <div className="text-sm text-gray-700 space-y-1 mb-4">
                                            <div className="flex justify-between"><span>Valor Original:</span><span className="font-medium">{formatCurrency(debt.totalValue)}</span></div>
                                            <div className="flex justify-between"><span>Custo Efetivo Total (CET):</span><span className="font-medium">{formatCurrency(debt.totalWithInterest)}</span></div>
                                            <div className="flex justify-between"><span>Próxima Parcela (Est.):</span><span className="font-medium">{formatCurrency(debt.monthlyPayment)}</span></div>
                                            <div className="flex justify-between"><span>Total já Pago:</span><span className="font-medium text-green-600">{formatCurrency(debt.totalPaid)}</span></div>
                                            <div className="flex justify-between"><span>Parcelas Pagas:</span><span className="font-medium">{debt.paidInstallments} de {debt.installments}</span></div>
                                        </div>
                                        <div className="bg-white p-3 rounded-md border">
                                            <h4 className="text-sm font-semibold mb-2">Amortização Extra</h4>
                                            <div className="flex gap-2 mb-2"><input type="number" value={advancePayment[debt.id] || ''} onChange={e => setAdvancePayment(prev => ({...prev, [debt.id]: e.target.value}))} placeholder="Valor para adiantar" className="flex-1 text-sm w-full border-gray-300 rounded-md p-2"/></div>
                                            <div className="flex gap-4 text-sm mb-3">
                                                <label className="flex items-center"><input type="radio" name={`advance_option_${debt.id}`} value="reduce_term" checked={advanceOptions[debt.id] === 'reduce_term'} onChange={(e) => setAdvanceOptions(prev => ({...prev, [debt.id]: e.target.value}))} className="mr-1"/>Reduzir prazo</label>
                                                <label className="flex items-center"><input type="radio" name={`advance_option_${debt.id}`} value="reduce_payment" checked={advanceOptions[debt.id] === 'reduce_payment'} onChange={(e) => setAdvanceOptions(prev => ({...prev, [debt.id]: e.target.value}))} className="mr-1"/>Reduzir parcela</label>
                                            </div>
                                            <button onClick={() => handleAdvancePayment(debt.id)} className="w-full bg-green-500 text-white font-semibold py-2 px-3 text-sm rounded-md hover:bg-green-600" disabled={!advanceOptions[debt.id]}>Pagar Adiantado</button>
                                        </div>
                                    </div>
                                </details>
                            ))}
                        </div>
                    </div>
                </div>
                <div className="bg-gray-50 px-6 py-4 flex justify-end rounded-b-xl"><button onClick={onClose} className="bg-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Fechar</button></div>
            </div>
        </div>
    );
}

function FutureForecastModal({ onClose, transactions, debts, currentBalance }) {
    const forecastData = React.useMemo(() => {
        const historicalMonths = 6;
        const today = new Date();
        const pastDate = new Date();
        pastDate.setMonth(today.getMonth() - historicalMonths);

        // Calcula a média de transações PONTUAIS (variáveis) do passado
        const historicalTransactions = transactions.filter(t => 
            t.transactionNature === 'pontual' && 
            new Date(t.date + 'T00:00:00') >= pastDate && 
            new Date(t.date + 'T00:00:00') < today
        );
        
        const monthlyTotals = {};
        historicalTransactions.forEach(t => {
            const monthKey = t.date.substring(0, 7);
            if (!monthlyTotals[monthKey]) {
                monthlyTotals[monthKey] = { income: 0, expenses: 0, investment: 0 };
            }
            if (t.type === 'entrada') monthlyTotals[monthKey].income += t.amount;
            else if (t.type === 'saida') monthlyTotals[monthKey].expenses += t.amount;
            else if (t.type === 'investimento') monthlyTotals[monthKey].investment += t.amount;
        });

        const numMonths = Object.keys(monthlyTotals).length || 1;
        const avgIncome = Object.values(monthlyTotals).reduce((sum, data) => sum + data.income, 0) / numMonths;
        const avgVariableExpenses = Object.values(monthlyTotals).reduce((sum, data) => sum + data.expenses, 0) / numMonths;
        const avgInvestment = Object.values(monthlyTotals).reduce((sum, data) => sum + data.investment, 0) / numMonths;

        // Lógica de projeção
        const projection = [];
        let lastBalance = currentBalance;
        let projectedDebts = JSON.parse(JSON.stringify(debts));

        for (let i = 0; i < 12; i++) {
            const futureDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
            
            let monthIncome = avgIncome;
            let monthExpenses = avgVariableExpenses;
            let monthInvestment = avgInvestment;

            // Adiciona transações recorrentes (não-dívidas)
            transactions.forEach(t => {
                if (t.transactionNature !== 'recorrente' || t.relatedDebtId) return;
                if (t.duration) {
                    const createdAtDate = t.createdAt?.toDate();
                    if (createdAtDate) {
                        const endDate = new Date(createdAtDate);
                        endDate.setMonth(endDate.getMonth() + t.duration);
                        if (futureDate > endDate) return;
                    }
                }
                if (t.type === 'saida') monthExpenses += t.amount;
                if (t.type === 'entrada') monthIncome += t.amount;
                if (t.type === 'investimento') monthInvestment += t.amount;
            });
            
            // Adiciona pagamentos de dívidas e simula a amortização
            projectedDebts.forEach(debt => {
                if (debt.paidInstallments < debt.installments) {
                    let payment = 0;
                    let principalPayment = 0;
                    const monthlyI = (debt.interestRate / 100) / 12;

                    if (debt.amortizationSystem === 'price') {
                        payment = debt.monthlyPayment;
                        const interestPayment = debt.remainingBalance * monthlyI;
                        principalPayment = payment - interestPayment;
                    } else { // SAC
                        const interestPayment = debt.remainingBalance * monthlyI;
                        principalPayment = debt.totalValue / debt.installments;
                        payment = interestPayment + principalPayment;
                    }
                    monthExpenses += payment;
                    debt.remainingBalance -= principalPayment;
                    debt.paidInstallments += 1;
                }
            });

            const monthBalanceChange = monthIncome - monthExpenses;
            lastBalance += monthBalanceChange;

            projection.push({ month: futureDate.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }), income: monthIncome, expenses: monthExpenses, balance: lastBalance });
        }
        
        const projectedTotalIncome = projection.reduce((sum, p) => sum + p.income, 0);
        const projectedTotalExpenses = projection.reduce((sum, p) => sum + p.expenses, 0);
        const avgProjectedIncome = projectedTotalIncome / 12;
        const avgProjectedExpenses = projectedTotalExpenses / 12;
        const avgProjectedBalance = avgProjectedIncome - avgProjectedExpenses - avgInvestment;

        return {
            averages: { income: avgProjectedIncome, expenses: avgProjectedExpenses, investment: avgInvestment, balance: avgProjectedBalance },
            projection,
        };
    }, [transactions, debts, currentBalance]);

    const handleExport = () => {
        if (typeof XLSX === 'undefined') { console.error("A biblioteca XLSX não está carregada."); return; }
        const wsData = [ ["Mês", "Receita Projetada", "Despesa Projetada", "Saldo Final Projetado"], ...forecastData.projection.map(p => [ p.month, p.income, p.expenses, p.balance ]) ];
        const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "PrevisaoFinanceira"); XLSX.writeFile(wb, "previsao_financeira.xlsx");
    };

    const LineChart = ({ data }) => {
        if (!data || data.length === 0) return <div className="text-center text-gray-500 p-8">Sem dados para exibir o gráfico.</div>;
        const width = 500, height = 250, padding = 40;
        const maxVal = Math.max(...data.flatMap(d => [d.income, d.expenses, d.balance]));
        const minVal = Math.min(...data.flatMap(d => [d.income, d.expenses, d.balance, 0]));
        
        const getX = (i) => padding + (i * (width - padding * 2) / (data.length - 1));
        
        const getY = (v) => {
            const range = maxVal - minVal;
            if (range === 0) {
                return height / 2;
            }
            return height - padding - (((v - minVal) / range) * (height - padding * 2));
        };

        const createPath = (key) => data.map((d, i) => `${i === 0 ? 'M' : 'L'} ${getX(i)} ${getY(d[key])}`).join(' ');

        return (
            <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto">
                <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#9ca3af" />
                <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#9ca3af" />
                {[...Array(5)].map((_, i) => { 
                    const range = maxVal - minVal;
                    const value = range === 0 ? maxVal : minVal + (i * range / 4);
                    return <text key={i} x={padding - 5} y={getY(value)} dy="0.3em" textAnchor="end" className="text-xs fill-current text-gray-500">{formatCurrency(value)}</text> 
                })}
                {data.map((d, i) => <text key={d.month} x={getX(i)} y={height - padding + 15} textAnchor="middle" className="text-xs fill-current text-gray-500">{d.month}</text>)}
                <path d={createPath('income')} fill="none" stroke="#10b981" strokeWidth="2" />
                <path d={createPath('expenses')} fill="none" stroke="#ef4444" strokeWidth="2" />
                <path d={createPath('balance')} fill="none" stroke="#3b82f6" strokeWidth="3" />
                <g transform={`translate(${padding}, ${padding - 25})`} className="text-xs text-gray-600 font-medium">
                    <rect x="0" y="0" width="10" height="10" fill="#10b981" /><text x="15" y="9">Receita</text>
                    <rect x="70" y="0" width="10" height="10" fill="#ef4444" /><text x="85" y="9">Despesa</text>
                    <rect x="150" y="0" width="10" height="10" fill="#3b82f6" /><text x="165" y="9">Saldo</text>
                </g>
            </svg>
        );
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div className="p-6 border-b"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Previsão Futura</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div></div>
                <div className="p-6 overflow-y-auto">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
                        <div><p className="text-sm text-gray-500">Renda Média Mensal</p><p className="font-bold text-lg text-green-600">{formatCurrency(forecastData.averages.income)}</p></div>
                        <div><p className="text-sm text-gray-500">Despesa Média Mensal</p><p className="font-bold text-lg text-red-600">{formatCurrency(forecastData.averages.expenses)}</p></div>
                        <div><p className="text-sm text-gray-500">Invest. Médio Mensal</p><p className="font-bold text-lg text-blue-600">{formatCurrency(forecastData.averages.investment)}</p></div>
                        <div><p className="text-sm text-gray-500">Saldo Médio Mensal</p><p className={`font-bold text-lg ${forecastData.averages.balance >= 0 ? 'text-gray-800' : 'text-red-600'}`}>{formatCurrency(forecastData.averages.balance)}</p></div>
                    </div>
                    <div className="bg-gray-50 p-4 rounded-lg">
                        <h3 className="font-semibold mb-2 text-center">Projeção de Saldo para os Próximos 12 Meses</h3>
                        <LineChart data={forecastData.projection} />
                    </div>
                </div>
                <div className="bg-gray-50 px-6 py-4 flex justify-between items-center rounded-b-xl">
                    <button onClick={handleExport} className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Exportar (.xlsx)</button>
                    <button onClick={onClose} className="bg-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Fechar</button>
                </div>
            </div>
        </div>
    );
}



